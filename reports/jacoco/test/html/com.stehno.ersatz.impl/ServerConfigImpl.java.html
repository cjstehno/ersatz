<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="en"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../jacoco-resources/report.css" type="text/css"/><link rel="shortcut icon" href="../jacoco-resources/report.gif" type="image/gif"/><title>ServerConfigImpl.java</title><link rel="stylesheet" href="../jacoco-resources/prettify.css" type="text/css"/><script type="text/javascript" src="../jacoco-resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../jacoco-sessions.html" class="el_session">Sessions</a></span><a href="../index.html" class="el_report">ersatz</a> &gt; <a href="index.source.html" class="el_package">com.stehno.ersatz.impl</a> &gt; <span class="el_source">ServerConfigImpl.java</span></div><h1>ServerConfigImpl.java</h1><pre class="source lang-java linenums">/**
 * Copyright (C) 2019 Christopher J. Stehno
 *
 * Licensed under the Apache License, Version 2.0 (the &quot;License&quot;);
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *         http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an &quot;AS IS&quot; BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */
package com.stehno.ersatz.impl;

import com.stehno.ersatz.cfg.AuthenticationConfig;
import com.stehno.ersatz.cfg.ContentType;
import com.stehno.ersatz.cfg.Expectations;
import com.stehno.ersatz.cfg.ServerConfig;
import com.stehno.ersatz.encdec.DecodingContext;
import com.stehno.ersatz.encdec.RequestDecoders;
import com.stehno.ersatz.encdec.ResponseEncoders;
import groovy.lang.Closure;
import groovy.lang.DelegatesTo;
import space.jasan.support.groovy.closure.ConsumerWithDelegate;

import java.net.URL;
import java.util.concurrent.TimeUnit;
import java.util.function.BiFunction;
import java.util.function.Consumer;
import java.util.function.Function;

import static groovy.lang.Closure.DELEGATE_FIRST;
import static java.util.concurrent.TimeUnit.MILLISECONDS;
import static java.util.concurrent.TimeUnit.SECONDS;

@SuppressWarnings({&quot;PMD.AvoidFieldNameMatchingMethodName&quot;, &quot;PMD.BeanMembersShouldSerialize&quot;})
public class ServerConfigImpl implements ServerConfig {

    private static final int EPHEMERAL_PORT = 0;
    private boolean httpsEnabled;
<span class="fc" id="L44">    private boolean autoStartEnabled = true;</span>
    private boolean mismatchToConsole;
    private URL keystoreLocation;
<span class="fc" id="L47">    private String keystorePass = &quot;ersatz&quot;;</span>
    private AuthenticationConfigImpl authenticationConfig;
<span class="fc" id="L49">    private int desiredHttpPort = EPHEMERAL_PORT;</span>
<span class="fc" id="L50">    private int desiredHttpsPort = EPHEMERAL_PORT;</span>
<span class="fc" id="L51">    private final RequestDecoders globalDecoders = new RequestDecoders();</span>
<span class="fc" id="L52">    private final ResponseEncoders globalEncoders = new ResponseEncoders();</span>
<span class="fc" id="L53">    private final ExpectationsImpl expectations = new ExpectationsImpl(globalDecoders, globalEncoders);</span>
    private final Runnable starter;
    private long timeout;

<span class="fc" id="L57">    public ServerConfigImpl(final Runnable starter) {</span>
<span class="fc" id="L58">        this.starter = starter;</span>
<span class="fc" id="L59">    }</span>

    /**
     * Used to control the enabled/disabled state of HTTPS on the server. By default HTTPS is disabled.
     *
     * @param enabled optional toggle value (true if not specified)
     * @return a reference to the server being configured
     */
    @Override public ServerConfig https(boolean enabled) {
<span class="fc" id="L68">        httpsEnabled = enabled;</span>
<span class="fc" id="L69">        return this;</span>
    }

    @Override public ServerConfig https() {
<span class="fc" id="L73">        return https(true);</span>
    }

    public boolean isHttpsEnabled() {
<span class="fc" id="L77">        return httpsEnabled;</span>
    }

    public boolean isAutoStartEnabled() {
<span class="fc" id="L81">        return autoStartEnabled;</span>
    }

    public boolean isMismatchToConsole() {
<span class="fc" id="L85">        return mismatchToConsole;</span>
    }

    public URL getKeystoreLocation() {
<span class="fc" id="L89">        return keystoreLocation;</span>
    }

    public String getKeystorePass() {
<span class="fc" id="L93">        return keystorePass;</span>
    }

    public AuthenticationConfigImpl getAuthenticationConfig() {
<span class="fc" id="L97">        return authenticationConfig;</span>
    }

    public int getDesiredHttpPort() {
<span class="fc" id="L101">        return desiredHttpPort;</span>
    }

    public int getDesiredHttpsPort() {
<span class="fc" id="L105">        return desiredHttpsPort;</span>
    }

    public ExpectationsImpl getExpectations() {
<span class="fc" id="L109">        return expectations;</span>
    }

    public long getTimeout() {
<span class="fc" id="L113">        return timeout;</span>
    }

    public void clearExpectations() {
<span class="fc" id="L117">        expectations.clear();</span>
<span class="fc" id="L118">    }</span>

    /**
     * Used to enable/disable the auto-start feature, which will start the server after any call to either of the &lt;code&gt;expectations&lt;/code&gt;
     * configuration methods. With this setting enabled, any other calls to the &lt;code&gt;start()&lt;/code&gt; method are ignored. Further configuration is
     * allowed.
     * &lt;p&gt;
     * Auto-start is enabled by default.
     *
     * @param autoStart whether or not auto-start is enabled
     * @return a reference to the server being configured
     */
    @Override public ServerConfig autoStart(boolean autoStart) {
<span class="fc" id="L131">        autoStartEnabled = autoStart;</span>
<span class="fc" id="L132">        return this;</span>
    }

    /**
     * Used to specify the server request timeout property value on the server. If not specified, &lt;code&gt;SECONDS&lt;/code&gt; will be used as the units.
     * &lt;p&gt;
     * The IDLE_TIMEOUT, NO_REQUEST_TIMEOUT, REQUEST_PARSE_TIMEOUT, READ_TIMEOUT and WRITE_TIMEOUT are all configured to the same specified
     * value.
     *
     * @param value the timeout value
     * @param units the units the timeout is specified with (or &lt;code&gt;SECONDS&lt;/code&gt;)
     * @return a reference to the server being configured
     */
    @Override public ServerConfig timeout(final int value, final TimeUnit units) {
<span class="fc" id="L146">        this.timeout = MILLISECONDS.convert(value, units);</span>
<span class="fc" id="L147">        return this;</span>
    }

    @Override public ServerConfig timeout(final int value) {
<span class="nc" id="L151">        return timeout(value, SECONDS);</span>
    }

    /**
     * Used to toggle the console output of mismatched request reports. By default they are only rendered in the logging. A value of &lt;code&gt;true&lt;/code&gt;
     * will cause the report to be output on the console as well.
     *
     * @param toConsole whether or not the report should also be written to the console
     * @return a reference to the server being configured
     */
    @Override
    public ServerConfig reportToConsole(boolean toConsole) {
<span class="nc" id="L163">        mismatchToConsole = toConsole;</span>
<span class="nc" id="L164">        return this;</span>
    }

    @Override public ServerConfig reportToConsole() {
<span class="nc" id="L168">        return reportToConsole(true);</span>
    }

    /**
     * Allows configuration of an external HTTPS keystore with the given location and password. By default, if this is not specified an internally
     * provided keystore will be used for HTTPS certification. See the User Guide for details about configuring your own keystore.
     *
     * @param location the URL of the keystore file
     * @param password the keystore file password (defaults to &quot;ersatz&quot; if omitted)
     * @return a reference to the server being configured
     */
    @Override public ServerConfig keystore(final URL location, final String password) {
<span class="nc" id="L180">        keystoreLocation = location;</span>
<span class="nc" id="L181">        keystorePass = password;</span>
<span class="nc" id="L182">        return this;</span>
    }

    @Override public ServerConfig keystore(final URL location) {
<span class="nc" id="L186">        return keystore(location, &quot;ersatz&quot;);</span>
    }

    @Override public ServerConfig expectations(final Consumer&lt;Expectations&gt; expects) {
<span class="fc" id="L190">        expects.accept(expectations);</span>

<span class="pc bpc" id="L192" title="1 of 2 branches missed.">        if( autoStartEnabled ){</span>
<span class="fc" id="L193">            starter.run();</span>
        }

<span class="fc" id="L196">        return this;</span>
    }

    @Override public Expectations expects() {
<span class="fc" id="L200">        return expectations;</span>
    }

    @Override
    public ServerConfig decoder(String contentType, BiFunction&lt;byte[], DecodingContext, Object&gt; decoder) {
<span class="nc" id="L205">        globalDecoders.register(contentType, decoder);</span>
<span class="nc" id="L206">        return this;</span>
    }

    @Override
    public ServerConfig decoder(ContentType contentType, BiFunction&lt;byte[], DecodingContext, Object&gt; decoder) {
<span class="nc" id="L211">        return decoder(contentType.getValue(), decoder);</span>
    }

    @Override public ServerConfig encoder(String contentType, Class objectType, Function&lt;Object, byte[]&gt; encoder) {
<span class="fc" id="L215">        globalEncoders.register(contentType, objectType, encoder);</span>
<span class="fc" id="L216">        return this;</span>
    }

    /**
     * Registers authentication configuration as a Groovy Closure.
     *
     * @param closure the configuration closure
     * @return a reference to this server configuration
     */
    @Override
    public ServerConfig authentication(@DelegatesTo(value = AuthenticationConfig.class, strategy = DELEGATE_FIRST) final Closure closure) {
<span class="fc" id="L227">        return authentication(ConsumerWithDelegate.create(closure));</span>
    }

    /**
     * Registers authentication configuration as a &lt;code&gt;Consumer&amp;lt;AuthenticationConfig&amp;gt;&lt;/code&gt;.
     *
     * @param config the configuration Consumer
     * @return a reference to this server configuration
     */
    @Override
    public ServerConfig authentication(final Consumer&lt;AuthenticationConfig&gt; config) {
<span class="fc" id="L238">        authenticationConfig = new AuthenticationConfigImpl();</span>
<span class="fc" id="L239">        config.accept(authenticationConfig);</span>
<span class="fc" id="L240">        return this;</span>
    }

    @Override
    public ServerConfig httpPort(int serverPort) {
<span class="fc" id="L245">        desiredHttpPort = serverPort;</span>
<span class="fc" id="L246">        return this;</span>
    }

    @Override
    public ServerConfig httpsPort(int serverPort) {
<span class="nc" id="L251">        desiredHttpsPort = serverPort;</span>
<span class="nc" id="L252">        return this;</span>
    }
}
</pre><div class="footer"><span class="right">Created with <a href="http://www.jacoco.org/jacoco">JaCoCo</a> 0.8.4.201905082037</span></div></body></html>