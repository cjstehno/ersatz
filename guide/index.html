<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8">
<!--[if IE]><meta http-equiv="X-UA-Compatible" content="IE=edge"><![endif]-->
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<meta name="generator" content="Asciidoctor 1.5.8">
<meta name="author" content="Christopher J. Stehno">
<title>Ersatz Server User Guide</title>
<link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Open+Sans:300,300italic,400,400italic,600,600italic%7CNoto+Serif:400,400italic,700,700italic%7CDroid+Sans+Mono:400,700">
<style>
/* Asciidoctor default stylesheet | MIT License | http://asciidoctor.org */
/* Uncomment @import statement below to use as custom stylesheet */
/*@import "https://fonts.googleapis.com/css?family=Open+Sans:300,300italic,400,400italic,600,600italic%7CNoto+Serif:400,400italic,700,700italic%7CDroid+Sans+Mono:400,700";*/
article,aside,details,figcaption,figure,footer,header,hgroup,main,nav,section,summary{display:block}
audio,canvas,video{display:inline-block}
audio:not([controls]){display:none;height:0}
script{display:none!important}
html{font-family:sans-serif;-ms-text-size-adjust:100%;-webkit-text-size-adjust:100%}
a{background:transparent}
a:focus{outline:thin dotted}
a:active,a:hover{outline:0}
h1{font-size:2em;margin:.67em 0}
abbr[title]{border-bottom:1px dotted}
b,strong{font-weight:bold}
dfn{font-style:italic}
hr{-moz-box-sizing:content-box;box-sizing:content-box;height:0}
mark{background:#ff0;color:#000}
code,kbd,pre,samp{font-family:monospace;font-size:1em}
pre{white-space:pre-wrap}
q{quotes:"\201C" "\201D" "\2018" "\2019"}
small{font-size:80%}
sub,sup{font-size:75%;line-height:0;position:relative;vertical-align:baseline}
sup{top:-.5em}
sub{bottom:-.25em}
img{border:0}
svg:not(:root){overflow:hidden}
figure{margin:0}
fieldset{border:1px solid silver;margin:0 2px;padding:.35em .625em .75em}
legend{border:0;padding:0}
button,input,select,textarea{font-family:inherit;font-size:100%;margin:0}
button,input{line-height:normal}
button,select{text-transform:none}
button,html input[type="button"],input[type="reset"],input[type="submit"]{-webkit-appearance:button;cursor:pointer}
button[disabled],html input[disabled]{cursor:default}
input[type="checkbox"],input[type="radio"]{box-sizing:border-box;padding:0}
button::-moz-focus-inner,input::-moz-focus-inner{border:0;padding:0}
textarea{overflow:auto;vertical-align:top}
table{border-collapse:collapse;border-spacing:0}
*,*::before,*::after{-moz-box-sizing:border-box;-webkit-box-sizing:border-box;box-sizing:border-box}
html,body{font-size:100%}
body{background:#fff;color:rgba(0,0,0,.8);padding:0;margin:0;font-family:"Noto Serif","DejaVu Serif",serif;font-weight:400;font-style:normal;line-height:1;position:relative;cursor:auto;tab-size:4;-moz-osx-font-smoothing:grayscale;-webkit-font-smoothing:antialiased}
a:hover{cursor:pointer}
img,object,embed{max-width:100%;height:auto}
object,embed{height:100%}
img{-ms-interpolation-mode:bicubic}
.left{float:left!important}
.right{float:right!important}
.text-left{text-align:left!important}
.text-right{text-align:right!important}
.text-center{text-align:center!important}
.text-justify{text-align:justify!important}
.hide{display:none}
img,object,svg{display:inline-block;vertical-align:middle}
textarea{height:auto;min-height:50px}
select{width:100%}
.center{margin-left:auto;margin-right:auto}
.stretch{width:100%}
.subheader,.admonitionblock td.content>.title,.audioblock>.title,.exampleblock>.title,.imageblock>.title,.listingblock>.title,.literalblock>.title,.stemblock>.title,.openblock>.title,.paragraph>.title,.quoteblock>.title,table.tableblock>.title,.verseblock>.title,.videoblock>.title,.dlist>.title,.olist>.title,.ulist>.title,.qlist>.title,.hdlist>.title{line-height:1.45;color:#7a2518;font-weight:400;margin-top:0;margin-bottom:.25em}
div,dl,dt,dd,ul,ol,li,h1,h2,h3,#toctitle,.sidebarblock>.content>.title,h4,h5,h6,pre,form,p,blockquote,th,td{margin:0;padding:0;direction:ltr}
a{color:#2156a5;text-decoration:underline;line-height:inherit}
a:hover,a:focus{color:#1d4b8f}
a img{border:none}
p{font-family:inherit;font-weight:400;font-size:1em;line-height:1.6;margin-bottom:1.25em;text-rendering:optimizeLegibility}
p aside{font-size:.875em;line-height:1.35;font-style:italic}
h1,h2,h3,#toctitle,.sidebarblock>.content>.title,h4,h5,h6{font-family:"Open Sans","DejaVu Sans",sans-serif;font-weight:300;font-style:normal;color:#ba3925;text-rendering:optimizeLegibility;margin-top:1em;margin-bottom:.5em;line-height:1.0125em}
h1 small,h2 small,h3 small,#toctitle small,.sidebarblock>.content>.title small,h4 small,h5 small,h6 small{font-size:60%;color:#e99b8f;line-height:0}
h1{font-size:2.125em}
h2{font-size:1.6875em}
h3,#toctitle,.sidebarblock>.content>.title{font-size:1.375em}
h4,h5{font-size:1.125em}
h6{font-size:1em}
hr{border:solid #dddddf;border-width:1px 0 0;clear:both;margin:1.25em 0 1.1875em;height:0}
em,i{font-style:italic;line-height:inherit}
strong,b{font-weight:bold;line-height:inherit}
small{font-size:60%;line-height:inherit}
code{font-family:"Droid Sans Mono","DejaVu Sans Mono",monospace;font-weight:400;color:rgba(0,0,0,.9)}
ul,ol,dl{font-size:1em;line-height:1.6;margin-bottom:1.25em;list-style-position:outside;font-family:inherit}
ul,ol{margin-left:1.5em}
ul li ul,ul li ol{margin-left:1.25em;margin-bottom:0;font-size:1em}
ul.square li ul,ul.circle li ul,ul.disc li ul{list-style:inherit}
ul.square{list-style-type:square}
ul.circle{list-style-type:circle}
ul.disc{list-style-type:disc}
ol li ul,ol li ol{margin-left:1.25em;margin-bottom:0}
dl dt{margin-bottom:.3125em;font-weight:bold}
dl dd{margin-bottom:1.25em}
abbr,acronym{text-transform:uppercase;font-size:90%;color:rgba(0,0,0,.8);border-bottom:1px dotted #ddd;cursor:help}
abbr{text-transform:none}
blockquote{margin:0 0 1.25em;padding:.5625em 1.25em 0 1.1875em;border-left:1px solid #ddd}
blockquote cite{display:block;font-size:.9375em;color:rgba(0,0,0,.6)}
blockquote cite::before{content:"\2014 \0020"}
blockquote cite a,blockquote cite a:visited{color:rgba(0,0,0,.6)}
blockquote,blockquote p{line-height:1.6;color:rgba(0,0,0,.85)}
@media screen and (min-width:768px){h1,h2,h3,#toctitle,.sidebarblock>.content>.title,h4,h5,h6{line-height:1.2}
h1{font-size:2.75em}
h2{font-size:2.3125em}
h3,#toctitle,.sidebarblock>.content>.title{font-size:1.6875em}
h4{font-size:1.4375em}}
table{background:#fff;margin-bottom:1.25em;border:solid 1px #dedede}
table thead,table tfoot{background:#f7f8f7}
table thead tr th,table thead tr td,table tfoot tr th,table tfoot tr td{padding:.5em .625em .625em;font-size:inherit;color:rgba(0,0,0,.8);text-align:left}
table tr th,table tr td{padding:.5625em .625em;font-size:inherit;color:rgba(0,0,0,.8)}
table tr.even,table tr.alt,table tr:nth-of-type(even){background:#f8f8f7}
table thead tr th,table tfoot tr th,table tbody tr td,table tr td,table tfoot tr td{display:table-cell;line-height:1.6}
h1,h2,h3,#toctitle,.sidebarblock>.content>.title,h4,h5,h6{line-height:1.2;word-spacing:-.05em}
h1 strong,h2 strong,h3 strong,#toctitle strong,.sidebarblock>.content>.title strong,h4 strong,h5 strong,h6 strong{font-weight:400}
.clearfix::before,.clearfix::after,.float-group::before,.float-group::after{content:" ";display:table}
.clearfix::after,.float-group::after{clear:both}
*:not(pre)>code{font-size:.9375em;font-style:normal!important;letter-spacing:0;padding:.1em .5ex;word-spacing:-.15em;background-color:#f7f7f8;-webkit-border-radius:4px;border-radius:4px;line-height:1.45;text-rendering:optimizeSpeed;word-wrap:break-word}
*:not(pre)>code.nobreak{word-wrap:normal}
*:not(pre)>code.nowrap{white-space:nowrap}
pre,pre>code{line-height:1.45;color:rgba(0,0,0,.9);font-family:"Droid Sans Mono","DejaVu Sans Mono",monospace;font-weight:400;text-rendering:optimizeSpeed}
em em{font-style:normal}
strong strong{font-weight:400}
.keyseq{color:rgba(51,51,51,.8)}
kbd{font-family:"Droid Sans Mono","DejaVu Sans Mono",monospace;display:inline-block;color:rgba(0,0,0,.8);font-size:.65em;line-height:1.45;background-color:#f7f7f7;border:1px solid #ccc;-webkit-border-radius:3px;border-radius:3px;-webkit-box-shadow:0 1px 0 rgba(0,0,0,.2),0 0 0 .1em white inset;box-shadow:0 1px 0 rgba(0,0,0,.2),0 0 0 .1em #fff inset;margin:0 .15em;padding:.2em .5em;vertical-align:middle;position:relative;top:-.1em;white-space:nowrap}
.keyseq kbd:first-child{margin-left:0}
.keyseq kbd:last-child{margin-right:0}
.menuseq,.menuref{color:#000}
.menuseq b:not(.caret),.menuref{font-weight:inherit}
.menuseq{word-spacing:-.02em}
.menuseq b.caret{font-size:1.25em;line-height:.8}
.menuseq i.caret{font-weight:bold;text-align:center;width:.45em}
b.button::before,b.button::after{position:relative;top:-1px;font-weight:400}
b.button::before{content:"[";padding:0 3px 0 2px}
b.button::after{content:"]";padding:0 2px 0 3px}
p a>code:hover{color:rgba(0,0,0,.9)}
#header,#content,#footnotes,#footer{width:100%;margin-left:auto;margin-right:auto;margin-top:0;margin-bottom:0;max-width:62.5em;*zoom:1;position:relative;padding-left:.9375em;padding-right:.9375em}
#header::before,#header::after,#content::before,#content::after,#footnotes::before,#footnotes::after,#footer::before,#footer::after{content:" ";display:table}
#header::after,#content::after,#footnotes::after,#footer::after{clear:both}
#content{margin-top:1.25em}
#content::before{content:none}
#header>h1:first-child{color:rgba(0,0,0,.85);margin-top:2.25rem;margin-bottom:0}
#header>h1:first-child+#toc{margin-top:8px;border-top:1px solid #dddddf}
#header>h1:only-child,body.toc2 #header>h1:nth-last-child(2){border-bottom:1px solid #dddddf;padding-bottom:8px}
#header .details{border-bottom:1px solid #dddddf;line-height:1.45;padding-top:.25em;padding-bottom:.25em;padding-left:.25em;color:rgba(0,0,0,.6);display:-ms-flexbox;display:-webkit-flex;display:flex;-ms-flex-flow:row wrap;-webkit-flex-flow:row wrap;flex-flow:row wrap}
#header .details span:first-child{margin-left:-.125em}
#header .details span.email a{color:rgba(0,0,0,.85)}
#header .details br{display:none}
#header .details br+span::before{content:"\00a0\2013\00a0"}
#header .details br+span.author::before{content:"\00a0\22c5\00a0";color:rgba(0,0,0,.85)}
#header .details br+span#revremark::before{content:"\00a0|\00a0"}
#header #revnumber{text-transform:capitalize}
#header #revnumber::after{content:"\00a0"}
#content>h1:first-child:not([class]){color:rgba(0,0,0,.85);border-bottom:1px solid #dddddf;padding-bottom:8px;margin-top:0;padding-top:1rem;margin-bottom:1.25rem}
#toc{border-bottom:1px solid #e7e7e9;padding-bottom:.5em}
#toc>ul{margin-left:.125em}
#toc ul.sectlevel0>li>a{font-style:italic}
#toc ul.sectlevel0 ul.sectlevel1{margin:.5em 0}
#toc ul{font-family:"Open Sans","DejaVu Sans",sans-serif;list-style-type:none}
#toc li{line-height:1.3334;margin-top:.3334em}
#toc a{text-decoration:none}
#toc a:active{text-decoration:underline}
#toctitle{color:#7a2518;font-size:1.2em}
@media screen and (min-width:768px){#toctitle{font-size:1.375em}
body.toc2{padding-left:15em;padding-right:0}
#toc.toc2{margin-top:0!important;background-color:#f8f8f7;position:fixed;width:15em;left:0;top:0;border-right:1px solid #e7e7e9;border-top-width:0!important;border-bottom-width:0!important;z-index:1000;padding:1.25em 1em;height:100%;overflow:auto}
#toc.toc2 #toctitle{margin-top:0;margin-bottom:.8rem;font-size:1.2em}
#toc.toc2>ul{font-size:.9em;margin-bottom:0}
#toc.toc2 ul ul{margin-left:0;padding-left:1em}
#toc.toc2 ul.sectlevel0 ul.sectlevel1{padding-left:0;margin-top:.5em;margin-bottom:.5em}
body.toc2.toc-right{padding-left:0;padding-right:15em}
body.toc2.toc-right #toc.toc2{border-right-width:0;border-left:1px solid #e7e7e9;left:auto;right:0}}
@media screen and (min-width:1280px){body.toc2{padding-left:20em;padding-right:0}
#toc.toc2{width:20em}
#toc.toc2 #toctitle{font-size:1.375em}
#toc.toc2>ul{font-size:.95em}
#toc.toc2 ul ul{padding-left:1.25em}
body.toc2.toc-right{padding-left:0;padding-right:20em}}
#content #toc{border-style:solid;border-width:1px;border-color:#e0e0dc;margin-bottom:1.25em;padding:1.25em;background:#f8f8f7;-webkit-border-radius:4px;border-radius:4px}
#content #toc>:first-child{margin-top:0}
#content #toc>:last-child{margin-bottom:0}
#footer{max-width:100%;background-color:rgba(0,0,0,.8);padding:1.25em}
#footer-text{color:rgba(255,255,255,.8);line-height:1.44}
#content{margin-bottom:.625em}
.sect1{padding-bottom:.625em}
@media screen and (min-width:768px){#content{margin-bottom:1.25em}
.sect1{padding-bottom:1.25em}}
.sect1:last-child{padding-bottom:0}
.sect1+.sect1{border-top:1px solid #e7e7e9}
#content h1>a.anchor,h2>a.anchor,h3>a.anchor,#toctitle>a.anchor,.sidebarblock>.content>.title>a.anchor,h4>a.anchor,h5>a.anchor,h6>a.anchor{position:absolute;z-index:1001;width:1.5ex;margin-left:-1.5ex;display:block;text-decoration:none!important;visibility:hidden;text-align:center;font-weight:400}
#content h1>a.anchor::before,h2>a.anchor::before,h3>a.anchor::before,#toctitle>a.anchor::before,.sidebarblock>.content>.title>a.anchor::before,h4>a.anchor::before,h5>a.anchor::before,h6>a.anchor::before{content:"\00A7";font-size:.85em;display:block;padding-top:.1em}
#content h1:hover>a.anchor,#content h1>a.anchor:hover,h2:hover>a.anchor,h2>a.anchor:hover,h3:hover>a.anchor,#toctitle:hover>a.anchor,.sidebarblock>.content>.title:hover>a.anchor,h3>a.anchor:hover,#toctitle>a.anchor:hover,.sidebarblock>.content>.title>a.anchor:hover,h4:hover>a.anchor,h4>a.anchor:hover,h5:hover>a.anchor,h5>a.anchor:hover,h6:hover>a.anchor,h6>a.anchor:hover{visibility:visible}
#content h1>a.link,h2>a.link,h3>a.link,#toctitle>a.link,.sidebarblock>.content>.title>a.link,h4>a.link,h5>a.link,h6>a.link{color:#ba3925;text-decoration:none}
#content h1>a.link:hover,h2>a.link:hover,h3>a.link:hover,#toctitle>a.link:hover,.sidebarblock>.content>.title>a.link:hover,h4>a.link:hover,h5>a.link:hover,h6>a.link:hover{color:#a53221}
.audioblock,.imageblock,.literalblock,.listingblock,.stemblock,.videoblock{margin-bottom:1.25em}
.admonitionblock td.content>.title,.audioblock>.title,.exampleblock>.title,.imageblock>.title,.listingblock>.title,.literalblock>.title,.stemblock>.title,.openblock>.title,.paragraph>.title,.quoteblock>.title,table.tableblock>.title,.verseblock>.title,.videoblock>.title,.dlist>.title,.olist>.title,.ulist>.title,.qlist>.title,.hdlist>.title{text-rendering:optimizeLegibility;text-align:left;font-family:"Noto Serif","DejaVu Serif",serif;font-size:1rem;font-style:italic}
table.tableblock.fit-content>caption.title{white-space:nowrap;width:0}
.paragraph.lead>p,#preamble>.sectionbody>[class="paragraph"]:first-of-type p{font-size:1.21875em;line-height:1.6;color:rgba(0,0,0,.85)}
table.tableblock #preamble>.sectionbody>[class="paragraph"]:first-of-type p{font-size:inherit}
.admonitionblock>table{border-collapse:separate;border:0;background:none;width:100%}
.admonitionblock>table td.icon{text-align:center;width:80px}
.admonitionblock>table td.icon img{max-width:none}
.admonitionblock>table td.icon .title{font-weight:bold;font-family:"Open Sans","DejaVu Sans",sans-serif;text-transform:uppercase}
.admonitionblock>table td.content{padding-left:1.125em;padding-right:1.25em;border-left:1px solid #dddddf;color:rgba(0,0,0,.6)}
.admonitionblock>table td.content>:last-child>:last-child{margin-bottom:0}
.exampleblock>.content{border-style:solid;border-width:1px;border-color:#e6e6e6;margin-bottom:1.25em;padding:1.25em;background:#fff;-webkit-border-radius:4px;border-radius:4px}
.exampleblock>.content>:first-child{margin-top:0}
.exampleblock>.content>:last-child{margin-bottom:0}
.sidebarblock{border-style:solid;border-width:1px;border-color:#e0e0dc;margin-bottom:1.25em;padding:1.25em;background:#f8f8f7;-webkit-border-radius:4px;border-radius:4px}
.sidebarblock>:first-child{margin-top:0}
.sidebarblock>:last-child{margin-bottom:0}
.sidebarblock>.content>.title{color:#7a2518;margin-top:0;text-align:center}
.exampleblock>.content>:last-child>:last-child,.exampleblock>.content .olist>ol>li:last-child>:last-child,.exampleblock>.content .ulist>ul>li:last-child>:last-child,.exampleblock>.content .qlist>ol>li:last-child>:last-child,.sidebarblock>.content>:last-child>:last-child,.sidebarblock>.content .olist>ol>li:last-child>:last-child,.sidebarblock>.content .ulist>ul>li:last-child>:last-child,.sidebarblock>.content .qlist>ol>li:last-child>:last-child{margin-bottom:0}
.literalblock pre,.listingblock pre:not(.highlight),.listingblock pre[class="highlight"],.listingblock pre[class^="highlight "],.listingblock pre.CodeRay,.listingblock pre.prettyprint{background:#f7f7f8}
.sidebarblock .literalblock pre,.sidebarblock .listingblock pre:not(.highlight),.sidebarblock .listingblock pre[class="highlight"],.sidebarblock .listingblock pre[class^="highlight "],.sidebarblock .listingblock pre.CodeRay,.sidebarblock .listingblock pre.prettyprint{background:#f2f1f1}
.literalblock pre,.literalblock pre[class],.listingblock pre,.listingblock pre[class]{-webkit-border-radius:4px;border-radius:4px;word-wrap:break-word;overflow-x:auto;padding:1em;font-size:.8125em}
@media screen and (min-width:768px){.literalblock pre,.literalblock pre[class],.listingblock pre,.listingblock pre[class]{font-size:.90625em}}
@media screen and (min-width:1280px){.literalblock pre,.literalblock pre[class],.listingblock pre,.listingblock pre[class]{font-size:1em}}
.literalblock pre.nowrap,.literalblock pre.nowrap pre,.listingblock pre.nowrap,.listingblock pre.nowrap pre{white-space:pre;word-wrap:normal}
.literalblock.output pre{color:#f7f7f8;background-color:rgba(0,0,0,.9)}
.listingblock pre.highlightjs{padding:0}
.listingblock pre.highlightjs>code{padding:1em;-webkit-border-radius:4px;border-radius:4px}
.listingblock pre.prettyprint{border-width:0}
.listingblock>.content{position:relative}
.listingblock code[data-lang]::before{display:none;content:attr(data-lang);position:absolute;font-size:.75em;top:.425rem;right:.5rem;line-height:1;text-transform:uppercase;color:#999}
.listingblock:hover code[data-lang]::before{display:block}
.listingblock.terminal pre .command::before{content:attr(data-prompt);padding-right:.5em;color:#999}
.listingblock.terminal pre .command:not([data-prompt])::before{content:"$"}
table.pyhltable{border-collapse:separate;border:0;margin-bottom:0;background:none}
table.pyhltable td{vertical-align:top;padding-top:0;padding-bottom:0;line-height:1.45}
table.pyhltable td.code{padding-left:.75em;padding-right:0}
pre.pygments .lineno,table.pyhltable td:not(.code){color:#999;padding-left:0;padding-right:.5em;border-right:1px solid #dddddf}
pre.pygments .lineno{display:inline-block;margin-right:.25em}
table.pyhltable .linenodiv{background:none!important;padding-right:0!important}
.quoteblock{margin:0 1em 1.25em 1.5em;display:table}
.quoteblock>.title{margin-left:-1.5em;margin-bottom:.75em}
.quoteblock blockquote,.quoteblock p{color:rgba(0,0,0,.85);font-size:1.15rem;line-height:1.75;word-spacing:.1em;letter-spacing:0;font-style:italic;text-align:justify}
.quoteblock blockquote{margin:0;padding:0;border:0}
.quoteblock blockquote::before{content:"\201c";float:left;font-size:2.75em;font-weight:bold;line-height:.6em;margin-left:-.6em;color:#7a2518;text-shadow:0 1px 2px rgba(0,0,0,.1)}
.quoteblock blockquote>.paragraph:last-child p{margin-bottom:0}
.quoteblock .attribution{margin-top:.75em;margin-right:.5ex;text-align:right}
.verseblock{margin:0 1em 1.25em}
.verseblock pre{font-family:"Open Sans","DejaVu Sans",sans;font-size:1.15rem;color:rgba(0,0,0,.85);font-weight:300;text-rendering:optimizeLegibility}
.verseblock pre strong{font-weight:400}
.verseblock .attribution{margin-top:1.25rem;margin-left:.5ex}
.quoteblock .attribution,.verseblock .attribution{font-size:.9375em;line-height:1.45;font-style:italic}
.quoteblock .attribution br,.verseblock .attribution br{display:none}
.quoteblock .attribution cite,.verseblock .attribution cite{display:block;letter-spacing:-.025em;color:rgba(0,0,0,.6)}
.quoteblock.abstract blockquote::before,.quoteblock.excerpt blockquote::before,.quoteblock .quoteblock blockquote::before{display:none}
.quoteblock.abstract blockquote,.quoteblock.abstract p,.quoteblock.excerpt blockquote,.quoteblock.excerpt p,.quoteblock .quoteblock blockquote,.quoteblock .quoteblock p{line-height:1.6;word-spacing:0}
.quoteblock.abstract{margin:0 1em 1.25em;display:block}
.quoteblock.abstract>.title{margin:0 0 .375em;font-size:1.15em;text-align:center}
.quoteblock.excerpt,.quoteblock .quoteblock{margin:0 0 1.25em;padding:0 0 .25em 1em;border-left:.25em solid #dddddf}
.quoteblock.excerpt blockquote,.quoteblock.excerpt p,.quoteblock .quoteblock blockquote,.quoteblock .quoteblock p{color:inherit;font-size:1.0625rem}
.quoteblock.excerpt .attribution,.quoteblock .quoteblock .attribution{color:inherit;text-align:left;margin-right:0}
table.tableblock{max-width:100%;border-collapse:separate}
p.tableblock:last-child{margin-bottom:0}
td.tableblock>.content{margin-bottom:-1.25em}
table.tableblock,th.tableblock,td.tableblock{border:0 solid #dedede}
table.grid-all>thead>tr>.tableblock,table.grid-all>tbody>tr>.tableblock{border-width:0 1px 1px 0}
table.grid-all>tfoot>tr>.tableblock{border-width:1px 1px 0 0}
table.grid-cols>*>tr>.tableblock{border-width:0 1px 0 0}
table.grid-rows>thead>tr>.tableblock,table.grid-rows>tbody>tr>.tableblock{border-width:0 0 1px}
table.grid-rows>tfoot>tr>.tableblock{border-width:1px 0 0}
table.grid-all>*>tr>.tableblock:last-child,table.grid-cols>*>tr>.tableblock:last-child{border-right-width:0}
table.grid-all>tbody>tr:last-child>.tableblock,table.grid-all>thead:last-child>tr>.tableblock,table.grid-rows>tbody>tr:last-child>.tableblock,table.grid-rows>thead:last-child>tr>.tableblock{border-bottom-width:0}
table.frame-all{border-width:1px}
table.frame-sides{border-width:0 1px}
table.frame-topbot,table.frame-ends{border-width:1px 0}
table.stripes-all tr,table.stripes-odd tr:nth-of-type(odd){background:#f8f8f7}
table.stripes-none tr,table.stripes-odd tr:nth-of-type(even){background:none}
th.halign-left,td.halign-left{text-align:left}
th.halign-right,td.halign-right{text-align:right}
th.halign-center,td.halign-center{text-align:center}
th.valign-top,td.valign-top{vertical-align:top}
th.valign-bottom,td.valign-bottom{vertical-align:bottom}
th.valign-middle,td.valign-middle{vertical-align:middle}
table thead th,table tfoot th{font-weight:bold}
tbody tr th{display:table-cell;line-height:1.6;background:#f7f8f7}
tbody tr th,tbody tr th p,tfoot tr th,tfoot tr th p{color:rgba(0,0,0,.8);font-weight:bold}
p.tableblock>code:only-child{background:none;padding:0}
p.tableblock{font-size:1em}
td>div.verse{white-space:pre}
ol{margin-left:1.75em}
ul li ol{margin-left:1.5em}
dl dd{margin-left:1.125em}
dl dd:last-child,dl dd:last-child>:last-child{margin-bottom:0}
ol>li p,ul>li p,ul dd,ol dd,.olist .olist,.ulist .ulist,.ulist .olist,.olist .ulist{margin-bottom:.625em}
ul.checklist,ul.none,ol.none,ul.no-bullet,ol.no-bullet,ol.unnumbered,ul.unstyled,ol.unstyled{list-style-type:none}
ul.no-bullet,ol.no-bullet,ol.unnumbered{margin-left:.625em}
ul.unstyled,ol.unstyled{margin-left:0}
ul.checklist{margin-left:.625em}
ul.checklist li>p:first-child>.fa-square-o:first-child,ul.checklist li>p:first-child>.fa-check-square-o:first-child{width:1.25em;font-size:.8em;position:relative;bottom:.125em}
ul.checklist li>p:first-child>input[type="checkbox"]:first-child{margin-right:.25em}
ul.inline{display:-ms-flexbox;display:-webkit-box;display:flex;-ms-flex-flow:row wrap;-webkit-flex-flow:row wrap;flex-flow:row wrap;list-style:none;margin:0 0 .625em -1.25em}
ul.inline>li{margin-left:1.25em}
.unstyled dl dt{font-weight:400;font-style:normal}
ol.arabic{list-style-type:decimal}
ol.decimal{list-style-type:decimal-leading-zero}
ol.loweralpha{list-style-type:lower-alpha}
ol.upperalpha{list-style-type:upper-alpha}
ol.lowerroman{list-style-type:lower-roman}
ol.upperroman{list-style-type:upper-roman}
ol.lowergreek{list-style-type:lower-greek}
.hdlist>table,.colist>table{border:0;background:none}
.hdlist>table>tbody>tr,.colist>table>tbody>tr{background:none}
td.hdlist1,td.hdlist2{vertical-align:top;padding:0 .625em}
td.hdlist1{font-weight:bold;padding-bottom:1.25em}
.literalblock+.colist,.listingblock+.colist{margin-top:-.5em}
.colist td:not([class]):first-child{padding:.4em .75em 0;line-height:1;vertical-align:top}
.colist td:not([class]):first-child img{max-width:none}
.colist td:not([class]):last-child{padding:.25em 0}
.thumb,.th{line-height:0;display:inline-block;border:solid 4px #fff;-webkit-box-shadow:0 0 0 1px #ddd;box-shadow:0 0 0 1px #ddd}
.imageblock.left{margin:.25em .625em 1.25em 0}
.imageblock.right{margin:.25em 0 1.25em .625em}
.imageblock>.title{margin-bottom:0}
.imageblock.thumb,.imageblock.th{border-width:6px}
.imageblock.thumb>.title,.imageblock.th>.title{padding:0 .125em}
.image.left,.image.right{margin-top:.25em;margin-bottom:.25em;display:inline-block;line-height:0}
.image.left{margin-right:.625em}
.image.right{margin-left:.625em}
a.image{text-decoration:none;display:inline-block}
a.image object{pointer-events:none}
sup.footnote,sup.footnoteref{font-size:.875em;position:static;vertical-align:super}
sup.footnote a,sup.footnoteref a{text-decoration:none}
sup.footnote a:active,sup.footnoteref a:active{text-decoration:underline}
#footnotes{padding-top:.75em;padding-bottom:.75em;margin-bottom:.625em}
#footnotes hr{width:20%;min-width:6.25em;margin:-.25em 0 .75em;border-width:1px 0 0}
#footnotes .footnote{padding:0 .375em 0 .225em;line-height:1.3334;font-size:.875em;margin-left:1.2em;margin-bottom:.2em}
#footnotes .footnote a:first-of-type{font-weight:bold;text-decoration:none;margin-left:-1.05em}
#footnotes .footnote:last-of-type{margin-bottom:0}
#content #footnotes{margin-top:-.625em;margin-bottom:0;padding:.75em 0}
.gist .file-data>table{border:0;background:#fff;width:100%;margin-bottom:0}
.gist .file-data>table td.line-data{width:99%}
div.unbreakable{page-break-inside:avoid}
.big{font-size:larger}
.small{font-size:smaller}
.underline{text-decoration:underline}
.overline{text-decoration:overline}
.line-through{text-decoration:line-through}
.aqua{color:#00bfbf}
.aqua-background{background-color:#00fafa}
.black{color:#000}
.black-background{background-color:#000}
.blue{color:#0000bf}
.blue-background{background-color:#0000fa}
.fuchsia{color:#bf00bf}
.fuchsia-background{background-color:#fa00fa}
.gray{color:#606060}
.gray-background{background-color:#7d7d7d}
.green{color:#006000}
.green-background{background-color:#007d00}
.lime{color:#00bf00}
.lime-background{background-color:#00fa00}
.maroon{color:#600000}
.maroon-background{background-color:#7d0000}
.navy{color:#000060}
.navy-background{background-color:#00007d}
.olive{color:#606000}
.olive-background{background-color:#7d7d00}
.purple{color:#600060}
.purple-background{background-color:#7d007d}
.red{color:#bf0000}
.red-background{background-color:#fa0000}
.silver{color:#909090}
.silver-background{background-color:#bcbcbc}
.teal{color:#006060}
.teal-background{background-color:#007d7d}
.white{color:#bfbfbf}
.white-background{background-color:#fafafa}
.yellow{color:#bfbf00}
.yellow-background{background-color:#fafa00}
span.icon>.fa{cursor:default}
a span.icon>.fa{cursor:inherit}
.admonitionblock td.icon [class^="fa icon-"]{font-size:2.5em;text-shadow:1px 1px 2px rgba(0,0,0,.5);cursor:default}
.admonitionblock td.icon .icon-note::before{content:"\f05a";color:#19407c}
.admonitionblock td.icon .icon-tip::before{content:"\f0eb";text-shadow:1px 1px 2px rgba(155,155,0,.8);color:#111}
.admonitionblock td.icon .icon-warning::before{content:"\f071";color:#bf6900}
.admonitionblock td.icon .icon-caution::before{content:"\f06d";color:#bf3400}
.admonitionblock td.icon .icon-important::before{content:"\f06a";color:#bf0000}
.conum[data-value]{display:inline-block;color:#fff!important;background-color:rgba(0,0,0,.8);-webkit-border-radius:100px;border-radius:100px;text-align:center;font-size:.75em;width:1.67em;height:1.67em;line-height:1.67em;font-family:"Open Sans","DejaVu Sans",sans-serif;font-style:normal;font-weight:bold}
.conum[data-value] *{color:#fff!important}
.conum[data-value]+b{display:none}
.conum[data-value]::after{content:attr(data-value)}
pre .conum[data-value]{position:relative;top:-.125em}
b.conum *{color:inherit!important}
.conum:not([data-value]):empty{display:none}
dt,th.tableblock,td.content,div.footnote{text-rendering:optimizeLegibility}
h1,h2,p,td.content,span.alt{letter-spacing:-.01em}
p strong,td.content strong,div.footnote strong{letter-spacing:-.005em}
p,blockquote,dt,td.content,span.alt{font-size:1.0625rem}
p{margin-bottom:1.25rem}
.sidebarblock p,.sidebarblock dt,.sidebarblock td.content,p.tableblock{font-size:1em}
.exampleblock>.content{background-color:#fffef7;border-color:#e0e0dc;-webkit-box-shadow:0 1px 4px #e0e0dc;box-shadow:0 1px 4px #e0e0dc}
.print-only{display:none!important}
@page{margin:1.25cm .75cm}
@media print{*{-webkit-box-shadow:none!important;box-shadow:none!important;text-shadow:none!important}
html{font-size:80%}
a{color:inherit!important;text-decoration:underline!important}
a.bare,a[href^="#"],a[href^="mailto:"]{text-decoration:none!important}
a[href^="http:"]:not(.bare)::after,a[href^="https:"]:not(.bare)::after{content:"(" attr(href) ")";display:inline-block;font-size:.875em;padding-left:.25em}
abbr[title]::after{content:" (" attr(title) ")"}
pre,blockquote,tr,img,object,svg{page-break-inside:avoid}
thead{display:table-header-group}
svg{max-width:100%}
p,blockquote,dt,td.content{font-size:1em;orphans:3;widows:3}
h2,h3,#toctitle,.sidebarblock>.content>.title{page-break-after:avoid}
#toc,.sidebarblock,.exampleblock>.content{background:none!important}
#toc{border-bottom:1px solid #dddddf!important;padding-bottom:0!important}
body.book #header{text-align:center}
body.book #header>h1:first-child{border:0!important;margin:2.5em 0 1em}
body.book #header .details{border:0!important;display:block;padding:0!important}
body.book #header .details span:first-child{margin-left:0!important}
body.book #header .details br{display:block}
body.book #header .details br+span::before{content:none!important}
body.book #toc{border:0!important;text-align:left!important;padding:0!important;margin:0!important}
body.book #toc,body.book #preamble,body.book h1.sect0,body.book .sect1>h2{page-break-before:always}
.listingblock code[data-lang]::before{display:block}
#footer{padding:0 .9375em}
.hide-on-print{display:none!important}
.print-only{display:block!important}
.hide-for-print{display:none!important}
.show-for-print{display:inherit!important}}
@media print,amzn-kf8{#header>h1:first-child{margin-top:1.25rem}
.sect1{padding:0!important}
.sect1+.sect1{border:0}
#footer{background:none}
#footer-text{color:rgba(0,0,0,.6);font-size:.9em}}
@media amzn-kf8{#header,#content,#footnotes,#footer{padding:0}}
</style>
<style>
/* Stylesheet for CodeRay to match GitHub theme | MIT License | http://foundation.zurb.com */
/*pre.CodeRay {background-color:#f7f7f8;}*/
.CodeRay .line-numbers{border-right:1px solid #d8d8d8;padding:0 0.5em 0 .25em}
.CodeRay span.line-numbers{display:inline-block;margin-right:.5em;color:rgba(0,0,0,.3)}
.CodeRay .line-numbers strong{color:rgba(0,0,0,.4)}
table.CodeRay{border-collapse:separate;border-spacing:0;margin-bottom:0;border:0;background:none}
table.CodeRay td{vertical-align: top;line-height:1.45}
table.CodeRay td.line-numbers{text-align:right}
table.CodeRay td.line-numbers>pre{padding:0;color:rgba(0,0,0,.3)}
table.CodeRay td.code{padding:0 0 0 .5em}
table.CodeRay td.code>pre{padding:0}
.CodeRay .debug{color:#fff !important;background:#000080 !important}
.CodeRay .annotation{color:#007}
.CodeRay .attribute-name{color:#000080}
.CodeRay .attribute-value{color:#700}
.CodeRay .binary{color:#509}
.CodeRay .comment{color:#998;font-style:italic}
.CodeRay .char{color:#04d}
.CodeRay .char .content{color:#04d}
.CodeRay .char .delimiter{color:#039}
.CodeRay .class{color:#458;font-weight:bold}
.CodeRay .complex{color:#a08}
.CodeRay .constant,.CodeRay .predefined-constant{color:#008080}
.CodeRay .color{color:#099}
.CodeRay .class-variable{color:#369}
.CodeRay .decorator{color:#b0b}
.CodeRay .definition{color:#099}
.CodeRay .delimiter{color:#000}
.CodeRay .doc{color:#970}
.CodeRay .doctype{color:#34b}
.CodeRay .doc-string{color:#d42}
.CodeRay .escape{color:#666}
.CodeRay .entity{color:#800}
.CodeRay .error{color:#808}
.CodeRay .exception{color:inherit}
.CodeRay .filename{color:#099}
.CodeRay .function{color:#900;font-weight:bold}
.CodeRay .global-variable{color:#008080}
.CodeRay .hex{color:#058}
.CodeRay .integer,.CodeRay .float{color:#099}
.CodeRay .include{color:#555}
.CodeRay .inline{color:#000}
.CodeRay .inline .inline{background:#ccc}
.CodeRay .inline .inline .inline{background:#bbb}
.CodeRay .inline .inline-delimiter{color:#d14}
.CodeRay .inline-delimiter{color:#d14}
.CodeRay .important{color:#555;font-weight:bold}
.CodeRay .interpreted{color:#b2b}
.CodeRay .instance-variable{color:#008080}
.CodeRay .label{color:#970}
.CodeRay .local-variable{color:#963}
.CodeRay .octal{color:#40e}
.CodeRay .predefined{color:#369}
.CodeRay .preprocessor{color:#579}
.CodeRay .pseudo-class{color:#555}
.CodeRay .directive{font-weight:bold}
.CodeRay .type{font-weight:bold}
.CodeRay .predefined-type{color:inherit}
.CodeRay .reserved,.CodeRay .keyword {color:#000;font-weight:bold}
.CodeRay .key{color:#808}
.CodeRay .key .delimiter{color:#606}
.CodeRay .key .char{color:#80f}
.CodeRay .value{color:#088}
.CodeRay .regexp .delimiter{color:#808}
.CodeRay .regexp .content{color:#808}
.CodeRay .regexp .modifier{color:#808}
.CodeRay .regexp .char{color:#d14}
.CodeRay .regexp .function{color:#404;font-weight:bold}
.CodeRay .string{color:#d20}
.CodeRay .string .string .string{background:#ffd0d0}
.CodeRay .string .content{color:#d14}
.CodeRay .string .char{color:#d14}
.CodeRay .string .delimiter{color:#d14}
.CodeRay .shell{color:#d14}
.CodeRay .shell .delimiter{color:#d14}
.CodeRay .symbol{color:#990073}
.CodeRay .symbol .content{color:#a60}
.CodeRay .symbol .delimiter{color:#630}
.CodeRay .tag{color:#008080}
.CodeRay .tag-special{color:#d70}
.CodeRay .variable{color:#036}
.CodeRay .insert{background:#afa}
.CodeRay .delete{background:#faa}
.CodeRay .change{color:#aaf;background:#007}
.CodeRay .head{color:#f8f;background:#505}
.CodeRay .insert .insert{color:#080}
.CodeRay .delete .delete{color:#800}
.CodeRay .change .change{color:#66f}
.CodeRay .head .head{color:#f4f}
</style>
</head>
<body class="book toc2 toc-left">
<div id="header">
<h1>Ersatz Server User Guide</h1>
<div class="details">
<span id="author" class="author">Christopher J. Stehno</span><br>
<span id="email" class="email"><a href="mailto:chris@stehno.com">chris@stehno.com</a></span><br>
<span id="revnumber">version 2.0.0,</span>
<span id="revdate">January 2020</span>
</div>
<div id="toc" class="toc2">
<div id="toctitle">Table of Contents</div>
<ul class="sectlevel1">
<li><a href="#_introduction">Introduction</a></li>
<li><a href="#_whats_new_in_2_0">What&#8217;s New in 2.0</a>
<ul class="sectlevel2">
<li><a href="#_migrating_to_2_0">Migrating to 2.0</a></li>
</ul>
</li>
<li><a href="#_whats_new_in_1_9">What&#8217;s New in 1.9</a></li>
<li><a href="#_whats_new_in_1_8">What&#8217;s New in 1.8</a></li>
<li><a href="#_getting_started">Getting Started</a></li>
<li><a href="#_ersatz_server">Ersatz Server</a>
<ul class="sectlevel2">
<li><a href="#_lifecycle">Lifecycle</a>
<ul class="sectlevel3">
<li><a href="#_configuration">Configuration</a></li>
<li><a href="#_testing">Testing</a></li>
<li><a href="#_verification">Verification</a></li>
<li><a href="#_cleanup">Cleanup</a></li>
</ul>
</li>
</ul>
</li>
<li><a href="#_configuration_2">Configuration</a>
<ul class="sectlevel2">
<li><a href="#_authentication">Authentication</a>
<ul class="sectlevel3">
<li><a href="#_basic_authentication">BASIC Authentication</a></li>
<li><a href="#_digest_authentication">DIGEST Authentication</a></li>
</ul>
</li>
<li><a href="#_auto_start">Auto-Start</a></li>
<li><a href="#_content_translation">Content Translation</a>
<ul class="sectlevel3">
<li><a href="#_decoders">Decoders</a></li>
<li><a href="#_encoders">Encoders</a></li>
</ul>
</li>
<li><a href="#_expectations">Expectations</a>
<ul class="sectlevel3">
<li><a href="#_request_methods">Request Methods</a>
<ul class="sectlevel4">
<li><a href="#_head">HEAD</a></li>
<li><a href="#_get">GET</a></li>
<li><a href="#_options">OPTIONS</a></li>
<li><a href="#_post">POST</a></li>
<li><a href="#_put">PUT</a></li>
<li><a href="#_delete">DELETE</a></li>
<li><a href="#_patch">PATCH</a></li>
<li><a href="#_trace">TRACE</a></li>
</ul>
</li>
<li><a href="#_web_sockets">Web Sockets</a>
<ul class="sectlevel4">
<li><a href="#_reactions">Reactions</a></li>
<li><a href="#_message_push">Message Push</a></li>
<li><a href="#_verification_2">Verification</a></li>
</ul>
</li>
</ul>
</li>
<li><a href="#_request_matching">Request Matching</a>
<ul class="sectlevel3">
<li><a href="#_hamcrest_matchers">Hamcrest Matchers</a></li>
<li><a href="#_matching_cookies">Matching Cookies</a>
<ul class="sectlevel4">
<li><a href="#_by_name_and_matcher">By Name and Matcher</a></li>
<li><a href="#_by_name_and_value">By Name and Value</a></li>
<li><a href="#_multiple_cookies">Multiple Cookies</a></li>
</ul>
</li>
<li><a href="#_overall_matcher">Overall Matcher</a></li>
</ul>
</li>
<li><a href="#_https">HTTPS</a>
<ul class="sectlevel3">
<li><a href="#_creating_a_custom_keystore">Creating a Custom Keystore</a></li>
</ul>
</li>
<li><a href="#_request_timeout">Request Timeout</a></li>
<li><a href="#_request_response_compression">Request / Response Compression</a></li>
<li><a href="#_chunked_response">Chunked Response</a></li>
<li><a href="#_multipart_request_content">Multipart Request Content</a></li>
<li><a href="#_multipart_response_content">Multipart Response Content</a></li>
</ul>
</li>
<li><a href="#_proxy_server">Proxy Server</a></li>
<li><a href="#_sightings">Sightings</a></li>
<li><a href="#_shadow_jar">Shadow Jar</a></li>
<li><a href="#_utilities">Utilities</a>
<ul class="sectlevel2">
<li><a href="#_dummycontentgenerator"><code>DummyContentGenerator</code></a></li>
</ul>
</li>
<li><a href="#_usage_examples">Usage Examples</a>
<ul class="sectlevel2">
<li><a href="#_url_encoded_form_requests">Url-Encoded Form Requests</a></li>
<li><a href="#_file_upload_post">File Upload (POST)</a></li>
<li><a href="#_file_download_get">File Download (GET)</a></li>
<li><a href="#_kotlin_usage">Kotlin Usage</a></li>
<li><a href="#_matching_xml_body_content">Matching XML Body Content</a></li>
</ul>
</li>
</ul>
</div>
</div>
<div id="content">
<div class="sect1">
<h2 id="_introduction">Introduction</h2>
<div class="sectionbody">
<div class="paragraph">
<p>The Ersatz Server is a HTTP client testing tool, which allows for request/response expectations to be configured in a flexible manner. The expectations
will respond in a configured manner to requests and allow testing with different responses and/or error conditions without having to write a lot of
boiler-plate code.</p>
</div>
<div class="paragraph">
<p>The "mock" server is not really mock at all, it is an embedded Undertow HTTP server which registers the configured expectations as routes and then
responds according to the expected behavior. This approach may seem overly heavy; however, testing an HTTP client can involve a lot of internal state
and interactions that the developer is generally unaware of (and should be) - trying to mock those interactions with a pure mocking framework will get
out of hand very quickly, and Undertow starts up very quickly.</p>
</div>
<div class="paragraph">
<p>Ersatz provides a balance of mock-like expectation behavior with a real HTTP interface and all of the underlying interactions in place. This allows
for rich unit testing, which is what you were trying to do in the first place.</p>
</div>
<div class="paragraph">
<p>Ersatz is written in Groovy 2.4.x and requires a Java 8 VM due to its use of the modern functional libraries; however, the Ersatz library is written
such that it may be used with Groovy or standard Java (or even Kotlin) without pain or feature-loss. With that in mind, the expectation configuration
allows two main forms, a Java-style chained builder, and a Groovy DSL, both of which may be used interchangeably or together, if you are using Groovy.</p>
</div>
<div class="paragraph">
<p>Ersatz is developed with testing in mind. It does not favor any specific testing framework, but it does work well with both the JUnit and Spock
frameworks.</p>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_whats_new_in_2_0">What&#8217;s New in 2.0</h2>
<div class="sectionbody">
<div class="ulist">
<ul>
<li>
<p>Not directly backward compatible with 1.x codebase (see migration notes below).</p>
</li>
<li>
<p>Requires Java 11+.</p>
</li>
<li>
<p>Refactored code and packaging as well as code-conversion from Groovy to Java (no loss of support for using with Groovy).</p>
</li>
<li>
<p>Removed deprecated methods.</p>
</li>
<li>
<p>Refactored the HTTP method names to be uppercase.</p>
</li>
<li>
<p>Added optional timeout for standard request verify calls.</p>
</li>
<li>
<p>Converted the underlying response content from String to byte[] (also changed response encoder API)</p>
</li>
<li>
<p>Refactored the underlying server into a more abstract integration so that it may be swapped out in the future.</p>
</li>
<li>
<p>Pulled external Closure helper API code into codebase (to avoid breaking maven-central support)</p>
</li>
<li>
<p>Refactored the JUnit support (4 and 5)</p>
</li>
</ul>
</div>
<div class="sect2">
<h3 id="_migrating_to_2_0">Migrating to 2.0</h3>
<div class="ulist">
<ul>
<li>
<p>Change all HTTP method names to uppercase (e.g. if you have a <code>head('/foo')</code> call, change it to <code>HEAD('/foo')</code>).</p>
</li>
<li>
<p>Replace any deprecated method usages with appropriate replacements.</p>
</li>
<li>
<p>If you use the <code>ErsatzProxy</code> or JUnit helper classes, you will need to change the package information.</p>
</li>
<li>
<p>Most of the DSL classes were repackaged and will require updates to the package names imported.</p>
</li>
</ul>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_whats_new_in_1_9">What&#8217;s New in 1.9</h2>
<div class="sectionbody">
<div class="ulist">
<ul>
<li>
<p>Corrections to the closure variable scoping.</p>
</li>
<li>
<p>Support for configuring the server port - though, in general, this is not recommended.</p>
</li>
<li>
<p>Some added usage documentation</p>
</li>
</ul>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_whats_new_in_1_8">What&#8217;s New in 1.8</h2>
<div class="sectionbody">
<div class="ulist">
<ul>
<li>
<p>Variable scope changes - the configuration Groovy DSL closures had incorrect (or inadequate) resolution strategies specified which caused variables to be resolved incorrectly in some situations. All of the closures now use <code>DELEGATE_FIRST</code>; however, beware this may cause some issues with existing code.</p>
</li>
<li>
<p>Deprecation of the <code>Response</code> <code>content(&#8230;&#8203;)</code> methods in favor of the new <code>body(&#8230;&#8203;)</code> methods.</p>
</li>
<li>
<p>ANSI color codes were added to the match failure reports to make them a bit more readable.</p>
</li>
<li>
<p>A couple of helper methods were added to <code>ErsatzServer</code> to facilitate simple URL string building - see <code>httpUrl(String)</code> and <code>httpsUrl(String)</code>.</p>
</li>
<li>
<p>A JUnit 5 <code>Extension</code> was added to make server management simple with JUnit 5, similar to what already existed for JUnit 4.</p>
</li>
<li>
<p>Support for "chunked" responses with fixed or random delays between chunks has been added.</p>
</li>
</ul>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_getting_started">Getting Started</h2>
<div class="sectionbody">
<div class="paragraph">
<p>The <code>ersatz</code> library is available via Bintray (JCenter) and the Maven Central Repository; you can add it to your project using one of the following
methods:</p>
</div>
<div class="paragraph">
<p>For Gradle add the following to your <code>build.gradle</code> file:</p>
</div>
<div class="literalblock">
<div class="content">
<pre>testCompile 'com.stehno.ersatz:ersatz:2.0.0'</pre>
</div>
</div>
<div class="paragraph">
<p>For Maven add the code below to your <code>pom.xml</code> file:</p>
</div>
<div class="literalblock">
<div class="content">
<pre>&lt;dependency&gt;
    &lt;groupId&gt;com.stehno.ersatz&lt;/groupId&gt;
    &lt;artifactId&gt;ersatz&lt;/artifactId&gt;
    &lt;version&gt;2.0.0&lt;/version&gt;
    &lt;scope&gt;test&lt;/scope&gt;
&lt;/dependency&gt;</pre>
</div>
</div>
<div class="paragraph">
<p>You could then use Ersatz in a Spock test as follows:</p>
</div>
<div class="listingblock">
<div class="title">HelloSpec.groovy</div>
<div class="content">
<pre class="CodeRay highlight"><code data-lang="groovy"><span class="keyword">import</span> <span class="include">spock.lang.Specification</span>
<span class="keyword">import</span> <span class="include">com.stehno.ersatz.ErsatzServer</span>

<span class="type">class</span> <span class="class">HelloSpec</span> <span class="directive">extends</span> Specification {

    <span class="keyword">def</span> <span class="string"><span class="delimiter">'</span><span class="content">say hello</span><span class="delimiter">'</span></span>(){
        <span class="key">setup</span>:
        ErsatzServer ersatz = <span class="keyword">new</span> ErsatzServer()

        ersatz.expectations {
            GET(<span class="string"><span class="delimiter">'</span><span class="content">/say/hello</span><span class="delimiter">'</span></span>){
                called <span class="integer">1</span>
                query <span class="string"><span class="delimiter">'</span><span class="content">name</span><span class="delimiter">'</span></span>,<span class="string"><span class="delimiter">'</span><span class="content">Ersatz</span><span class="delimiter">'</span></span>
                responder {
                    body <span class="string"><span class="delimiter">'</span><span class="content">Hello Ersatz</span><span class="delimiter">'</span></span>,<span class="string"><span class="delimiter">'</span><span class="content">text/plain</span><span class="delimiter">'</span></span>
                }
            }
        }

        <span class="key">when</span>:
        <span class="predefined-type">String</span> result = <span class="string"><span class="delimiter">&quot;</span><span class="inline"><span class="inline-delimiter">${</span>ersatz.httpUrl<span class="inline-delimiter">}</span></span><span class="content">/say/hello?name=Ersatz</span><span class="delimiter">&quot;</span></span>.toURL().text

        <span class="key">then</span>:
        result == <span class="string"><span class="delimiter">'</span><span class="content">Hello Ersatz</span><span class="delimiter">'</span></span>

        <span class="key">and</span>:
        ersatz.verify()

        <span class="key">cleanup</span>:
        ersatz.stop()
    }
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>The configured server is expecting a single call to <code>GET /say/hello?name=Ersatz</code>. When that call is received, the server will respond with the
<code>text/plain</code> content <code>Hello Ersatz</code>. This code also verifies that the expected request was only called once (as requested) - if it was not called or
called more than once, the verification and likewise the test, would fail.</p>
</div>
<div class="paragraph">
<p>A similar test could be written in JUnit with Java 8, as follows (using the provided <code>ErsatzServerRule</code> helper class):</p>
</div>
<div class="listingblock">
<div class="title">HelloTest.java</div>
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java"><span class="keyword">import</span> <span class="include">com.stehno.ersatz.ErsatzServer</span>;
<span class="keyword">import</span> <span class="include">com.stehno.ersatz.cfg.ContentType</span>;
<span class="keyword">import</span> <span class="include">org.junit.Rule</span>;
<span class="keyword">import</span> <span class="include">org.junit.Test</span>;
<span class="keyword">import</span> <span class="include">org.junit.Before</span>;
<span class="keyword">import</span> <span class="include">okhttp3.OkHttpClient</span>;
<span class="keyword">import</span> <span class="include">okhttp3.Request</span>;

<span class="keyword">import</span> <span class="include">static</span> <span class="include">org.junit.Assert.assertEquals</span>;

<span class="directive">public</span> <span class="type">class</span> <span class="class">HelloTest</span> {

    <span class="annotation">@Rule</span>
    <span class="directive">public</span> ErsatzServerRule ersatzServer = <span class="keyword">new</span> ErsatzServerRule(<span class="local-variable">this</span>);

    <span class="directive">private</span> OkHttpClient client;

    <span class="annotation">@Before</span>
    <span class="directive">public</span> <span class="type">void</span> before() {
        client = <span class="keyword">new</span> OkHttpClient.Builder().build();
    }

    <span class="annotation">@Test</span>
    <span class="directive">public</span> sayHello(){
        ersatzServer.expectations(expectations -&gt; {
            expectations.GET(<span class="string"><span class="delimiter">&quot;</span><span class="content">/say/hello</span><span class="delimiter">&quot;</span></span>).called(<span class="integer">1</span>).query(<span class="string"><span class="delimiter">&quot;</span><span class="content">name</span><span class="delimiter">&quot;</span></span>,<span class="string"><span class="delimiter">&quot;</span><span class="content">Ersatz</span><span class="delimiter">&quot;</span></span>)
                .responder().body(<span class="string"><span class="delimiter">&quot;</span><span class="content">Hello Ersatz</span><span class="delimiter">&quot;</span></span>, ContentType.TEXT_PLAIN);
        });

        <span class="predefined-type">String</span> url = ersatzServer.getHttpUrl() + <span class="string"><span class="delimiter">&quot;</span><span class="content">/say/hello?name=Ersatz</span><span class="delimiter">&quot;</span></span>;
        okhttp3.Request request = <span class="keyword">new</span> okhttp3.Request.Builder().url(url).build();

        assertEquals(<span class="string"><span class="delimiter">&quot;</span><span class="content">Hello Ersatz</span><span class="delimiter">&quot;</span></span>, client.newCall(request).execute().body().string());
    }
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>The two testing approaches are interchangeable and equally supported. There is also a JUnit 5 extension, see <code>ErsatzServerExtension</code> for usage.</p>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_ersatz_server">Ersatz Server</h2>
<div class="sectionbody">
<div class="paragraph">
<p>The core component for the Ersatz Mock Server is the <code>com.stehno.ersatz.ErsatzServer</code> class. It is used to manage the server lifecycle as well as
provide a configuration interface.</p>
</div>
<div class="sect2">
<h3 id="_lifecycle">Lifecycle</h3>
<div class="paragraph">
<p>The lifecycle of an Ersatz server is broken down into four main states:</p>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>Configuration</p>
</li>
<li>
<p>Testing</p>
</li>
<li>
<p>Verification</p>
</li>
<li>
<p>Cleanup</p>
</li>
</ol>
</div>
<div class="paragraph">
<p>they are detailed in the following sections.</p>
</div>
<div class="sect3">
<h4 id="_configuration">Configuration</h4>
<div class="paragraph">
<p>The first lifecycle step is "configuration", where the server is instantiated, request expectations are configured and the server is started. An
Ersatz server is created by creating an instance of <code>ErsatzServer</code> with optional configuration performed by providing a <code>Closure</code> or
<code>Consumer&lt;ServerConfig&gt;</code>, both of which will be given a <code>ServerConfig</code> instance to perform configuration operations on.</p>
</div>
<div class="admonitionblock tip">
<table>
<tr>
<td class="icon">
<div class="title">Tip</div>
</td>
<td class="content">
Configuration of encoders and decoders via the global configuration mechanism are considered global and will be used as defaults across all
expectation configurations.
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>At this point there is no HTTP server running and it is ready for further configuration. Configuring the expectations on the server consists of
calling one of the following methods:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="groovy">ErsatzServer expectations(<span class="directive">final</span> Consumer&lt;Expectations&gt; expects)

ErsatzServer expectations(<span class="annotation">@DelegatesTo</span>(Expectations) <span class="directive">final</span> Closure closure)

Expectations expects()</code></pre>
</div>
</div>
<div class="paragraph">
<p>The first allows for configuration within a <code>Consumer&lt;Expectations&gt;</code> instance, which will have a prepared <code>Expectations</code> instance passed into it. This
allows for a DSL-style configuration from Java.</p>
</div>
<div class="paragraph">
<p>The second method is the entry point for the Groovy DSL configuration. The provided <code>Closure</code> will delegate to an instance of <code>Expectations</code> for
defining the configurations.</p>
</div>
<div class="paragraph">
<p>The third method is a simplified builder-style approach for single request method expectation-building.</p>
</div>
<div class="paragraph">
<p>Once the request expectations are configured, the server will automatically start unless <code>autoStart false</code> is configured. If auto-start is disabled,
the server must be started by calling the <code>ErsatzServer::start()</code> method. This will start the underlying embedded HTTP server and register the
configured expectations. If the server is not started, you will receive connection errors during testing.</p>
</div>
<div class="paragraph">
<p>Further details about configuration options and examples can be found in the Expectation Configuration section of this user guide.</p>
</div>
</div>
<div class="sect3">
<h4 id="_testing">Testing</h4>
<div class="paragraph">
<p>After configuration, the server is running and ready for test interactions. Any HTTP client can make HTTP requests against the server to retrieve
configured responses. The <code>ErsatzServer</code> object provides helper methods to retrieve the server port and URL, with <code>getHttpPort()</code> and <code>getHttpUrl()</code>
respectively (there are also versions for HTTPS, <code>getHttpsPort()</code> and <code>getHttpsUrl()</code> respectively). Note that the server will <em>always</em> be started on
an ephemeral port so that a random one will be chosen to avoid collisions.</p>
</div>
</div>
<div class="sect3">
<h4 id="_verification">Verification</h4>
<div class="paragraph">
<p>Once testing has been performed, it may be desirable to verify whether or not the expected number of request calls were matched. The <code>Expectations</code>
interface provides a <code>called</code> method to add call count verification per configured request, something like:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="groovy">POST(<span class="string"><span class="delimiter">'</span><span class="content">/user</span><span class="delimiter">'</span></span>).body(content, <span class="string"><span class="delimiter">'</span><span class="content">application/json</span><span class="delimiter">'</span></span>).called(<span class="integer">1</span>)
    .responds().body(successContent, <span class="string"><span class="delimiter">'</span><span class="content">application/json</span><span class="delimiter">'</span></span>)</code></pre>
</div>
</div>
<div class="paragraph">
<p>This would match a <code>POST</code> request to <code>/user</code> with request body content matching the provided content and expect that matched call only once. When
<code>verify()</code> is called it will return <code>true</code> if this request has only been matched once, otherwise it will return <code>false</code>. This allows testing to
ensure that requests are not made more often than expected or at unexpected times.</p>
</div>
<div class="paragraph">
<p>Verification is optional and may simply be skipped if not needed, though generally if you specify request <code>called</code> counts, you <em>should</em> end your
test with a call to <code>verify</code> to ensure that the calls were made.</p>
</div>
</div>
<div class="sect3">
<h4 id="_cleanup">Cleanup</h4>
<div class="paragraph">
<p>After testing and verification, when all test interactions have completed, the server must be stopped in order to free up resources. This is done by
calling the <code>stop()</code> or <code>close()</code> method on the <code>ErsatzServer</code> instance. This is an important step, as odd test failures have been noticed during
multi-test runs if the server is not properly stopped. In Spock you can create the <code>ErsatzServer</code> with the <code>@AutoCleanup</code> annotation to aid in
proper management:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="groovy"><span class="annotation">@AutoCleanup</span> ErsatzServer server = <span class="keyword">new</span> ErsatzServer()</code></pre>
</div>
</div>
<div class="paragraph">
<p>likewise, in a JUnit test (Groovy or Java) you may use the <code>ErsatzServerRule</code> class (for JUnit 4), which is a
<a href="https://github.com/junit-team/junit4/wiki/Rules">JUnit Rule</a> implementation delegating to an <code>ErsatzServer</code>; it automatically calls the <code>stop()</code> method
after each test method, though the <code>start()</code> method must still be called manually (if not in auto-start mode).</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java"><span class="annotation">@Rule</span> <span class="directive">public</span> ErsatzServerRule ersatzServer = <span class="keyword">new</span> ErsatzServerRule(<span class="local-variable">this</span>);

<span class="annotation">@Test</span> <span class="directive">public</span> <span class="type">void</span> hello(){
    ersatzServer.expectations(expectations -&gt; {
        expectations.GET(<span class="string"><span class="delimiter">&quot;</span><span class="content">/testing</span><span class="delimiter">&quot;</span></span>).responds().body(<span class="string"><span class="delimiter">&quot;</span><span class="content">ok</span><span class="delimiter">&quot;</span></span>);
    }).start();

    okhttp3.Response response = <span class="keyword">new</span> OkHttpClient().newCall(
        <span class="keyword">new</span> Request.Builder().url(ersatzServer.httpUrl(<span class="string"><span class="delimiter">&quot;</span><span class="content">/testing</span><span class="delimiter">&quot;</span></span>)).build()
    ).execute();

    assertEquals(<span class="integer">200</span>, response.code());
    assertEquals(<span class="string"><span class="delimiter">&quot;</span><span class="content">ok</span><span class="delimiter">&quot;</span></span>, response.body().string());
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>The server may be restarted after it has been stopped between tests.</p>
</div>
<div class="paragraph">
<p>Also, there is an <code>Extension</code> for JUnit 5 providing a similar interface:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java"><span class="annotation">@ExtendWith</span>(ErsatzServerExtension.class)
<span class="type">class</span> <span class="class">Junit5Test</span> {

    <span class="directive">private</span> ErsatzServer server;
    <span class="directive">private</span> <span class="directive">final</span> HttpClient http = <span class="keyword">new</span> HttpClient();

    <span class="annotation">@Test</span> <span class="annotation">@DisplayName</span>(<span class="string"><span class="delimiter">&quot;</span><span class="content">Testing JUnit 5 Support</span><span class="delimiter">&quot;</span></span>)
    <span class="type">void</span> testing_junit5_support() <span class="directive">throws</span> <span class="exception">IOException</span> {
        server.expectations(expects -&gt; {
            expects.GET(<span class="string"><span class="delimiter">&quot;</span><span class="content">/junit5</span><span class="delimiter">&quot;</span></span>).responds().code(<span class="integer">200</span>).body(<span class="string"><span class="delimiter">&quot;</span><span class="content">Hi</span><span class="delimiter">&quot;</span></span>, TEXT_PLAIN);
        });

        assertThat(http.get(server.httpUrl(<span class="string"><span class="delimiter">&quot;</span><span class="content">/junit5</span><span class="delimiter">&quot;</span></span>)).body().string(), equalTo(<span class="string"><span class="delimiter">&quot;</span><span class="content">Hi</span><span class="delimiter">&quot;</span></span>));
    }
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>After each test, the server will be stopped and the expectations cleared out.</p>
</div>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_configuration_2">Configuration</h2>
<div class="sectionbody">
<div class="paragraph">
<p>The <code>ServerConfig</code> interface provides the configuration methods for the server, both in the constructor and on the server instance itself. In most
cases, there is no difference in functionality (save where noted).</p>
</div>
<div class="sect2">
<h3 id="_authentication">Authentication</h3>
<div class="paragraph">
<p>The Ersatz server supports two forms of built-in authentication, BASIC and DIGEST. Both authentication methods are exclusive and global, meaning that
they cannot be configured together on the same server and that when configured, they apply to all end points configured on the server.</p>
</div>
<div class="paragraph">
<p>If more fine-grained control of which URLs are authenticated is desired, you will need to configured multiple Ersatz Servers for the different
configuration sets.</p>
</div>
<div class="sect3">
<h4 id="_basic_authentication">BASIC Authentication</h4>
<div class="paragraph">
<p><a href="https://en.wikipedia.org/wiki/Basic_access_authentication">HTTP BASIC Authentication</a> is supported by applying the <code>basic</code> <code>authentication</code>
configuration to the server.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="groovy"><span class="keyword">def</span> ersatz = <span class="keyword">new</span> ErsatzServer({
    authentication {
        basic <span class="string"><span class="delimiter">'</span><span class="content">admin</span><span class="delimiter">'</span></span>, <span class="string"><span class="delimiter">'</span><span class="content">my-password</span><span class="delimiter">'</span></span>
    }
})</code></pre>
</div>
</div>
<div class="paragraph">
<p>This configuration causes the configured request expectations to require BASIC authentication (username and password) as part of their matching.</p>
</div>
</div>
<div class="sect3">
<h4 id="_digest_authentication">DIGEST Authentication</h4>
<div class="paragraph">
<p><a href="https://en.wikipedia.org/wiki/Digest_access_authentication">HTTP DIGEST Authentication</a> is supported by applying the <code>digest</code> <code>authentication</code> to the
server.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="groovy"><span class="keyword">def</span> ersatz = <span class="keyword">new</span> ErsatzServer({
    authentication {
        digest <span class="string"><span class="delimiter">'</span><span class="content">guest</span><span class="delimiter">'</span></span>, <span class="string"><span class="delimiter">'</span><span class="content">other-password</span><span class="delimiter">'</span></span>
    }
})</code></pre>
</div>
</div>
<div class="paragraph">
<p>This configuration causes the configured request expectations to require DIGEST authentication (username and password) as part of their matching.</p>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_auto_start">Auto-Start</h3>
<div class="paragraph">
<p>An auto-start feature is provided to allow the server to start automatically once expectations have been applied (e.g. after the <code>expectations()</code>
method is called. This can simplify the code by removing explicit calls to the <code>start()</code> method. This auto-start feature may be disabled using:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="groovy"><span class="keyword">def</span> ersatz = <span class="keyword">new</span> ErsatzServer({
    autoStart <span class="predefined-constant">false</span>
})</code></pre>
</div>
</div>
<div class="paragraph">
<p>This toggling capability allows for an external configuration source to determine whether or not auto-start is enabled. An instance of <code>ErsatzServer</code>
may be started multiple times without any effect, only the first call to <code>start()</code> will take effect, though any new expectations will be applied.</p>
</div>
</div>
<div class="sect2">
<h3 id="_content_translation">Content Translation</h3>
<div class="paragraph">
<p>The translation of request/response body content between types is performed using:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Decoders to convert incoming request body content into an expected comparison type</p>
</li>
<li>
<p>Encoders to convert outgoing response body configuration types into HTTP byte[] data</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>The request/response content body decoders/encoders are configured in a layered manner so that they may be configured and shared across multiple
instances without copying the configuration.</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Encoders/Decoders configured in the <code>ErsatzServer</code> constructor are considered "global" and will be used if no overriding handlers are configured.</p>
</li>
<li>
<p>Encoders/Decoders configured in the request/response itself are considered "local" and will override any other configured handlers</p>
</li>
<li>
<p>Other configurations are applied in a layered order based on where they are applied in the configuration DSL - the handlers are maintained as separate isolated instances and the actual handler is resolved at runtime.</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>The specifics of Decoders and Encoders are discussed in the following sections.</p>
</div>
<div class="sect3">
<h4 id="_decoders">Decoders</h4>
<div class="paragraph">
<p>The Decoders are used to convert request content bytes into a specified configuration type for matching in Ersatz. Decoders are implemented as a
<code>BiFunction&lt;byte[],DecodingContext, Object&gt;', which takes a `byte</code> array of request content and converts it to a specific <code>Object</code> type. The
<code>DecodingContext</code> is used to provide additional information about the request being decoded (e.g. <code>contentLength</code>, <code>contentType</code>, <code>characterEncoding</code>,
and a reference to the <code>decoderChain</code>).</p>
</div>
<div class="paragraph">
<p>The various configuration levels have the same method signature:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="groovy">ServerConfig decoder(<span class="directive">final</span> <span class="predefined-type">String</span> contentType, <span class="directive">final</span> BiFunction&lt;<span class="type">byte</span><span class="type">[]</span>, DecodingContext, <span class="predefined-type">Object</span>&gt; decoder)</code></pre>
</div>
</div>
<div class="paragraph">
<p>As an example, the default JSON decoder (provided in <code>com.stehno.ersatz.Decoders</code>) looks like the following code:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="groovy"><span class="directive">static</span> <span class="directive">final</span> BiFunction&lt;<span class="type">byte</span><span class="type">[]</span>, DecodingContext, <span class="predefined-type">Object</span>&gt; parseJson = { <span class="type">byte</span><span class="type">[]</span> content, DecodingContext ctx -&gt;
    <span class="keyword">new</span> JsonSlurper().parse(content ?: <span class="string"><span class="delimiter">'</span><span class="content">{}</span><span class="delimiter">'</span></span>).bytes
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>Likewise, in Groovy, you can provide a <code>Closure</code> instead of a <code>BiFunction</code>, as long as it provides the same expected inputs and outputs:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="groovy"><span class="keyword">def</span> server = <span class="keyword">new</span> ErsatzServer({
    decoder(<span class="string"><span class="delimiter">'</span><span class="content">application/json</span><span class="delimiter">'</span></span>){ content, context -&gt;
        <span class="keyword">new</span> JsonSlurper().parse(content ?: <span class="string"><span class="delimiter">'</span><span class="content">{}</span><span class="delimiter">'</span></span>.bytes)
    }
})</code></pre>
</div>
</div>
<div class="paragraph">
<p>The two approaches are functionally the same.</p>
</div>
</div>
<div class="sect3">
<h4 id="_encoders">Encoders</h4>
<div class="paragraph">
<p>The Encoders are used to convert response configuration data types into the outbound request content string. They are implemented as a
<code>Function&lt;Object,byte[]&gt;</code> with the input <code>Object</code> being the configuration object being converted, and the <code>byte[]</code> is the return type.</p>
</div>
<div class="paragraph">
<p>The various configuration levels have the same method signature:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="groovy">ServerConfig encoder(<span class="predefined-type">String</span> contentType, <span class="predefined-type">Class</span> objectType, Function&lt;<span class="predefined-type">Object</span>, <span class="type">byte</span><span class="type">[]</span>&gt; encoder)</code></pre>
</div>
</div>
<div class="paragraph">
<p>The <code>contentType</code> is the response content type to be encoded and the <code>objectType</code> is the type of configuration object to be encoded - this allows for
the same content-type to have different encoders for different configuration object types.</p>
</div>
<div class="paragraph">
<p>A simple example of an encoder would be the default JSON encoder (provided in the <code>com.stehno.ersatz.encdec.Encoders</code> class):</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="groovy"><span class="directive">static</span> <span class="directive">final</span> Function&lt;<span class="predefined-type">Object</span>, <span class="type">byte</span><span class="type">[]</span>&gt; json = { obj -&gt; (obj != <span class="predefined-constant">null</span> ? toJson(obj) : <span class="string"><span class="delimiter">'</span><span class="content">{}</span><span class="delimiter">'</span></span>).bytes }</code></pre>
</div>
</div>
<div class="paragraph">
<p>You may also configure encoders as a Groovy <code>Closure</code> with the same parameters:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="groovy"><span class="keyword">def</span> server = <span class="keyword">new</span> ErsatzServer({
    encoder(<span class="string"><span class="delimiter">'</span><span class="content">application/json</span><span class="delimiter">'</span></span>,<span class="predefined-type">Map</span>){ obj-&gt;
        (bj != <span class="predefined-constant">null</span> ? toJson(obj) : <span class="string"><span class="delimiter">'</span><span class="content">{}</span><span class="delimiter">'</span></span>).bytes
    }
})</code></pre>
</div>
</div>
<div class="paragraph">
<p>The two approaches are functionally equivalent.</p>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_expectations">Expectations</h3>
<div class="paragraph">
<p>Request expectations are the core of the Ersatz server functionality; conceptually, they are HTTP server request routes which are used to match an
incoming HTTP request with a request handler or to respond with a status of 404, if no matching request was configured. The expectations are
configured on an instance of the <code>Expectations</code> interface, which provides multiple configuration methods for each of the supported HTTP request
methods (GET, HEAD, POST, PUT, DELETE, PATCH, OPTIONS, and TRACE), with the method name corresponding to the HTTP request method name. The four
general types of methods are:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>One taking a <code>String path</code> returning an instance of the <code>Request</code> interface</p>
</li>
<li>
<p>One taking a <code>String path</code> and a <code>Consumer&lt;Request&gt;</code> returning an instance of the <code>Request</code> interface</p>
</li>
<li>
<p>One taking a <code>String path</code> and a Groovy <code>Closure</code> returning an instance of the <code>Request</code> interface</p>
</li>
<li>
<p>All of the above with the <code>String path</code> replaced by a Hamcrest <code>Matcher&lt;String&gt;</code> for matching the path</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>The <code>Consumer&lt;Request&gt;</code> methods will provide a <code>Consumer&lt;Request&gt;</code> implementation to perform the configuration on a <code>Request</code> instance passed into
the consumer function. The <code>path</code> strings in the verb methods may be called with <code><strong></code> as a wildcard value - this will match any request with that
request method (e.g. <code>GET('</strong>')</code> would match any GET request while <code>any('*')</code> could be used to match <em>ANY</em> request made on the server).</p>
</div>
<div class="paragraph">
<p>The <code>Closure</code> support is similar to that of the consumer; however, this is a Groovy DSL approach where the <code>Closure</code> operations are delegated onto the
a <code>Request</code> instance in order to configure the request.</p>
</div>
<div class="paragraph">
<p>All of the expectation method types return an instance of the request being configured (<code>Request</code> or <code>RequestWithContent</code>).</p>
</div>
<div class="paragraph">
<p>There is also an <code>ANY</code> request method matcher configuration which will match a request regardless of the request method, if it matches the rest of the
configured criteria.</p>
</div>
<div class="paragraph">
<p>The primary role of expectations is to provide a means of matching incoming requests in order to respond in a desired and repeatable manner. They are
used to build up matching rules based on request properties to help filter and route the incoming request properly. <a href="http://hamcrest.org/">Hamcrest</a>
Matcher support allows for flexible request matching based on various request properties.</p>
</div>
<div class="paragraph">
<p>The configuration interfaces support three main approaches to configuration, a chained builder approach, such as:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="groovy">HEAD(<span class="string"><span class="delimiter">'</span><span class="content">/foo</span><span class="delimiter">'</span></span>)
    .query(<span class="string"><span class="delimiter">'</span><span class="content">a</span><span class="delimiter">'</span></span>,<span class="string"><span class="delimiter">'</span><span class="content">42</span><span class="delimiter">'</span></span>)
    .cookie(<span class="string"><span class="delimiter">'</span><span class="content">stamp</span><span class="delimiter">'</span></span>,<span class="string"><span class="delimiter">'</span><span class="content">1234</span><span class="delimiter">'</span></span>)
    .respond().header(<span class="string"><span class="delimiter">'</span><span class="content">ok</span><span class="delimiter">'</span></span>,<span class="string"><span class="delimiter">'</span><span class="content">true</span><span class="delimiter">'</span></span>)</code></pre>
</div>
</div>
<div class="paragraph">
<p>where the code is a chain of builder-style method calls used to wire up the request expectation. The second method is available to users of the Groovy
language, the Groovy DSL approach would code the same thing as:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="groovy">HEAD(<span class="string"><span class="delimiter">'</span><span class="content">/foo</span><span class="delimiter">'</span></span>){
    query <span class="string"><span class="delimiter">'</span><span class="content">a</span><span class="delimiter">'</span></span>, <span class="string"><span class="delimiter">'</span><span class="content">42</span><span class="delimiter">'</span></span>
    cookie <span class="string"><span class="delimiter">'</span><span class="content">stamp</span><span class="delimiter">'</span></span>, <span class="string"><span class="delimiter">'</span><span class="content">1234</span><span class="delimiter">'</span></span>
    responder {
        header <span class="string"><span class="delimiter">'</span><span class="content">ok</span><span class="delimiter">'</span></span>, <span class="string"><span class="delimiter">&quot;</span><span class="content">true</span><span class="delimiter">&quot;</span></span>
    }
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>which can be more expressive, especially when creating more complicated expectations. A third approach is a Java-based approach more similar to the
Groovy DSL, using the <code>Consumer&lt;?&gt;</code> methods of the interface, this would yield:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java">HEAD(<span class="string"><span class="delimiter">'</span><span class="content">/foo</span><span class="delimiter">'</span></span>, req -&gt; {
    req.query(<span class="string"><span class="delimiter">&quot;</span><span class="content">a</span><span class="delimiter">&quot;</span></span>, <span class="string"><span class="delimiter">&quot;</span><span class="content">42</span><span class="delimiter">&quot;</span></span>)
    req.cookie(<span class="string"><span class="delimiter">&quot;</span><span class="content">stamp</span><span class="delimiter">&quot;</span></span>, <span class="string"><span class="delimiter">&quot;</span><span class="content">1234</span><span class="delimiter">&quot;</span></span>)
    req.responder( res-&gt; {
        res.header(<span class="string"><span class="delimiter">&quot;</span><span class="content">ok</span><span class="delimiter">&quot;</span></span>, <span class="string"><span class="delimiter">&quot;</span><span class="content">true</span><span class="delimiter">&quot;</span></span>)
    })
})</code></pre>
</div>
</div>
<div class="paragraph">
<p>Any of the three may be used in conjunction with each other to build up expectations in the desired manner.</p>
</div>
<div class="admonitionblock tip">
<table>
<tr>
<td class="icon">
<div class="title">Tip</div>
</td>
<td class="content">
The matching of expectations is perform in the order the expectations are configured, such that if an incoming request could be matched by more
than one expectation, the first one configured will be applied.
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>Request expectations may be configured to respond differently based on how many times a request is matched, for example, if you wanted the first
request of <code>GET /something</code> to respond with <code>Hello</code> and second (and all subsequent) request of the same URL to respond with <code>Goodbye</code>, you would
configure multiple responses, in order:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="groovy">GET(<span class="string"><span class="delimiter">'</span><span class="content">/something</span><span class="delimiter">'</span></span>){
    responder {
        content <span class="string"><span class="delimiter">'</span><span class="content">Hello</span><span class="delimiter">'</span></span>
    }
    responder {
        content <span class="string"><span class="delimiter">'</span><span class="content">Goodbye</span><span class="delimiter">'</span></span>
    }
    called <span class="integer">2</span>
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>Adding the <code>called</code> configuration adds the extra safety of ensuring that if the request is called more than our expected two times, the verification
will fail (and with that, the test).</p>
</div>
<div class="paragraph">
<p>Expectations may be cleared from the server using the <code>clearExpectations()</code> method. This is useful when you need to redefine expectations for one
test only, but all of the others have a common set of expectations.</p>
</div>
<div class="sect3">
<h4 id="_request_methods">Request Methods</h4>
<div class="paragraph">
<p>The Ersatz server supports all of the standard HTTP request headers along with a few non-standard ones. The table below denotes the supported methods
their contents.</p>
</div>
<table class="tableblock frame-all grid-all stretch">
<colgroup>
<col style="width: 25%;">
<col style="width: 25%;">
<col style="width: 25%;">
<col style="width: 25%;">
</colgroup>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">Method</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Request Body</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Response Body</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Reference</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">GET</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">N</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Y</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><a href="https://www.w3.org/Protocols/rfc2616/rfc2616-sec9.html#sec9.3">RFC2616 Sec 9.3</a></p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">HEAD</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">N</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">N</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><a href="https://www.w3.org/Protocols/rfc2616/rfc2616-sec9.html#sec9.4">RFC2616 Sec 9.4</a></p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">OPTIONS</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">N</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">N</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><a href="https://www.w3.org/Protocols/rfc2616/rfc2616-sec9.html#sec9.2">RFC2616 Sec 9.2</a></p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">POST</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Y</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Y</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><a href="https://www.w3.org/Protocols/rfc2616/rfc2616-sec9.html#sec9.5">RFC2616 Sec 9.5</a></p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">PUT</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Y</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">N</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><a href="https://www.w3.org/Protocols/rfc2616/rfc2616-sec9.html#sec9.6">RFC2616 Sec 9.6</a></p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">DELETE</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">N</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">N</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><a href="https://www.w3.org/Protocols/rfc2616/rfc2616-sec9.html#sec9.7">RFC2616 Sec 9.7</a></p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">PATCH</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Y</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">N</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><a href="https://tools.ietf.org/html/rfc5789">RFC5789</a></p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">TRACE</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">N</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Y</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><a href="https://www.w3.org/Protocols/rfc2616/rfc2616-sec9.html#sec9.8">RFC2616 Sec 9.8</a></p></td>
</tr>
</tbody>
</table>
<div class="paragraph">
<p>The following sections describe how each method is supported with a simple example.</p>
</div>
<div class="paragraph">
<p>While Ersatz does constrain the content of the request and response based on the request method, it is generally up to the mocker to provide the
desired and/or appropriate responses (including most headers). This implementation leniency is intentional, and is meant to allow for endpoint
implementations that do not necessarily follow the published specification, but likewise still need to be tested as they really exist rather than how
they <em>should</em> exist.</p>
</div>
<div class="sect4">
<h5 id="_head">HEAD</h5>
<div class="paragraph">
<p>A <code>HEAD</code> request is used to retrieve the headers for a URL, basically a <code>GET</code> request without any response body. An Ersatz mocking example would be:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="groovy">ersatzServer.expectations {
    HEAD(<span class="string"><span class="delimiter">'</span><span class="content">/something</span><span class="delimiter">'</span></span>).responds().header(<span class="string"><span class="delimiter">'</span><span class="content">X-Alpha</span><span class="delimiter">'</span></span>,<span class="string"><span class="delimiter">'</span><span class="content">Interesting-data</span><span class="delimiter">'</span></span>).code(<span class="integer">200</span>)
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>which would respond to <code>HEAD /something</code> with an empty response and the response header <code>X-Alpha</code> with the specified value.</p>
</div>
</div>
<div class="sect4">
<h5 id="_get">GET</h5>
<div class="paragraph">
<p>The <code>GET</code> request is a common HTTP request, and what browsers do by default. It has no request body, but it does have response content. You mock <code>GET</code> requests
using the <code>get()</code> methods, as follows:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="groovy">ersatzServer.expectations {
    GET(<span class="string"><span class="delimiter">'</span><span class="content">/something</span><span class="delimiter">'</span></span>).responds().body(<span class="string"><span class="delimiter">'</span><span class="content">This is INTERESTING!</span><span class="delimiter">'</span></span>, <span class="string"><span class="delimiter">'</span><span class="content">text/plain</span><span class="delimiter">'</span></span>).code(<span class="integer">200</span>)
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>In a RESTful interface, a <code>GET</code> request is usually used to "read" or retrieve a resource representation.</p>
</div>
</div>
<div class="sect4">
<h5 id="_options">OPTIONS</h5>
<div class="paragraph">
<p>The <code>OPTIONS</code> HTTP request method is similar to an <code>HEAD</code> request, having no request or response body. The primary response value in an <code>OPTIONS</code> request
is the content of the <code>Allow</code> response header, which will contain a comma-separated list of the request methods supported by the server. The request
may be made against a specific URL path, or against <code>*</code> in order to determine what methods are available to the entire server.</p>
</div>
<div class="paragraph">
<p>In order to mock out an <code>OPTIONS</code> request, you will want to respond with a provided <code>Allow</code> header. This may be done using the
<code>Response.allows(HttpMethod&#8230;&#8203;)</code> method in the responder. An example would be something like:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="groovy">ersatzServer.expectations {
    OPTIONS(<span class="string"><span class="delimiter">'</span><span class="content">/options</span><span class="delimiter">'</span></span>).responds().allows(GET, POST).code(<span class="integer">200</span>)
    OPTIONS(<span class="string"><span class="delimiter">'</span><span class="content">/*</span><span class="delimiter">'</span></span>).responds().allows(DELETE, GET, OPTIONS).code(<span class="integer">200</span>)
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>This will provide different allowed options for <code>/options</code> and for the "entire server" (<code>*</code>). You can also specify the <code>Allow</code> header as a standard response header.</p>
</div>
<div class="paragraph">
<p>Note that not all client and servers will support the <code>OPTIONS</code> request method.</p>
</div>
</div>
<div class="sect4">
<h5 id="_post">POST</h5>
<div class="paragraph">
<p>The <code>POST</code> request is often used to send browser form data to a backend server. It can have both request and response content.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="groovy">ersatzServer.expectations {
    POST(<span class="string"><span class="delimiter">'</span><span class="content">/form</span><span class="delimiter">'</span></span>){
        body([<span class="key">first</span>:<span class="string"><span class="delimiter">'</span><span class="content">John</span><span class="delimiter">'</span></span>, <span class="key">last</span>:<span class="string"><span class="delimiter">'</span><span class="content">Doe</span><span class="delimiter">'</span></span>], APPLICATION_URLENCODED)
        responder {
            body(<span class="string"><span class="delimiter">'</span><span class="content">{ status:&quot;saved&quot; }</span><span class="delimiter">'</span></span>, APPLICATION_JSON)
        }
    }
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>In a RESTful interface, the <code>POST</code> method is generally used to "create" new resources.</p>
</div>
</div>
<div class="sect4">
<h5 id="_put">PUT</h5>
<div class="paragraph">
<p>A <code>PUT</code> request is similar to a <code>POST</code> except that while there is request content, there is no response body content.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="groovy">ersatzServer.expectations {
    PUT(<span class="string"><span class="delimiter">'</span><span class="content">/form</span><span class="delimiter">'</span></span>){
        query(<span class="string"><span class="delimiter">'</span><span class="content">id</span><span class="delimiter">'</span></span>,<span class="string"><span class="delimiter">'</span><span class="content">1234</span><span class="delimiter">'</span></span>)
        body([<span class="key">middle</span>:<span class="string"><span class="delimiter">'</span><span class="content">Q</span><span class="delimiter">'</span></span>], APPLICATION_URLENCODED)
        responder {
            code(<span class="integer">200</span>)
        }
    }
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>In a RESTful interface, a <code>PUT</code> request if most often used as an "update" operation.</p>
</div>
</div>
<div class="sect4">
<h5 id="_delete">DELETE</h5>
<div class="paragraph">
<p>A <code>DELETE</code> request has not request or response content. It would look something like:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="groovy">ersatzServer.expectations {
    DELETE(<span class="string"><span class="delimiter">'</span><span class="content">/user</span><span class="delimiter">'</span></span>).query(<span class="string"><span class="delimiter">'</span><span class="content">id</span><span class="delimiter">'</span></span>,<span class="string"><span class="delimiter">'</span><span class="content">1234</span><span class="delimiter">'</span></span>).responds().code(<span class="integer">200</span>)
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>In a RESTful interface, a <code>DELETE</code> request may be used as a "delete" operation.</p>
</div>
</div>
<div class="sect4">
<h5 id="_patch">PATCH</h5>
<div class="paragraph">
<p>The <code>PATCH</code> request method creates a request that can have body content; however, the response will have no content.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="groovy">ersatzServer.expectations {
    PATCH(<span class="string"><span class="delimiter">'</span><span class="content">/user</span><span class="delimiter">'</span></span>){
        query(<span class="string"><span class="delimiter">'</span><span class="content">id</span><span class="delimiter">'</span></span>,<span class="string"><span class="delimiter">'</span><span class="content">1234</span><span class="delimiter">'</span></span>)
        body(<span class="string"><span class="delimiter">'</span><span class="content">{ &quot;middle&quot;:&quot;Q&quot;}</span><span class="delimiter">'</span></span>, APPLICATION_JSON)
        responder {
            code(<span class="integer">200</span>)
        }
    }
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>In a RESTful interface, a <code>PATCH</code> request may be used as a "modify" operation for an existing resource.</p>
</div>
</div>
<div class="sect4">
<h5 id="_trace">TRACE</h5>
<div class="paragraph">
<p>The <code>TRACE</code> method is generally meant for debugging and diagnostics. The request will have no request content; however, if the request is valid,
the response will contain the entire request message in the entity-body, with a Content-Type of <code>message/http</code>. With that in mind, the <code>TRACE</code>
method is implemented a bit differently than the other HTTP methods. It&#8217;s not available for mocking, but it will provide an echo of the request as
it is supposed to. For example the following request (raw):</p>
</div>
<div class="listingblock">
<div class="content">
<pre>TRACE / HTTP/1.1
Host: www.something.com</pre>
</div>
</div>
<div class="paragraph">
<p>would respond with something like the following response (raw):</p>
</div>
<div class="listingblock">
<div class="content">
<pre>HTTP/1.1 200 OK
Server: Microsoft-IIS/5.0
Date: Tue, 31 Oct 2006 08:01:48 GMT
Connection: close
Content-Type: message/http
Content-Length: 39

TRACE / HTTP/1.1
Host: www.something.com</pre>
</div>
</div>
<div class="paragraph">
<p>Since this functionality is already designed for diagnostics purposes, it was decided that it would be best to simply implement and support the
request method rather than allow it to be mocked.</p>
</div>
<div class="paragraph">
<p>Making a <code>TRACE</code> request to Ersatz looks like the following:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="groovy">ersatzServer.start()

<span class="predefined-type">URL</span> url = <span class="keyword">new</span> <span class="predefined-type">URL</span>(<span class="string"><span class="delimiter">&quot;</span><span class="inline"><span class="inline-delimiter">${</span>ersatzServer.httpUrl<span class="inline-delimiter">}</span></span><span class="content">/info?data=foo+bar</span><span class="delimiter">&quot;</span></span>)
<span class="predefined-type">HttpURLConnection</span> connection = url.openConnection() <span class="keyword">as</span> <span class="predefined-type">HttpURLConnection</span>
connection.requestMethod = <span class="string"><span class="delimiter">'</span><span class="content">TRACE</span><span class="delimiter">'</span></span>

<span class="keyword">assert</span> connection.contentType == MESSAGE_HTTP.value
<span class="keyword">assert</span> connection.responseCode == <span class="integer">200</span>

<span class="keyword">assert</span> connection.inputStream.text.readLines()*.trim() == <span class="string"><span class="delimiter">&quot;&quot;&quot;</span><span class="content">TRACE /info?data=foo+barHTTP/1.1
    Accept: text/html, image/gif, image/jpeg, *; q=.2, */*; q=.2
    Connection: keep-alive
    User-Agent: Java/1.9.0.1_121
    Host: localhost:</span><span class="inline"><span class="inline-delimiter">${</span>ersatzServer.httpPort<span class="inline-delimiter">}</span></span><span class="content">
</span><span class="delimiter">&quot;&quot;&quot;</span></span>.readLines()*.trim()</code></pre>
</div>
</div>
<div class="paragraph">
<p>The explicit <code>start()</code> call is required since there are no expectations specified (auto-start wont fire). The <code>HttpUrlConnection</code> is used to make the
request, and it can be seen that the response content is the same as the original request content.</p>
</div>
<div class="paragraph">
<p>The <code>TRACE</code> method is supported using the built-in <code>HttpTraceHandler</code> provided by the embedded <a href="http://undertow.io">Undertow</a> server.</p>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<div class="title">Note</div>
</td>
<td class="content">
At some point, if there are valid use cases for allowing mocks of <code>TRACE</code> it could be supported. Feel free to
<a href="https://github.com/cjstehno/ersatz/issues/new">create an Issue ticket</a> describing your use case and it will be addressed.
</td>
</tr>
</table>
</div>
</div>
</div>
<div class="sect3">
<h4 id="_web_sockets">Web Sockets</h4>
<div class="paragraph">
<p>The simulation of sending and receiving web socket messages is supported - this support is experimental, so feel free submit any issues or feature
requests.</p>
</div>
<div class="paragraph">
<p>To initialize the web service support, a <code>ws</code> expectation is configured on the desired web socket path:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="grooy">ersatz.expectations {
    ws('/socks')
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>Simply providing this configuration will expect at least one connection to the specified web socket path. Expectations for messages received by the
web socket connection may be configured using the <code>receive(&#8230;&#8203;)</code> configuration methods:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="grooy">ersatz.expectations {
    ws('/socks'){
        receive 'hello', WsMessageType.TEXT
    }
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>which will expect that the web socket client will connect to the <code>/socks</code> path and send a text message with "hello" as the message body.</p>
</div>
<div class="sect4">
<h5 id="_reactions">Reactions</h5>
<div class="paragraph">
<p>Reactions may be configured as a message that is sent when the specified message is received by the server:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="grooy">ersatz.expectations {
    ws('/socks'){
        receive {
            payload 'hello'
            messageType WsMessageType.TEXT
            reaction 'goodbye', WsMessageText.TEXT
        }
    }
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>Upon receiving the "hello" message, the server will send the "goodbye" message back to the client on the same socket.</p>
</div>
</div>
<div class="sect4">
<h5 id="_message_push">Message Push</h5>
<div class="paragraph">
<p>Message may also be sent upon connecting to the web socket server, using the <code>send(&#8230;&#8203;)</code> configurations:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="grooy">ersatz.expectations {
    ws('/socks'){
        send 'connected', WsMessageType.TEXT
    }
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>which will send the "connected" message once the <code>/socks</code> connection is initialized.</p>
</div>
</div>
<div class="sect4">
<h5 id="_verification_2">Verification</h5>
<div class="paragraph">
<p>When web sockets are in use, the <code>verify(&#8230;&#8203;)</code> method blocks until the expectations have been resolved. A timeout (and unit) parameter is available on
the <code>verify</code> method so that a failed verification can fail-out in a timely manner, while still waiting for messages that are not coming.</p>
</div>
<div class="admonitionblock tip">
<table>
<tr>
<td class="icon">
<div class="title">Tip</div>
</td>
<td class="content">
The message communication is asynchronous, therefore messages captured by the client should consider that they may arrive out of order or after verification has occurred.
</td>
</tr>
</table>
</div>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_request_matching">Request Matching</h3>
<div class="paragraph">
<p>When a request comes into the server an attempt is made to match it against the configured request expectations. When a match is found, the configured
response it returned to the client; however, when no expectation matches the request a 404 response will be returned and a mismatch report will be
written to the logs, an example is shown below:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="text"># Unmatched Request

HTTP GET /alpha/foo ? selected=[one, two], id=[1002]
Headers:
    - alpha: [bravo-1, bravo-2]
    - charlie: [delta]
    - Content-Type: [text/plain]
Cookies:
    - ident (null, null): asdfasdfasdf
Character-Encoding: UTF-8
Content-type: text/plain
Content-Length: 1234
Content:
    [84, 104, 105, 115, 32, 105, 115, 32, 115, 111, 109, 101, 32, 116, 101, 120, 116, 32, 99, 111, 110, 116, 101, 110, 116]

# Expectations

Expectation 0 (2 matchers):
    X HTTP method matches &lt;POST&gt;
    ✓ Path matches &quot;/alpha/foo&quot;
    (2 matchers: 1 matched, 1 failed)

Expectation 1 (3 matchers):
    X HTTP method matches &lt;PUT&gt;
    X Path matches a string starting with &quot;/alpha/bar&quot;
    X Protocol matches equalToIgnoringCase(&quot;HTTPS&quot;)
    (3 matchers: 0 matched, 3 failed)</code></pre>
</div>
</div>
<div class="paragraph">
<p>It will show the incoming request that was not matched with all of its known details, as well as a detailed explanation of the configured expectations
and each matcher it provides. Successful matches are marked with a checkmark (<code>✓</code>), and mis-matches with an <code>X</code>.</p>
</div>
<div class="paragraph">
<p>Alternately, you may specify the <code>reportToConsole true</code> configuration in the server config. This will cause the report to be written to the standard
output console as well as into the log output. This is useful for cases when you might have logging turned off.</p>
</div>
<div class="sect3">
<h4 id="_hamcrest_matchers">Hamcrest Matchers</h4>
<div class="paragraph">
<p>Many of the expectation methods accept <a href="http://hamcrest.org/">Hamcrest</a> <code>Matcher</code> instances as an alternate argument. Hamcrest matchers allow for a more
rich and expressive matching configuration. Consider the following configuration:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="groovy">server.expectations {
    GET( startsWith(<span class="string"><span class="delimiter">'</span><span class="content">/foo</span><span class="delimiter">'</span></span>) ){
        called greaterThanOrEqualTo(<span class="integer">2</span>)
        query <span class="string"><span class="delimiter">'</span><span class="content">user-key</span><span class="delimiter">'</span></span>, notNullValue()
        responder {
            body <span class="string"><span class="delimiter">'</span><span class="content">ok</span><span class="delimiter">'</span></span>, TEXT_PLAIN
        }
    }
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>This configuration would match a <code>GET</code> request to a URL starting with <code>/foo</code>, with a non-null query string "user-key" value. This request matcher is
 expected to be called at least twice and it will respond with a <code>text/plain</code> response of <code>ok</code>.</p>
</div>
<div class="paragraph">
<p>The methods that accept matchers will have a non-matcher version which provides a sensible default matcher (e.g. <code>GET(Matcher)</code> has <code>GET(String)</code> which
provides delegates to <code>GET( equalTo( string ) )</code> to wrap the provided path string in a matcher.</p>
</div>
<div class="paragraph">
<p>If you are using Groovy, you can actually replace Hamcrest matchers with a <code>Closure</code> emulating the same interface - basically a method that takes
the parameter and returns whether or not the condition was matched. The same example above could be re-written as:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="groovy">server.expectations {
    GET({ p-&gt; p.startsWith(<span class="string"><span class="delimiter">'</span><span class="content">/foo</span><span class="delimiter">'</span></span>) }){
        called { i-&gt; i &gt;= <span class="integer">2</span> }
        query <span class="string"><span class="delimiter">'</span><span class="content">user-key</span><span class="delimiter">'</span></span>, notNullValue()
        responder {
            body <span class="string"><span class="delimiter">'</span><span class="content">ok</span><span class="delimiter">'</span></span>, TEXT_PLAIN
        }
    }
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>This allows for additional flexibility in configuring expectations.</p>
</div>
</div>
<div class="sect3">
<h4 id="_matching_cookies">Matching Cookies</h4>
<div class="paragraph">
<p>There are four methods for matching cookies associated with a request (found in the <code>com.stehno.ersatz.cfg.Request</code> interface):</p>
</div>
<div class="sect4">
<h5 id="_by_name_and_matcher">By Name and Matcher</h5>
<div class="paragraph">
<p>The <code>cookie(String name, Matcher&lt;Cookie&gt; matcher)</code> method configures the specified matcher for the cookie with the given name.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="groovy">server.expectations {
    GET(<span class="string"><span class="delimiter">'</span><span class="content">/somewhere</span><span class="delimiter">'</span></span>){
        cookie <span class="string"><span class="delimiter">'</span><span class="content">user-key</span><span class="delimiter">'</span></span>, CookieMatcher.cookieMatcher {
            value startsWith(<span class="string"><span class="delimiter">'</span><span class="content">key-</span><span class="delimiter">'</span></span>)
            domain <span class="string"><span class="delimiter">'</span><span class="content">mydomain.com</span><span class="delimiter">'</span></span>
        }
        responds().code(<span class="integer">200</span>)
    }
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>The Hamcrest matcher used may be a custom <code>Matcher</code> implementation, or the provided <code>com.stehno.ersatz.match.CookieMatcher</code>.</p>
</div>
</div>
<div class="sect4">
<h5 id="_by_name_and_value">By Name and Value</h5>
<div class="paragraph">
<p>The <code>cookie(String name, String value)</code> method is a shortcut for configuring simple name/value matching where the cookie value must be equal to the
specified value. An example:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="groovy">server.expectations {
    GET(<span class="string"><span class="delimiter">'</span><span class="content">/somewhere</span><span class="delimiter">'</span></span>).cookie(<span class="string"><span class="delimiter">'</span><span class="content">user-key</span><span class="delimiter">'</span></span>, <span class="string"><span class="delimiter">'</span><span class="content">key-23435HJKSDGF86</span><span class="delimiter">'</span></span>).responds().code(<span class="integer">200</span>)
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>This is equivalent to calling the matcher-based version of the method:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="groovy">server.expectations {
    GET(<span class="string"><span class="delimiter">'</span><span class="content">/somewhere</span><span class="delimiter">'</span></span>){
        cookie <span class="string"><span class="delimiter">'</span><span class="content">user-key</span><span class="delimiter">'</span></span>, CookieMatcher.cookieMatcher {
            value equalTo(<span class="string"><span class="delimiter">'</span><span class="content">key-23435HJKSDGF86</span><span class="delimiter">'</span></span>)
        }
        responds().code(<span class="integer">200</span>)
    }
}</code></pre>
</div>
</div>
</div>
<div class="sect4">
<h5 id="_multiple_cookies">Multiple Cookies</h5>
<div class="paragraph">
<p>The <code>cookies(Map&lt;String,Object&gt;)</code> method provides a means of configuring multiple cookie matchers (as value `String`s or cookie `Matcher`s). In the
following example matchers are configured to match the 'user-key' cookie for values "starting with" the specified value, the request should also have
an 'app-id' cookie with a value of "user-manager", and finally the request should <em>not</em> have the 'timeout' cookie specified.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="groovy">server.expectations {
    GET(<span class="string"><span class="delimiter">'</span><span class="content">/something</span><span class="delimiter">'</span></span>){
        cookies([
            <span class="string"><span class="delimiter">'</span><span class="content">user-key</span><span class="delimiter">'</span></span>: cookieMatcher {
                value startsWith(<span class="string"><span class="delimiter">'</span><span class="content">key-</span><span class="delimiter">'</span></span>)
            },
            <span class="string"><span class="delimiter">'</span><span class="content">appid</span><span class="delimiter">'</span></span>: <span class="string"><span class="delimiter">'</span><span class="content">user-manager</span><span class="delimiter">'</span></span>,
            <span class="string"><span class="delimiter">'</span><span class="content">timeout</span><span class="delimiter">'</span></span>: nullValue()
        ])
        responds().code(<span class="integer">200</span>)
    }
}</code></pre>
</div>
</div>
</div>
</div>
<div class="sect3">
<h4 id="_overall_matcher">Overall Matcher</h4>
<div class="paragraph">
<p>The <code>cookies(Matcher&lt;Map&lt;String,Cookie&gt;)</code> method is used to specify a <code>Matcher</code> for the map of cookie names to <code>com.stehno.ersatz.cfg.Cookie</code> objects. The
matcher may be any custom matcher, or the <code>com.stehno.ersatz.match.NoCookiesMatcher</code> may be used to match for the case where no cookies should be defined
in the request:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="groovy">server.expectations {
    get(<span class="string"><span class="delimiter">'</span><span class="content">/something</span><span class="delimiter">'</span></span>){
        cookies NoCookiesMatcher.noCookies()
        responds().code(<span class="integer">200</span>)
    }
}</code></pre>
</div>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_https">HTTPS</h3>
<div class="paragraph">
<p>The <code>ErsatzServer</code> supports HTTPS requests when the <code>https()</code> configuration is set (either as <code>https()</code> or as <code>https true</code>). This
will setup both an HTTP and HTTPS listener both of which will have access to all configured expectations. In order to limit a specific request
expectation to HTTP or HTTPS, apply the <code>protocol(String)</code> matcher method with the desired protocol, for example:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="groovy">server.expectations {
    GET(<span class="string"><span class="delimiter">'</span><span class="content">/something</span><span class="delimiter">'</span></span>).protocol(<span class="string"><span class="delimiter">'</span><span class="content">https</span><span class="delimiter">'</span></span>).responding(<span class="string"><span class="delimiter">'</span><span class="content">thing</span><span class="delimiter">'</span></span>)
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>which will match an HTTPS request to <code>GET /something</code> and send a response of <code>thing</code>.</p>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<div class="title">Note</div>
</td>
<td class="content">
the HTTPS support is rudimentary and meant to test HTTPS endpoints, not any explicit features of HTTPS itself. Also your client will need to be able to ignore any self-signed certification issues in one way or another.
</td>
</tr>
</table>
</div>
<div class="sect3">
<h4 id="_creating_a_custom_keystore">Creating a Custom Keystore</h4>
<div class="paragraph">
<p>A default keystore is provided with the Ersatz library, and it should suffice for most cases; however, you may wish to provide your own custom keystore
for whatever reason. A supported keystore file may be created using the following command:</p>
</div>
<div class="literalblock">
<div class="content">
<pre>./keytool -genkey -alias &lt;NAME&gt; -keyalg RSA -keystore &lt;FILE_LOCATION&gt;</pre>
</div>
</div>
<div class="paragraph">
<p>where <code>&lt;NAME&gt;</code> is the key name and <code>&lt;FILE_LOCATION&gt;</code> is the location where the keystore file is to be created. You will be asked a few questions about
the key being created. The default keystore name is <code>ersatz</code> and it has the following properties:</p>
</div>
<div class="literalblock">
<div class="content">
<pre>CN=Ersatz, OU=Ersatz, O=Ersatz, L=Nowhere, ST=Nowhere, C=US</pre>
</div>
</div>
<div class="paragraph">
<p>Obviously, it is only for testing purposes.</p>
</div>
<div class="paragraph">
<p>The keystore should then be provided during server configuration as:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="groovy">ErsatzServer server = <span class="keyword">new</span> ErsatzServer({
    https()
    keystore KEYSTORE_URL, KEYSTORE_PASS
})</code></pre>
</div>
</div>
<div class="paragraph">
<p>where <code>KEYSTORE_URL</code> is the URL to your custom keystore file, and <code>KEYSTORE_PASS</code> is the password (maybe omitted if you used <code>ersatz</code> as the password).</p>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_request_timeout">Request Timeout</h3>
<div class="paragraph">
<p>The server request timeout configuration may be specified using the <code>timeout(int, StorageUnit)</code> configuration method. This allows the request timeout value and units to be configured before server
startup (prior to calling <code>start()</code> or configuring expectations.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="groovy"><span class="keyword">import</span> <span class="include">static</span> <span class="include">java.util.concurrent.TimeUnit.MINUTES</span>

ErsatzServer server = <span class="keyword">new</span> ErsatzServer({
    timeout <span class="integer">1</span>, MINUTES
})</code></pre>
</div>
</div>
<div class="paragraph">
<p>This will allow some wiggle room in tests with high volumes of data or having complex matching logic to be resolved.</p>
</div>
<div class="paragraph">
<p>INFO: The timeout is a bit of a shotgun approach, as it sets a handful of timeout options to the specified value. See the API docs for more details.</p>
</div>
</div>
<div class="sect2">
<h3 id="_request_response_compression">Request / Response Compression</h3>
<div class="paragraph">
<p>Ersatz supports GZip and Deflate compression seamlessly as long as the <code>Accept-Encoding</code> header is specified as <code>gzip</code> or <code>deflate</code>. If the response
is compressed, a <code>Content-Encoding</code> header will be added to the response with the appropriate compression type as the value.</p>
</div>
</div>
<div class="sect2">
<h3 id="_chunked_response">Chunked Response</h3>
<div class="paragraph">
<p>A response may be configured as a "chunked" response, wherein the response data is sent to the client in small bits along with an additional response
header, the <code>Transfer-encoding: chunked</code> header. For testing purposes, a fixed or randomized range of time delay may be configured so that the chunks
may be sent slowly, to more accurately simulate a real environment.</p>
</div>
<div class="paragraph">
<p>To configure a chunked response, provide a <code>ChunkingConfig</code> to the response configuration:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="groovy">ersatzServer.expectations {
    GET(<span class="string"><span class="delimiter">'</span><span class="content">/chunky</span><span class="delimiter">'</span></span>).responder {
        body <span class="string"><span class="delimiter">'</span><span class="content">This is chunked content</span><span class="delimiter">'</span></span>, TEXT_PLAIN
        chunked {
            chunks <span class="integer">3</span>
            delay <span class="integer">100</span>..<span class="integer">500</span>
        }
    }
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>In the example, the response content will be broken into <code>3</code> roughly equal chunks, each of which is sent to the client after a random delay between 100 and
500 milliseconds. This <code>delay</code> value may also be a fixed number of milliseconds, or omitted to send the content as fast as possible.</p>
</div>
<div class="admonitionblock tip">
<table>
<tr>
<td class="icon">
<div class="title">Tip</div>
</td>
<td class="content">
The <code>Transfer-encoding</code> response header will be set automatically when a <code>chunked</code> configuration is specified on the response.
</td>
</tr>
</table>
</div>
</div>
<div class="sect2">
<h3 id="_multipart_request_content">Multipart Request Content</h3>
<div class="paragraph">
<p>Ersatz server supports multipart file upload requests (<code>multipart/form-data</code> content-type) using the
<a href="https://commons.apache.org/proper/commons-fileupload/">Apache File Upload</a> library on the "server" side. The expectations for multipart requests are
configured using the <code>MultipartRequestContent</code> class to build up an equivalent multipart matcher:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="groovy">ersatz.expectataions {
    POST(<span class="string"><span class="delimiter">'</span><span class="content">/upload</span><span class="delimiter">'</span></span>) {
        decoder MULTIPART_MIXED, Decoders.multipart
        decoder IMAGE_PNG, Decoders.passthrough
        body multipart {
            part <span class="string"><span class="delimiter">'</span><span class="content">something</span><span class="delimiter">'</span></span>, <span class="string"><span class="delimiter">'</span><span class="content">interesting</span><span class="delimiter">'</span></span>
            part <span class="string"><span class="delimiter">'</span><span class="content">infoFile</span><span class="delimiter">'</span></span>, <span class="string"><span class="delimiter">'</span><span class="content">info.txt</span><span class="delimiter">'</span></span>, TEXT_PLAIN, infoText
            part <span class="string"><span class="delimiter">'</span><span class="content">imageFile</span><span class="delimiter">'</span></span>, <span class="string"><span class="delimiter">'</span><span class="content">image.png</span><span class="delimiter">'</span></span>, IMAGE_PNG, imageBytes
        }, MULTIPART_MIXED
        responder {
            body <span class="string"><span class="delimiter">'</span><span class="content">ok</span><span class="delimiter">'</span></span>
        }
    }
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>which will need to exactly match the incoming request body in order to be considered a match. There is also a <code>MultipartRequestMatcher</code> used to
provide a more flexible Hamcrest-based matching of the request body:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="groovy">server.expectations {
    POST(<span class="string"><span class="delimiter">'</span><span class="content">/upload</span><span class="delimiter">'</span></span>) {
        decoder MULTIPART_MIXED, Decoders.multipart
        decoder IMAGE_PNG, Decoders.passthrough
        body multipartMatcher {
            part <span class="string"><span class="delimiter">'</span><span class="content">something</span><span class="delimiter">'</span></span>, notNullValue()
            part <span class="string"><span class="delimiter">'</span><span class="content">infoFile</span><span class="delimiter">'</span></span>, endsWith(<span class="string"><span class="delimiter">'</span><span class="content">.txt</span><span class="delimiter">'</span></span>), TEXT_PLAIN, notNullValue()
            part <span class="string"><span class="delimiter">'</span><span class="content">imageFile</span><span class="delimiter">'</span></span>, endsWith(<span class="string"><span class="delimiter">'</span><span class="content">.png</span><span class="delimiter">'</span></span>), IMAGE_PNG, notNullValue()
        }, MULTIPART_MIXED
        responder {
            body <span class="string"><span class="delimiter">'</span><span class="content">ok</span><span class="delimiter">'</span></span>
        }
    }
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>This will configure a match of the request body content based on the individual matchers, rather than overall equivalence.</p>
</div>
<div class="paragraph">
<p>A key point in multipart request support are the "decoders", which are used to decode the incoming request content into an expected object type.
Decoders are simply <code>BiFunction&lt;byte[], DecodingContext, Object&gt;</code> implementations - taking the incoming byte array, and a <code>DecodingContext</code> and
returning the decoded <code>Object</code> instance. Decoders may be registered in a shared instance of <code>RequestDecoders</code>, configured globally across the server
instance or configured on a per-request basis.</p>
</div>
<div class="admonitionblock tip">
<table>
<tr>
<td class="icon">
<div class="title">Tip</div>
</td>
<td class="content">
No decoders are provided by default, any used in the request content <em>must</em> be provided in configuration.
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>Some common reusable decoders are provided in the <code>Decoders</code> utility class.</p>
</div>
</div>
<div class="sect2">
<h3 id="_multipart_response_content">Multipart Response Content</h3>
<div class="paragraph">
<p>Multipart response content is supported, though most browsers do not fully support it - the expected use case would be a RESTful or other HTTP-based
API. The response content will have the standard <code>multipart/form-data</code> content type and format. The response content parts are provided using an
instance of the <code>MultipartResponseContent</code> class along with the <code>Encoders.multipart</code> multipart response content encoder (configured on the server or
response).</p>
</div>
<div class="paragraph">
<p>The content parts are provided as "field" parts with only a field name and value, or as "file" parts with a field name, content-type, file name and
content object. These configurations are made on the <code>MultipartResponseContent</code> object via DSL or functional interface.</p>
</div>
<div class="paragraph">
<p>The part content objects are serialized for data transfer as <code>byte[]</code> content using configured encoders, which are simply instances of
<code>Function&lt;Object,byte[]&gt;</code> used to do the object to byte array conversion. These are configured either on a per-response basis or by sharing a
<code>ResponseEncoders</code> instance between multipart configurations - the shared encoders will be used if not explicitly overridden by the multipart
response configuration. No part encoders are provided by default.</p>
</div>
<div class="paragraph">
<p>An example multipart response with a field and an image file would be something like:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="groovy">ersatz.expectations {
    GET(<span class="string"><span class="delimiter">'</span><span class="content">/data</span><span class="delimiter">'</span></span>) {
        responder {
            encoder ContentType.MULTIPART_MIXED, MultipartResponseContent, Encoders.multipart
            body(multipart {
                <span class="comment">// configure the part encoders</span>
                encoder TEXT_PLAIN, <span class="predefined-type">CharSequence</span>, { o -&gt; (o <span class="keyword">as</span> <span class="predefined-type">String</span>).bytes }
                encoder IMAGE_JPG, <span class="predefined-type">File</span>, { o -&gt; ((<span class="predefined-type">File</span>)o).bytes }

                <span class="comment">// a field part</span>
                field <span class="string"><span class="delimiter">'</span><span class="content">comments</span><span class="delimiter">'</span></span>, <span class="string"><span class="delimiter">'</span><span class="content">This is a cool image.</span><span class="delimiter">'</span></span>

                <span class="comment">// a file part</span>
                part <span class="string"><span class="delimiter">'</span><span class="content">image</span><span class="delimiter">'</span></span>, <span class="string"><span class="delimiter">'</span><span class="content">test-image.jpg</span><span class="delimiter">'</span></span>, IMAGE_JPG, <span class="keyword">new</span> <span class="predefined-type">File</span>(<span class="string"><span class="delimiter">'</span><span class="content">/test-image.jpg</span><span class="delimiter">'</span></span>), <span class="string"><span class="delimiter">'</span><span class="content">base64</span><span class="delimiter">'</span></span>
            })
        }
    }
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>The resulting response body would look like the following (as a String):</p>
</div>
<div class="listingblock">
<div class="content">
<pre>--WyAJDTEVlYgGjdI13o
Content-Disposition: form-data; name="comments"
Content-Type: text/plain

This is a cool image.
--WyAJDTEVlYgGjdI13o
Content-Disposition: form-data; name="image"; filename="test-image.jpg"
Content-Transfer-Encoding: base64
Content-Type: image/jpeg

... more content follows ...</pre>
</div>
</div>
<div class="paragraph">
<p>which could be decoded in the same manner a multipart <em>request</em> content (an example using the Apache File Upload multipart parser can be found in
the unit tests).</p>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_proxy_server">Proxy Server</h2>
<div class="sectionbody">
<div class="paragraph">
<p>Starting in v1.6.1 a standalone proxy server was available. The <code>com.stehno.ersatz.ErsatzProxy</code> is useful for testing proxied HTTP connections.
The proxy server has a similar configuration to the <code>ErsatzServer</code> and allows limited expectation configuration; it is expected that more detailed
expectation configuration will be done on a standard <code>ErsatzServer</code> instance at the other end of the proxy.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="groovy">ErsatzServer ersatzServer = <span class="keyword">new</span> ErsatzServer({
    expectations {
        GET(<span class="string"><span class="delimiter">'</span><span class="content">/</span><span class="delimiter">'</span></span>).called(<span class="integer">1</span>).responds().code(<span class="integer">200</span>).body(<span class="string"><span class="delimiter">'</span><span class="content">Hello</span><span class="delimiter">'</span></span>, TEXT_PLAIN)
        GET(<span class="string"><span class="delimiter">'</span><span class="content">/foo</span><span class="delimiter">'</span></span>).called(<span class="integer">1</span>).responds().code(<span class="integer">200</span>).body(<span class="string"><span class="delimiter">'</span><span class="content">Foo!</span><span class="delimiter">'</span></span>, TEXT_PLAIN)
    }
})

ErsatzProxy ersatzProxy = <span class="keyword">new</span> ErsatzProxy({
    target ersatzServer.httpUrl
    expectations {
        GET(<span class="string"><span class="delimiter">'</span><span class="content">/</span><span class="delimiter">'</span></span>)
        GET(<span class="string"><span class="delimiter">'</span><span class="content">/foo</span><span class="delimiter">'</span></span>)
    }
})

<span class="predefined-type">String</span> text = <span class="string"><span class="delimiter">&quot;</span><span class="inline"><span class="inline-delimiter">${</span>ersatzProxy.url<span class="inline-delimiter">}</span></span><span class="delimiter">&quot;</span></span>.toURL().text
<span class="keyword">assert</span> text == <span class="string"><span class="delimiter">'</span><span class="content">Hello</span><span class="delimiter">'</span></span>

text = <span class="string"><span class="delimiter">&quot;</span><span class="inline"><span class="inline-delimiter">${</span>ersatzProxy.url<span class="inline-delimiter">}</span></span><span class="content">/foo</span><span class="delimiter">&quot;</span></span>.toURL().text
<span class="keyword">assert</span> text == <span class="string"><span class="delimiter">'</span><span class="content">Foo!</span><span class="delimiter">'</span></span>

<span class="keyword">assert</span> ersatzServer.verify()
<span class="keyword">assert</span> ersatzProxy.verify()

ersatzProxy.stop()
ersatzServer.stop()</code></pre>
</div>
</div>
<div class="paragraph">
<p>Notice that the <code>ErsatzProxy</code> has the same lifecycle as the <code>ErsatzServer</code>: you should call the <code>verify()</code> method to ensure that the expected requests
were proxied, and the <code>stop()</code> method must be closed once the server is no longer needed.</p>
</div>
<div class="paragraph">
<p>The requests made to the proxy server are passed through to the <code>targetUri</code> and the response from that server is returned as the response from the
proxy server.</p>
</div>
<div class="paragraph">
<p>The proxy server is usable from both Java and Groovy based on the use of Groovy `Closure`s or Java `Consumer`s for configuration.</p>
</div>
<div class="paragraph">
<p>Currently, the proxy server only supports HTTP endpoints (HTTPS will be supported in a future release once a bug is fixed in the underlying server).</p>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_sightings">Sightings</h2>
<div class="sectionbody">
<div class="paragraph">
<p>Here are some external references and discussions about developing with Ersatz:</p>
</div>
<div class="ulist">
<ul>
<li>
<p><a href="http://guides.grails.org/grails-mock-http-server/guide/index.html">Consume and test a third-party REST API</a> <em>(Sergio del Amo)</em> - Use Ersatz, a "mock" HTTP library, for testing code dealing with HTTP requests</p>
</li>
<li>
<p><a href="http://coffeaelectronica.com/blog/2017/rest-httpbuilder-ersatz.html">Taking a REST with HttpBulder-NG and Ersatz</a> <em>(Christopher J Stehno)</em> - Building and testing a REST interface with HttpBuilder-NG and Ersatz (<a href="https://github.com/cjstehno/rest-dev">implementations</a> in Groovy, Java and Kotlin).</p>
</li>
<li>
<p>The <a href="https://http-builder-ng.github.io/http-builder-ng/">HttpBuilder-NG</a> project has extensive examples of testing with Ersatz.</p>
</li>
</ul>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_shadow_jar">Shadow Jar</h2>
<div class="sectionbody">
<div class="paragraph">
<p>The embedded version of Undertow used by Ersatz has caused issues with some server frameworks which also use Undertow (e.g. Grails, and Spring-boot).
If you run into errors using the standard jar distribution, please try using the <code>safe</code> distribution, which is a shadowed jar which includes the
Undertow library and its JBoss dependencies repackaged in the jar. You can use this version with the following coordinates:</p>
</div>
<div class="literalblock">
<div class="content">
<pre>testCompile 'com.stehno.ersatz:ersatz:2.0.0:safe@jar'</pre>
</div>
</div>
<div class="paragraph">
<p>For a Maven <code>pom.xml</code> entry, this would be:</p>
</div>
<div class="literalblock">
<div class="content">
<pre>&lt;dependency&gt;
    &lt;groupId&gt;com.stehno.ersatz&lt;/groupId&gt;
    &lt;artifactId&gt;ersatz&lt;/artifactId&gt;
    &lt;version&gt;2.0.0&lt;/version&gt;
    &lt;type&gt;jar&lt;/type&gt;
    &lt;scope&gt;test&lt;/scope&gt;
    &lt;classifier&gt;safe&lt;/classifier&gt;
&lt;/dependency&gt;</pre>
</div>
</div>
<div class="paragraph">
<p>Notice the <code>safe</code> classifier in both examples.</p>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<div class="title">Note</div>
</td>
<td class="content">
This version of the library will NOT bring any of its other dependencies with it, so you will need to ensure that you have Hamcrest and JUnit defined, if they are needed by your project.
</td>
</tr>
</table>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_utilities">Utilities</h2>
<div class="sectionbody">
<div class="paragraph">
<p>The Ersatz project also contains some useful helper utility classes.</p>
</div>
<div class="sect2">
<h3 id="_dummycontentgenerator"><code>DummyContentGenerator</code></h3>
<div class="paragraph">
<p>The <code>DummyContentGenerator</code> class provides a simple method for quickly generating request/response content bytes of various sizes. The generated data is simply <code>(byte)1</code> values. Usage is pretty
straight-forward:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="groovy"><span class="keyword">import</span> <span class="include">static</span> <span class="include">com.stehno.ersatz.util.DummyContentGenerator.generate</span>
<span class="keyword">import</span> <span class="include">static</span> <span class="include">com.stehno.ersatz.util.StorageUnit.MEGABYTES</span>

<span class="type">byte</span><span class="type">[]</span> content = generate(<span class="integer">10</span>, MEGABYTES)</code></pre>
</div>
</div>
<div class="paragraph">
<p>which will generate an array with 10 MB of data.</p>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_usage_examples">Usage Examples</h2>
<div class="sectionbody">
<div class="paragraph">
<p>This section contains some recipe-style usage examples.</p>
</div>
<div class="sect2">
<h3 id="_url_encoded_form_requests">Url-Encoded Form Requests</h3>
<div class="paragraph">
<p>Url-encoded form requests are supported by default when the request content-type is specified as <code>application/x-www-form-urlencoded</code>. The request
<code>body</code> expectation configuration will expect a <code>Map&lt;String,String&gt;</code> equivalent to the name-value pairs specified in the request body content. An
example would be:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="groovy">server.expectations {
    POST(<span class="string"><span class="delimiter">'</span><span class="content">/form</span><span class="delimiter">'</span></span>) {
        body([<span class="key">alpha</span>: <span class="string"><span class="delimiter">'</span><span class="content">some data</span><span class="delimiter">'</span></span>, <span class="key">bravo</span>: <span class="string"><span class="delimiter">'</span><span class="content">42</span><span class="delimiter">'</span></span>], <span class="string"><span class="delimiter">'</span><span class="content">application/x-www-form-urlencoded</span><span class="delimiter">'</span></span>)
        responder {
            body <span class="string"><span class="delimiter">'</span><span class="content">ok</span><span class="delimiter">'</span></span>
        }
    }
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>where the <code>POST</code> content data would look like:</p>
</div>
<div class="literalblock">
<div class="content">
<pre>alpha=some+data&amp;bravo=42</pre>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_file_upload_post">File Upload (POST)</h3>
<div class="paragraph">
<p>You can setup an expectation for a file upload POST using the <code>multipart</code> support, something like:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="groovy"><span class="keyword">import</span> <span class="include">com.stehno.erstaz.ErsatzServer</span>
<span class="keyword">import</span> <span class="include">com.stehno.ersatz.MultipartRequestContent</span>
<span class="keyword">import</span> <span class="include">static</span> <span class="include">com.stehno.ersatz.ContentType.TEXT_PLAIN</span>

<span class="keyword">def</span> ersatz = <span class="keyword">new</span> ErsatzServer({
    encoder TEXT_PLAIN, <span class="predefined-type">File</span>, Encoders.text
})

<span class="keyword">def</span> file = <span class="keyword">new</span> <span class="predefined-type">File</span>(<span class="comment">/* some file */</span>)

ersatz.expectations {
    POST(<span class="string"><span class="delimiter">'</span><span class="content">/upload</span><span class="delimiter">'</span></span>) {
        decoders TEXT_PLAIN, Decoders.utf8String
        decoder MULTIPART_MIXED, Decoders.multipart

        body MultipartRequestContent.multipart {
            part <span class="string"><span class="delimiter">'</span><span class="content">fileName</span><span class="delimiter">'</span></span>, file.name
            part <span class="string"><span class="delimiter">'</span><span class="content">file</span><span class="delimiter">'</span></span>, file.name, <span class="string"><span class="delimiter">'</span><span class="content">text/plain; charset=utf-8</span><span class="delimiter">'</span></span>, file.text
        }, MULTIPART_MIXED

        responder {
            body <span class="string"><span class="delimiter">'</span><span class="content">ok</span><span class="delimiter">'</span></span>
        }
    }
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>This will expect the posting of the given file content to the <code>/upload</code> path of the server.</p>
</div>
</div>
<div class="sect2">
<h3 id="_file_download_get">File Download (GET)</h3>
<div class="paragraph">
<p>Setting up an expectation for a GET request to respond with a file to download can be done as follows:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="groovy"><span class="keyword">import</span> <span class="include">com.stehno.erstaz.ErsatzServer</span>
<span class="keyword">import</span> <span class="include">static</span> <span class="include">com.stehno.ersatz.ContentType.TEXT_PLAIN</span>

<span class="keyword">def</span> ersatz = <span class="keyword">new</span> ErsatzServer({
    encoder TEXT_PLAIN, <span class="predefined-type">File</span>, Encoders.text
})

<span class="keyword">def</span> file = <span class="keyword">new</span> <span class="predefined-type">File</span>(<span class="comment">/* some file */</span>)

ersatz.expectations {
    GET(<span class="string"><span class="delimiter">'</span><span class="content">/download</span><span class="delimiter">'</span></span>){
        responder {
            header <span class="string"><span class="delimiter">'</span><span class="content">Content-Disposition</span><span class="delimiter">'</span></span>, <span class="string"><span class="delimiter">&quot;</span><span class="content">attachment; filename=</span><span class="char">\&quot;</span><span class="inline"><span class="inline-delimiter">${</span>file.name<span class="inline-delimiter">}</span></span><span class="char">\&quot;</span><span class="delimiter">&quot;</span></span>
            body file, TEXT_PLAIN
        }
    }
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>This will respond to the request with file download content.</p>
</div>
</div>
<div class="sect2">
<h3 id="_kotlin_usage">Kotlin Usage</h3>
<div class="paragraph">
<p>You can use the Ersatz Server from the Kotlin programming language just as easily as Java or Groovy:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="kotlin">val ersatz = ErsatzServer { config -&gt; config.autoStart(true) }

ersatz.expectations { expectations -&gt;
    expectations.GET(&quot;/kotlin&quot;).called(1).responder { response -&gt;
        response.body(&quot;Hello Kotlin!&quot;, ContentType.TEXT_PLAIN).code(200)
    }
}

val http = OkHttpClient.Builder().build()
val request: okhttp3.Request = okhttp3.Request.Builder().url(&quot;${ersatz.httpUrl}/kotlin&quot;).build()
println( http.newCall(request).execute().body().string() )</code></pre>
</div>
</div>
<div class="paragraph">
<p>which will print out "Hello Kotlin!" when executed.</p>
</div>
</div>
<div class="sect2">
<h3 id="_matching_xml_body_content">Matching XML Body Content</h3>
<div class="paragraph">
<p>A unit test has been added to provide a better example of how to use the Hamcrest matchers in a request. See the <code>BodyContentMatcherSpec</code> test class in the source code, but
a summary is provided below:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="groovy"><span class="keyword">import</span> <span class="include">com.stehno.ersatz.encdec.DecodingContext</span>
<span class="keyword">import</span> <span class="include">com.stehno.ersatz.ErsatzServer</span>
<span class="keyword">import</span> <span class="include">com.stehno.ersatz.util.HttpClient</span>
<span class="keyword">import</span> <span class="include">okhttp3.MediaType</span>
<span class="keyword">import</span> <span class="include">okhttp3.Response</span>
<span class="keyword">import</span> <span class="include">spock.lang.AutoCleanup</span>
<span class="keyword">import</span> <span class="include">spock.lang.Specification</span>

<span class="keyword">import</span> <span class="include">javax.xml.parsers.DocumentBuilderFactory</span>

<span class="keyword">import</span> <span class="include">static</span> <span class="include">com.stehno.ersatz.encdec.ContentType.TEXT_XML</span>
<span class="keyword">import</span> <span class="include">static</span> <span class="include">com.stehno.ersatz.encdec.Decoders.utf8String</span>
<span class="keyword">import</span> <span class="include">static</span> <span class="include">com.stehno.ersatz.encdec.Encoders.text</span>
<span class="keyword">import</span> <span class="include">static</span> <span class="include">okhttp3.RequestBody.create</span>
<span class="keyword">import</span> <span class="include">static</span> <span class="include">org.hamcrest.CoreMatchers.equalTo</span>
<span class="keyword">import</span> <span class="include">static</span> <span class="include">org.hamcrest.xml.HasXPath.hasXPath</span>

<span class="type">class</span> <span class="class">BodyContentMatcherSpec</span> <span class="directive">extends</span> Specification {

    <span class="annotation">@AutoCleanup</span> <span class="directive">private</span> <span class="directive">final</span> ErsatzServer server = <span class="keyword">new</span> ErsatzServer()
    <span class="directive">private</span> <span class="directive">final</span> HttpClient http = <span class="keyword">new</span> HttpClient()

    <span class="type">void</span> <span class="string"><span class="delimiter">'</span><span class="content">matching part of body content</span><span class="delimiter">'</span></span>() {
        <span class="key">setup</span>:
        <span class="predefined-type">String</span> requestXml = <span class="string"><span class="delimiter">'</span><span class="content">&lt;request&gt;&lt;node foo=&quot;bar&quot;/&gt;&lt;/request&gt;</span><span class="delimiter">'</span></span>
        <span class="predefined-type">String</span> responseXml = <span class="string"><span class="delimiter">'</span><span class="content">&lt;response&gt;OK&lt;/response&gt;</span><span class="delimiter">'</span></span>

        server.expectations {
            POST(<span class="string"><span class="delimiter">'</span><span class="content">/posting</span><span class="delimiter">'</span></span>) {
                decoder(<span class="string"><span class="delimiter">'</span><span class="content">text/xml; charset=utf-8</span><span class="delimiter">'</span></span>) { <span class="type">byte</span><span class="type">[]</span> bytes, DecodingContext ctx -&gt;
                    <span class="predefined-type">DocumentBuilderFactory</span>.newInstance().newDocumentBuilder().parse(<span class="keyword">new</span> <span class="predefined-type">ByteArrayInputStream</span>(bytes))
                }
                body hasXPath(<span class="string"><span class="delimiter">'</span><span class="content">string(//request/node/@foo)</span><span class="delimiter">'</span></span>, equalTo(<span class="string"><span class="delimiter">'</span><span class="content">bar</span><span class="delimiter">'</span></span>)), <span class="string"><span class="delimiter">'</span><span class="content">text/xml; charset=utf-8</span><span class="delimiter">'</span></span>
                called <span class="integer">1</span>
                responder {
                    body responseXml, TEXT_XML
                    encoder TEXT_XML, <span class="predefined-type">String</span>, text
                }
            }
        }

        <span class="key">when</span>:
        Response response = http.post(server.httpUrl(<span class="string"><span class="delimiter">'</span><span class="content">/posting</span><span class="delimiter">'</span></span>), create(MediaType.get(<span class="string"><span class="delimiter">'</span><span class="content">text/xml; charset=utf-8</span><span class="delimiter">'</span></span>), requestXml))

        <span class="key">then</span>:
        response.body().string() == responseXml

        <span class="key">when</span>:
        response = http.post(server.httpUrl(<span class="string"><span class="delimiter">'</span><span class="content">/posting</span><span class="delimiter">'</span></span>), create(MediaType.get(<span class="string"><span class="delimiter">'</span><span class="content">text/xml; charset=utf-8</span><span class="delimiter">'</span></span>), <span class="string"><span class="delimiter">'</span><span class="content">&lt;request&gt;&lt;node foo=&quot;blah&quot;/&gt;&lt;/request&gt;</span><span class="delimiter">'</span></span>))

        <span class="key">then</span>:
        response.code() == <span class="integer">404</span>

        <span class="key">and</span>:
        server.verify()
    }
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>This test sets up a POST expectation with the XML request body content being used as one of the matching criteria. Hamcrest provides an XPath-based
matcher, <code>hasXPath(String, Matcher)</code>, which works well here. A custom XML-decoder was installed to parse the request into the XML document format
required by the matcher.</p>
</div>
<div class="paragraph">
<p>The test shows to requests made to the server, one with the expected content and one without - the results verify that only the correct call was
actually matched.</p>
</div>
<div class="paragraph">
<p>See the <a href="http://hamcrest.org/JavaHamcrest/">Hamcrest</a> documentation for more details about pre-existing and custom `Matcher`s.</p>
</div>
</div>
</div>
</div>
</div>
<div id="footer">
<div id="footer-text">
Version 2.0.0<br>
Last updated 2019-12-08 06:56:59 -0600
</div>
</div>
</body>
</html>