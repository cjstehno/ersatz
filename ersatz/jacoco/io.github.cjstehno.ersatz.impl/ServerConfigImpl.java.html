<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="en"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../jacoco-resources/report.css" type="text/css"/><link rel="shortcut icon" href="../jacoco-resources/report.gif" type="image/gif"/><title>ServerConfigImpl.java</title><link rel="stylesheet" href="../jacoco-resources/prettify.css" type="text/css"/><script type="text/javascript" src="../jacoco-resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../jacoco-sessions.html" class="el_session">Sessions</a></span><a href="../index.html" class="el_report">ersatz</a> &gt; <a href="index.source.html" class="el_package">io.github.cjstehno.ersatz.impl</a> &gt; <span class="el_source">ServerConfigImpl.java</span></div><h1>ServerConfigImpl.java</h1><pre class="source lang-java linenums">/**
 * Copyright (C) 2022 Christopher J. Stehno
 *
 * Licensed under the Apache License, Version 2.0 (the &quot;License&quot;);
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *         http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an &quot;AS IS&quot; BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */
package io.github.cjstehno.ersatz.impl;

import io.github.cjstehno.ersatz.cfg.ContentType;
import io.github.cjstehno.ersatz.cfg.Expectations;
import io.github.cjstehno.ersatz.cfg.ServerConfig;
import io.github.cjstehno.ersatz.encdec.DecodingContext;
import io.github.cjstehno.ersatz.encdec.RequestDecoders;
import io.github.cjstehno.ersatz.encdec.ResponseEncoders;

import java.net.URL;
import java.util.concurrent.TimeUnit;
import java.util.function.BiFunction;
import java.util.function.Consumer;
import java.util.function.Function;

import static java.util.concurrent.TimeUnit.SECONDS;

/**
 * Default implementation of the &lt;code&gt;ServerConfig&lt;/code&gt; interface.
 */
public class ServerConfigImpl implements ServerConfig {

    private static final int EPHEMERAL_PORT = 0;
    private boolean httpsEnabled;
<span class="fc" id="L40">    private boolean autoStartEnabled = true;</span>
    private boolean mismatchToConsole;
    private URL keystoreLocation;
<span class="fc" id="L43">    private String keystorePass = &quot;ersatz&quot;;</span>
<span class="fc" id="L44">    private int desiredHttpPort = EPHEMERAL_PORT;</span>
<span class="fc" id="L45">    private int desiredHttpsPort = EPHEMERAL_PORT;</span>
<span class="fc" id="L46">    private final RequestDecoders globalDecoders = new RequestDecoders();</span>
<span class="fc" id="L47">    private final ResponseEncoders globalEncoders = new ResponseEncoders();</span>
    private final ExpectationsImpl expectations;
    private Runnable starter;
    private long timeout;
    private boolean logResponseContent;

    /**
     * Creates a new empty configuration instance.
     */
<span class="fc" id="L56">    public ServerConfigImpl() {</span>
<span class="fc" id="L57">        this.expectations = new ExpectationsImpl(globalEncoders, globalDecoders);</span>
<span class="fc" id="L58">    }</span>

    /**
     * Used to inject the server-starter handle.
     *
     * @param starter the server-starter handle to be used
     */
    public void setStarter(final Runnable starter) {
<span class="fc" id="L66">        this.starter = starter;</span>
<span class="fc" id="L67">    }</span>

    /**
     * Used to control the enabled/disabled state of HTTPS on the server. By default HTTPS is disabled.
     *
     * @param enabled optional toggle value (true if not specified)
     * @return a reference to the server being configured
     */
    @Override public ServerConfig https(boolean enabled) {
<span class="fc" id="L76">        httpsEnabled = enabled;</span>
<span class="fc" id="L77">        return this;</span>
    }

    @Override public ServerConfig https() {
<span class="fc" id="L81">        return https(true);</span>
    }

    /**
     * Whether or not the https support is enabled. Defaults to &lt;code&gt;false&lt;/code&gt;.
     *
     * @return true, if the https support is enabled
     */
    public boolean isHttpsEnabled() {
<span class="fc" id="L90">        return httpsEnabled;</span>
    }

    /**
     * Whether or not the auto-start condition is enabled. Defaults to &lt;code&gt;true&lt;/code&gt;.
     *
     * @return true, if the auto-start condition is enabled.
     */
    public boolean isAutoStartEnabled() {
<span class="fc" id="L99">        return autoStartEnabled;</span>
    }

    /**
     * Whether or not the mismatched request conditions should be logged to the console. Defaults to &lt;code&gt;false&lt;/code&gt;.
     *
     * @return true, if the mismatched request conditions should be logged to the console
     */
    public boolean isMismatchToConsole() {
<span class="fc" id="L108">        return mismatchToConsole;</span>
    }

    /**
     * Retrieves the location for the HTTPS keystore.
     *
     * @return the keystore location (URL)
     */
    public URL getKeystoreLocation() {
<span class="fc" id="L117">        return keystoreLocation;</span>
    }

    /**
     * Retrieves the HTTPS keystore password.
     *
     * @return the keystore password
     */
    public String getKeystorePass() {
<span class="fc" id="L126">        return keystorePass;</span>
    }

    /**
     * Retrieves the configured (desired) HTTP port - this may be overridden by the server itself.
     *
     * @return the HTTP port
     */
    public int getDesiredHttpPort() {
<span class="fc" id="L135">        return desiredHttpPort;</span>
    }

    /**
     * Retrieves the configured (desired) HTTPS port - this may be overridden by the server itself.
     *
     * @return the HTTPS port
     */
    public int getDesiredHttpsPort() {
<span class="fc" id="L144">        return desiredHttpsPort;</span>
    }

    /**
     * Retrieves the configuration request expectations.
     *
     * @return the expectations
     */
    public ExpectationsImpl getExpectations() {
<span class="fc" id="L153">        return expectations;</span>
    }

    /**
     * Retrieves the configured timeout value for server requests.
     *
     * @return the server timeout value
     */
    public long getTimeout() {
<span class="fc" id="L162">        return timeout;</span>
    }

    /**
     * Used to clear out the configured expectations.
     */
    public void clearExpectations() {
<span class="fc" id="L169">        expectations.clear();</span>
<span class="fc" id="L170">    }</span>

    /**
     * Whether or not the response content should be logged for each request.
     *
     * @return true, if the response content should be logged
     */
    public boolean isLogResponseContent() {
<span class="fc" id="L178">        return logResponseContent;</span>
    }

    /**
     * Used to enable/disable the auto-start feature, which will start the server after any call to either of the &lt;code&gt;expectations&lt;/code&gt;
     * configuration methods. With this setting enabled, any other calls to the &lt;code&gt;start()&lt;/code&gt; method are ignored. Further configuration is
     * allowed.
     * &lt;p&gt;
     * Auto-start is enabled by default.
     *
     * @param autoStart whether or not auto-start is enabled
     * @return a reference to the server being configured
     */
    @Override public ServerConfig autoStart(boolean autoStart) {
<span class="fc" id="L192">        autoStartEnabled = autoStart;</span>
<span class="fc" id="L193">        return this;</span>
    }

    /**
     * Used to specify the server request timeout property value on the server. If not specified, &lt;code&gt;SECONDS&lt;/code&gt; will be used as the units.
     * &lt;p&gt;
     * The IDLE_TIMEOUT, NO_REQUEST_TIMEOUT, REQUEST_PARSE_TIMEOUT, READ_TIMEOUT and WRITE_TIMEOUT are all configured to the same specified
     * value.
     *
     * @param value the timeout value
     * @param units the units the timeout is specified with (or &lt;code&gt;SECONDS&lt;/code&gt;)
     * @return a reference to the server being configured
     */
    @Override public ServerConfig timeout(final int value, final TimeUnit units) {
<span class="nc" id="L207">        this.timeout = units.toMillis(value);</span>
<span class="nc" id="L208">        return this;</span>
    }

    @Override public ServerConfig timeout(final int value) {
<span class="nc" id="L212">        return timeout(value, SECONDS);</span>
    }

    /**
     * Used to toggle the console output of mismatched request reports. By default they are only rendered in the logging. A value of &lt;code&gt;true&lt;/code&gt;
     * will cause the report to be output on the console as well.
     *
     * @param toConsole whether or not the report should also be written to the console
     * @return a reference to the server being configured
     */
    @Override
    public ServerConfig reportToConsole(boolean toConsole) {
<span class="nc" id="L224">        mismatchToConsole = toConsole;</span>
<span class="nc" id="L225">        return this;</span>
    }

    @Override public ServerConfig reportToConsole() {
<span class="nc" id="L229">        return reportToConsole(true);</span>
    }

    /**
     * Allows configuration of an external HTTPS keystore with the given location and password. By default, if this is not specified an internally
     * provided keystore will be used for HTTPS certification. See the User Guide for details about configuring your own keystore.
     *
     * @param location the URL of the keystore file
     * @param password the keystore file password (defaults to &quot;ersatz&quot; if omitted)
     * @return a reference to the server being configured
     */
    @Override public ServerConfig keystore(final URL location, final String password) {
<span class="nc" id="L241">        keystoreLocation = location;</span>
<span class="nc" id="L242">        keystorePass = password;</span>
<span class="nc" id="L243">        return this;</span>
    }

    @Override public ServerConfig keystore(final URL location) {
<span class="nc" id="L247">        return keystore(location, &quot;ersatz&quot;);</span>
    }

    @Override public ServerConfig expectations(final Consumer&lt;Expectations&gt; expects) {
<span class="fc" id="L251">        expects.accept(expectations);</span>

<span class="fc bfc" id="L253" title="All 2 branches covered.">        if (autoStartEnabled) {</span>
<span class="fc" id="L254">            starter.run();</span>
        }

<span class="fc" id="L257">        return this;</span>
    }

    @Override public Expectations expects() {
<span class="fc" id="L261">        return expectations;</span>
    }

    @Override
    public ServerConfig decoder(String contentType, BiFunction&lt;byte[], DecodingContext, Object&gt; decoder) {
<span class="fc" id="L266">        globalDecoders.register(contentType, decoder);</span>
<span class="fc" id="L267">        return this;</span>
    }

    @Override
    public ServerConfig decoder(ContentType contentType, BiFunction&lt;byte[], DecodingContext, Object&gt; decoder) {
<span class="fc" id="L272">        return decoder(contentType.getValue(), decoder);</span>
    }

    @Override public ServerConfig encoder(String contentType, Class objectType, Function&lt;Object, byte[]&gt; encoder) {
<span class="fc" id="L276">        globalEncoders.register(contentType, objectType, encoder);</span>
<span class="fc" id="L277">        return this;</span>
    }

    @Override
    public ServerConfig httpPort(int serverPort) {
<span class="fc" id="L282">        desiredHttpPort = serverPort;</span>
<span class="fc" id="L283">        return this;</span>
    }

    @Override
    public ServerConfig httpsPort(int serverPort) {
<span class="nc" id="L288">        desiredHttpsPort = serverPort;</span>
<span class="nc" id="L289">        return this;</span>
    }

    @Override public ServerConfig logResponseContent(boolean value) {
<span class="fc" id="L293">        logResponseContent = value;</span>
<span class="fc" id="L294">        return this;</span>
    }
}
</pre><div class="footer"><span class="right">Created with <a href="http://www.jacoco.org/jacoco">JaCoCo</a> 0.8.7.202105040129</span></div></body></html>