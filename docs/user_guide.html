<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<meta name="generator" content="Asciidoctor 2.0.10">
<meta name="author" content="Christopher J. Stehno">
<title>Ersatz Server User Guide</title>
<link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Open+Sans:300,300italic,400,400italic,600,600italic%7CNoto+Serif:400,400italic,700,700italic%7CDroid+Sans+Mono:400,700">
<style>
/* Asciidoctor default stylesheet | MIT License | https://asciidoctor.org */
/* Uncomment @import statement to use as custom stylesheet */
/*@import "https://fonts.googleapis.com/css?family=Open+Sans:300,300italic,400,400italic,600,600italic%7CNoto+Serif:400,400italic,700,700italic%7CDroid+Sans+Mono:400,700";*/
article,aside,details,figcaption,figure,footer,header,hgroup,main,nav,section{display:block}
audio,video{display:inline-block}
audio:not([controls]){display:none;height:0}
html{font-family:sans-serif;-ms-text-size-adjust:100%;-webkit-text-size-adjust:100%}
a{background:none}
a:focus{outline:thin dotted}
a:active,a:hover{outline:0}
h1{font-size:2em;margin:.67em 0}
abbr[title]{border-bottom:1px dotted}
b,strong{font-weight:bold}
dfn{font-style:italic}
hr{-moz-box-sizing:content-box;box-sizing:content-box;height:0}
mark{background:#ff0;color:#000}
code,kbd,pre,samp{font-family:monospace;font-size:1em}
pre{white-space:pre-wrap}
q{quotes:"\201C" "\201D" "\2018" "\2019"}
small{font-size:80%}
sub,sup{font-size:75%;line-height:0;position:relative;vertical-align:baseline}
sup{top:-.5em}
sub{bottom:-.25em}
img{border:0}
svg:not(:root){overflow:hidden}
figure{margin:0}
fieldset{border:1px solid silver;margin:0 2px;padding:.35em .625em .75em}
legend{border:0;padding:0}
button,input,select,textarea{font-family:inherit;font-size:100%;margin:0}
button,input{line-height:normal}
button,select{text-transform:none}
button,html input[type="button"],input[type="reset"],input[type="submit"]{-webkit-appearance:button;cursor:pointer}
button[disabled],html input[disabled]{cursor:default}
input[type="checkbox"],input[type="radio"]{box-sizing:border-box;padding:0}
button::-moz-focus-inner,input::-moz-focus-inner{border:0;padding:0}
textarea{overflow:auto;vertical-align:top}
table{border-collapse:collapse;border-spacing:0}
*,*::before,*::after{-moz-box-sizing:border-box;-webkit-box-sizing:border-box;box-sizing:border-box}
html,body{font-size:100%}
body{background:#fff;color:rgba(0,0,0,.8);padding:0;margin:0;font-family:"Noto Serif","DejaVu Serif",serif;font-weight:400;font-style:normal;line-height:1;position:relative;cursor:auto;tab-size:4;-moz-osx-font-smoothing:grayscale;-webkit-font-smoothing:antialiased}
a:hover{cursor:pointer}
img,object,embed{max-width:100%;height:auto}
object,embed{height:100%}
img{-ms-interpolation-mode:bicubic}
.left{float:left!important}
.right{float:right!important}
.text-left{text-align:left!important}
.text-right{text-align:right!important}
.text-center{text-align:center!important}
.text-justify{text-align:justify!important}
.hide{display:none}
img,object,svg{display:inline-block;vertical-align:middle}
textarea{height:auto;min-height:50px}
select{width:100%}
.center{margin-left:auto;margin-right:auto}
.stretch{width:100%}
.subheader,.admonitionblock td.content>.title,.audioblock>.title,.exampleblock>.title,.imageblock>.title,.listingblock>.title,.literalblock>.title,.stemblock>.title,.openblock>.title,.paragraph>.title,.quoteblock>.title,table.tableblock>.title,.verseblock>.title,.videoblock>.title,.dlist>.title,.olist>.title,.ulist>.title,.qlist>.title,.hdlist>.title{line-height:1.45;color:#7a2518;font-weight:400;margin-top:0;margin-bottom:.25em}
div,dl,dt,dd,ul,ol,li,h1,h2,h3,#toctitle,.sidebarblock>.content>.title,h4,h5,h6,pre,form,p,blockquote,th,td{margin:0;padding:0;direction:ltr}
a{color:#2156a5;text-decoration:underline;line-height:inherit}
a:hover,a:focus{color:#1d4b8f}
a img{border:0}
p{font-family:inherit;font-weight:400;font-size:1em;line-height:1.6;margin-bottom:1.25em;text-rendering:optimizeLegibility}
p aside{font-size:.875em;line-height:1.35;font-style:italic}
h1,h2,h3,#toctitle,.sidebarblock>.content>.title,h4,h5,h6{font-family:"Open Sans","DejaVu Sans",sans-serif;font-weight:300;font-style:normal;color:#ba3925;text-rendering:optimizeLegibility;margin-top:1em;margin-bottom:.5em;line-height:1.0125em}
h1 small,h2 small,h3 small,#toctitle small,.sidebarblock>.content>.title small,h4 small,h5 small,h6 small{font-size:60%;color:#e99b8f;line-height:0}
h1{font-size:2.125em}
h2{font-size:1.6875em}
h3,#toctitle,.sidebarblock>.content>.title{font-size:1.375em}
h4,h5{font-size:1.125em}
h6{font-size:1em}
hr{border:solid #dddddf;border-width:1px 0 0;clear:both;margin:1.25em 0 1.1875em;height:0}
em,i{font-style:italic;line-height:inherit}
strong,b{font-weight:bold;line-height:inherit}
small{font-size:60%;line-height:inherit}
code{font-family:"Droid Sans Mono","DejaVu Sans Mono",monospace;font-weight:400;color:rgba(0,0,0,.9)}
ul,ol,dl{font-size:1em;line-height:1.6;margin-bottom:1.25em;list-style-position:outside;font-family:inherit}
ul,ol{margin-left:1.5em}
ul li ul,ul li ol{margin-left:1.25em;margin-bottom:0;font-size:1em}
ul.square li ul,ul.circle li ul,ul.disc li ul{list-style:inherit}
ul.square{list-style-type:square}
ul.circle{list-style-type:circle}
ul.disc{list-style-type:disc}
ol li ul,ol li ol{margin-left:1.25em;margin-bottom:0}
dl dt{margin-bottom:.3125em;font-weight:bold}
dl dd{margin-bottom:1.25em}
abbr,acronym{text-transform:uppercase;font-size:90%;color:rgba(0,0,0,.8);border-bottom:1px dotted #ddd;cursor:help}
abbr{text-transform:none}
blockquote{margin:0 0 1.25em;padding:.5625em 1.25em 0 1.1875em;border-left:1px solid #ddd}
blockquote cite{display:block;font-size:.9375em;color:rgba(0,0,0,.6)}
blockquote cite::before{content:"\2014 \0020"}
blockquote cite a,blockquote cite a:visited{color:rgba(0,0,0,.6)}
blockquote,blockquote p{line-height:1.6;color:rgba(0,0,0,.85)}
@media screen and (min-width:768px){h1,h2,h3,#toctitle,.sidebarblock>.content>.title,h4,h5,h6{line-height:1.2}
h1{font-size:2.75em}
h2{font-size:2.3125em}
h3,#toctitle,.sidebarblock>.content>.title{font-size:1.6875em}
h4{font-size:1.4375em}}
table{background:#fff;margin-bottom:1.25em;border:solid 1px #dedede}
table thead,table tfoot{background:#f7f8f7}
table thead tr th,table thead tr td,table tfoot tr th,table tfoot tr td{padding:.5em .625em .625em;font-size:inherit;color:rgba(0,0,0,.8);text-align:left}
table tr th,table tr td{padding:.5625em .625em;font-size:inherit;color:rgba(0,0,0,.8)}
table tr.even,table tr.alt{background:#f8f8f7}
table thead tr th,table tfoot tr th,table tbody tr td,table tr td,table tfoot tr td{display:table-cell;line-height:1.6}
h1,h2,h3,#toctitle,.sidebarblock>.content>.title,h4,h5,h6{line-height:1.2;word-spacing:-.05em}
h1 strong,h2 strong,h3 strong,#toctitle strong,.sidebarblock>.content>.title strong,h4 strong,h5 strong,h6 strong{font-weight:400}
.clearfix::before,.clearfix::after,.float-group::before,.float-group::after{content:" ";display:table}
.clearfix::after,.float-group::after{clear:both}
:not(pre):not([class^=L])>code{font-size:.9375em;font-style:normal!important;letter-spacing:0;padding:.1em .5ex;word-spacing:-.15em;background:#f7f7f8;-webkit-border-radius:4px;border-radius:4px;line-height:1.45;text-rendering:optimizeSpeed;word-wrap:break-word}
:not(pre)>code.nobreak{word-wrap:normal}
:not(pre)>code.nowrap{white-space:nowrap}
pre{color:rgba(0,0,0,.9);font-family:"Droid Sans Mono","DejaVu Sans Mono",monospace;line-height:1.45;text-rendering:optimizeSpeed}
pre code,pre pre{color:inherit;font-size:inherit;line-height:inherit}
pre>code{display:block}
pre.nowrap,pre.nowrap pre{white-space:pre;word-wrap:normal}
em em{font-style:normal}
strong strong{font-weight:400}
.keyseq{color:rgba(51,51,51,.8)}
kbd{font-family:"Droid Sans Mono","DejaVu Sans Mono",monospace;display:inline-block;color:rgba(0,0,0,.8);font-size:.65em;line-height:1.45;background:#f7f7f7;border:1px solid #ccc;-webkit-border-radius:3px;border-radius:3px;-webkit-box-shadow:0 1px 0 rgba(0,0,0,.2),0 0 0 .1em white inset;box-shadow:0 1px 0 rgba(0,0,0,.2),0 0 0 .1em #fff inset;margin:0 .15em;padding:.2em .5em;vertical-align:middle;position:relative;top:-.1em;white-space:nowrap}
.keyseq kbd:first-child{margin-left:0}
.keyseq kbd:last-child{margin-right:0}
.menuseq,.menuref{color:#000}
.menuseq b:not(.caret),.menuref{font-weight:inherit}
.menuseq{word-spacing:-.02em}
.menuseq b.caret{font-size:1.25em;line-height:.8}
.menuseq i.caret{font-weight:bold;text-align:center;width:.45em}
b.button::before,b.button::after{position:relative;top:-1px;font-weight:400}
b.button::before{content:"[";padding:0 3px 0 2px}
b.button::after{content:"]";padding:0 2px 0 3px}
p a>code:hover{color:rgba(0,0,0,.9)}
#header,#content,#footnotes,#footer{width:100%;margin-left:auto;margin-right:auto;margin-top:0;margin-bottom:0;max-width:62.5em;*zoom:1;position:relative;padding-left:.9375em;padding-right:.9375em}
#header::before,#header::after,#content::before,#content::after,#footnotes::before,#footnotes::after,#footer::before,#footer::after{content:" ";display:table}
#header::after,#content::after,#footnotes::after,#footer::after{clear:both}
#content{margin-top:1.25em}
#content::before{content:none}
#header>h1:first-child{color:rgba(0,0,0,.85);margin-top:2.25rem;margin-bottom:0}
#header>h1:first-child+#toc{margin-top:8px;border-top:1px solid #dddddf}
#header>h1:only-child,body.toc2 #header>h1:nth-last-child(2){border-bottom:1px solid #dddddf;padding-bottom:8px}
#header .details{border-bottom:1px solid #dddddf;line-height:1.45;padding-top:.25em;padding-bottom:.25em;padding-left:.25em;color:rgba(0,0,0,.6);display:-ms-flexbox;display:-webkit-flex;display:flex;-ms-flex-flow:row wrap;-webkit-flex-flow:row wrap;flex-flow:row wrap}
#header .details span:first-child{margin-left:-.125em}
#header .details span.email a{color:rgba(0,0,0,.85)}
#header .details br{display:none}
#header .details br+span::before{content:"\00a0\2013\00a0"}
#header .details br+span.author::before{content:"\00a0\22c5\00a0";color:rgba(0,0,0,.85)}
#header .details br+span#revremark::before{content:"\00a0|\00a0"}
#header #revnumber{text-transform:capitalize}
#header #revnumber::after{content:"\00a0"}
#content>h1:first-child:not([class]){color:rgba(0,0,0,.85);border-bottom:1px solid #dddddf;padding-bottom:8px;margin-top:0;padding-top:1rem;margin-bottom:1.25rem}
#toc{border-bottom:1px solid #e7e7e9;padding-bottom:.5em}
#toc>ul{margin-left:.125em}
#toc ul.sectlevel0>li>a{font-style:italic}
#toc ul.sectlevel0 ul.sectlevel1{margin:.5em 0}
#toc ul{font-family:"Open Sans","DejaVu Sans",sans-serif;list-style-type:none}
#toc li{line-height:1.3334;margin-top:.3334em}
#toc a{text-decoration:none}
#toc a:active{text-decoration:underline}
#toctitle{color:#7a2518;font-size:1.2em}
@media screen and (min-width:768px){#toctitle{font-size:1.375em}
body.toc2{padding-left:15em;padding-right:0}
#toc.toc2{margin-top:0!important;background:#f8f8f7;position:fixed;width:15em;left:0;top:0;border-right:1px solid #e7e7e9;border-top-width:0!important;border-bottom-width:0!important;z-index:1000;padding:1.25em 1em;height:100%;overflow:auto}
#toc.toc2 #toctitle{margin-top:0;margin-bottom:.8rem;font-size:1.2em}
#toc.toc2>ul{font-size:.9em;margin-bottom:0}
#toc.toc2 ul ul{margin-left:0;padding-left:1em}
#toc.toc2 ul.sectlevel0 ul.sectlevel1{padding-left:0;margin-top:.5em;margin-bottom:.5em}
body.toc2.toc-right{padding-left:0;padding-right:15em}
body.toc2.toc-right #toc.toc2{border-right-width:0;border-left:1px solid #e7e7e9;left:auto;right:0}}
@media screen and (min-width:1280px){body.toc2{padding-left:20em;padding-right:0}
#toc.toc2{width:20em}
#toc.toc2 #toctitle{font-size:1.375em}
#toc.toc2>ul{font-size:.95em}
#toc.toc2 ul ul{padding-left:1.25em}
body.toc2.toc-right{padding-left:0;padding-right:20em}}
#content #toc{border-style:solid;border-width:1px;border-color:#e0e0dc;margin-bottom:1.25em;padding:1.25em;background:#f8f8f7;-webkit-border-radius:4px;border-radius:4px}
#content #toc>:first-child{margin-top:0}
#content #toc>:last-child{margin-bottom:0}
#footer{max-width:100%;background:rgba(0,0,0,.8);padding:1.25em}
#footer-text{color:rgba(255,255,255,.8);line-height:1.44}
#content{margin-bottom:.625em}
.sect1{padding-bottom:.625em}
@media screen and (min-width:768px){#content{margin-bottom:1.25em}
.sect1{padding-bottom:1.25em}}
.sect1:last-child{padding-bottom:0}
.sect1+.sect1{border-top:1px solid #e7e7e9}
#content h1>a.anchor,h2>a.anchor,h3>a.anchor,#toctitle>a.anchor,.sidebarblock>.content>.title>a.anchor,h4>a.anchor,h5>a.anchor,h6>a.anchor{position:absolute;z-index:1001;width:1.5ex;margin-left:-1.5ex;display:block;text-decoration:none!important;visibility:hidden;text-align:center;font-weight:400}
#content h1>a.anchor::before,h2>a.anchor::before,h3>a.anchor::before,#toctitle>a.anchor::before,.sidebarblock>.content>.title>a.anchor::before,h4>a.anchor::before,h5>a.anchor::before,h6>a.anchor::before{content:"\00A7";font-size:.85em;display:block;padding-top:.1em}
#content h1:hover>a.anchor,#content h1>a.anchor:hover,h2:hover>a.anchor,h2>a.anchor:hover,h3:hover>a.anchor,#toctitle:hover>a.anchor,.sidebarblock>.content>.title:hover>a.anchor,h3>a.anchor:hover,#toctitle>a.anchor:hover,.sidebarblock>.content>.title>a.anchor:hover,h4:hover>a.anchor,h4>a.anchor:hover,h5:hover>a.anchor,h5>a.anchor:hover,h6:hover>a.anchor,h6>a.anchor:hover{visibility:visible}
#content h1>a.link,h2>a.link,h3>a.link,#toctitle>a.link,.sidebarblock>.content>.title>a.link,h4>a.link,h5>a.link,h6>a.link{color:#ba3925;text-decoration:none}
#content h1>a.link:hover,h2>a.link:hover,h3>a.link:hover,#toctitle>a.link:hover,.sidebarblock>.content>.title>a.link:hover,h4>a.link:hover,h5>a.link:hover,h6>a.link:hover{color:#a53221}
details,.audioblock,.imageblock,.literalblock,.listingblock,.stemblock,.videoblock{margin-bottom:1.25em}
details>summary:first-of-type{cursor:pointer;display:list-item;outline:none;margin-bottom:.75em}
.admonitionblock td.content>.title,.audioblock>.title,.exampleblock>.title,.imageblock>.title,.listingblock>.title,.literalblock>.title,.stemblock>.title,.openblock>.title,.paragraph>.title,.quoteblock>.title,table.tableblock>.title,.verseblock>.title,.videoblock>.title,.dlist>.title,.olist>.title,.ulist>.title,.qlist>.title,.hdlist>.title{text-rendering:optimizeLegibility;text-align:left;font-family:"Noto Serif","DejaVu Serif",serif;font-size:1rem;font-style:italic}
table.tableblock.fit-content>caption.title{white-space:nowrap;width:0}
.paragraph.lead>p,#preamble>.sectionbody>[class="paragraph"]:first-of-type p{font-size:1.21875em;line-height:1.6;color:rgba(0,0,0,.85)}
table.tableblock #preamble>.sectionbody>[class="paragraph"]:first-of-type p{font-size:inherit}
.admonitionblock>table{border-collapse:separate;border:0;background:none;width:100%}
.admonitionblock>table td.icon{text-align:center;width:80px}
.admonitionblock>table td.icon img{max-width:none}
.admonitionblock>table td.icon .title{font-weight:bold;font-family:"Open Sans","DejaVu Sans",sans-serif;text-transform:uppercase}
.admonitionblock>table td.content{padding-left:1.125em;padding-right:1.25em;border-left:1px solid #dddddf;color:rgba(0,0,0,.6)}
.admonitionblock>table td.content>:last-child>:last-child{margin-bottom:0}
.exampleblock>.content{border-style:solid;border-width:1px;border-color:#e6e6e6;margin-bottom:1.25em;padding:1.25em;background:#fff;-webkit-border-radius:4px;border-radius:4px}
.exampleblock>.content>:first-child{margin-top:0}
.exampleblock>.content>:last-child{margin-bottom:0}
.sidebarblock{border-style:solid;border-width:1px;border-color:#dbdbd6;margin-bottom:1.25em;padding:1.25em;background:#f3f3f2;-webkit-border-radius:4px;border-radius:4px}
.sidebarblock>:first-child{margin-top:0}
.sidebarblock>:last-child{margin-bottom:0}
.sidebarblock>.content>.title{color:#7a2518;margin-top:0;text-align:center}
.exampleblock>.content>:last-child>:last-child,.exampleblock>.content .olist>ol>li:last-child>:last-child,.exampleblock>.content .ulist>ul>li:last-child>:last-child,.exampleblock>.content .qlist>ol>li:last-child>:last-child,.sidebarblock>.content>:last-child>:last-child,.sidebarblock>.content .olist>ol>li:last-child>:last-child,.sidebarblock>.content .ulist>ul>li:last-child>:last-child,.sidebarblock>.content .qlist>ol>li:last-child>:last-child{margin-bottom:0}
.literalblock pre,.listingblock>.content>pre{-webkit-border-radius:4px;border-radius:4px;word-wrap:break-word;overflow-x:auto;padding:1em;font-size:.8125em}
@media screen and (min-width:768px){.literalblock pre,.listingblock>.content>pre{font-size:.90625em}}
@media screen and (min-width:1280px){.literalblock pre,.listingblock>.content>pre{font-size:1em}}
.literalblock pre,.listingblock>.content>pre:not(.highlight),.listingblock>.content>pre[class="highlight"],.listingblock>.content>pre[class^="highlight "]{background:#f7f7f8}
.literalblock.output pre{color:#f7f7f8;background:rgba(0,0,0,.9)}
.listingblock>.content{position:relative}
.listingblock code[data-lang]::before{display:none;content:attr(data-lang);position:absolute;font-size:.75em;top:.425rem;right:.5rem;line-height:1;text-transform:uppercase;color:inherit;opacity:.5}
.listingblock:hover code[data-lang]::before{display:block}
.listingblock.terminal pre .command::before{content:attr(data-prompt);padding-right:.5em;color:inherit;opacity:.5}
.listingblock.terminal pre .command:not([data-prompt])::before{content:"$"}
.listingblock pre.highlightjs{padding:0}
.listingblock pre.highlightjs>code{padding:1em;-webkit-border-radius:4px;border-radius:4px}
.listingblock pre.prettyprint{border-width:0}
.prettyprint{background:#f7f7f8}
pre.prettyprint .linenums{line-height:1.45;margin-left:2em}
pre.prettyprint li{background:none;list-style-type:inherit;padding-left:0}
pre.prettyprint li code[data-lang]::before{opacity:1}
pre.prettyprint li:not(:first-child) code[data-lang]::before{display:none}
table.linenotable{border-collapse:separate;border:0;margin-bottom:0;background:none}
table.linenotable td[class]{color:inherit;vertical-align:top;padding:0;line-height:inherit;white-space:normal}
table.linenotable td.code{padding-left:.75em}
table.linenotable td.linenos{border-right:1px solid currentColor;opacity:.35;padding-right:.5em}
pre.pygments .lineno{border-right:1px solid currentColor;opacity:.35;display:inline-block;margin-right:.75em}
pre.pygments .lineno::before{content:"";margin-right:-.125em}
.quoteblock{margin:0 1em 1.25em 1.5em;display:table}
.quoteblock:not(.excerpt)>.title{margin-left:-1.5em;margin-bottom:.75em}
.quoteblock blockquote,.quoteblock p{color:rgba(0,0,0,.85);font-size:1.15rem;line-height:1.75;word-spacing:.1em;letter-spacing:0;font-style:italic;text-align:justify}
.quoteblock blockquote{margin:0;padding:0;border:0}
.quoteblock blockquote::before{content:"\201c";float:left;font-size:2.75em;font-weight:bold;line-height:.6em;margin-left:-.6em;color:#7a2518;text-shadow:0 1px 2px rgba(0,0,0,.1)}
.quoteblock blockquote>.paragraph:last-child p{margin-bottom:0}
.quoteblock .attribution{margin-top:.75em;margin-right:.5ex;text-align:right}
.verseblock{margin:0 1em 1.25em}
.verseblock pre{font-family:"Open Sans","DejaVu Sans",sans;font-size:1.15rem;color:rgba(0,0,0,.85);font-weight:300;text-rendering:optimizeLegibility}
.verseblock pre strong{font-weight:400}
.verseblock .attribution{margin-top:1.25rem;margin-left:.5ex}
.quoteblock .attribution,.verseblock .attribution{font-size:.9375em;line-height:1.45;font-style:italic}
.quoteblock .attribution br,.verseblock .attribution br{display:none}
.quoteblock .attribution cite,.verseblock .attribution cite{display:block;letter-spacing:-.025em;color:rgba(0,0,0,.6)}
.quoteblock.abstract blockquote::before,.quoteblock.excerpt blockquote::before,.quoteblock .quoteblock blockquote::before{display:none}
.quoteblock.abstract blockquote,.quoteblock.abstract p,.quoteblock.excerpt blockquote,.quoteblock.excerpt p,.quoteblock .quoteblock blockquote,.quoteblock .quoteblock p{line-height:1.6;word-spacing:0}
.quoteblock.abstract{margin:0 1em 1.25em;display:block}
.quoteblock.abstract>.title{margin:0 0 .375em;font-size:1.15em;text-align:center}
.quoteblock.excerpt>blockquote,.quoteblock .quoteblock{padding:0 0 .25em 1em;border-left:.25em solid #dddddf}
.quoteblock.excerpt,.quoteblock .quoteblock{margin-left:0}
.quoteblock.excerpt blockquote,.quoteblock.excerpt p,.quoteblock .quoteblock blockquote,.quoteblock .quoteblock p{color:inherit;font-size:1.0625rem}
.quoteblock.excerpt .attribution,.quoteblock .quoteblock .attribution{color:inherit;text-align:left;margin-right:0}
table.tableblock{max-width:100%;border-collapse:separate}
p.tableblock:last-child{margin-bottom:0}
td.tableblock>.content>:last-child{margin-bottom:-1.25em}
td.tableblock>.content>:last-child.sidebarblock{margin-bottom:0}
table.tableblock,th.tableblock,td.tableblock{border:0 solid #dedede}
table.grid-all>thead>tr>.tableblock,table.grid-all>tbody>tr>.tableblock{border-width:0 1px 1px 0}
table.grid-all>tfoot>tr>.tableblock{border-width:1px 1px 0 0}
table.grid-cols>*>tr>.tableblock{border-width:0 1px 0 0}
table.grid-rows>thead>tr>.tableblock,table.grid-rows>tbody>tr>.tableblock{border-width:0 0 1px}
table.grid-rows>tfoot>tr>.tableblock{border-width:1px 0 0}
table.grid-all>*>tr>.tableblock:last-child,table.grid-cols>*>tr>.tableblock:last-child{border-right-width:0}
table.grid-all>tbody>tr:last-child>.tableblock,table.grid-all>thead:last-child>tr>.tableblock,table.grid-rows>tbody>tr:last-child>.tableblock,table.grid-rows>thead:last-child>tr>.tableblock{border-bottom-width:0}
table.frame-all{border-width:1px}
table.frame-sides{border-width:0 1px}
table.frame-topbot,table.frame-ends{border-width:1px 0}
table.stripes-all tr,table.stripes-odd tr:nth-of-type(odd),table.stripes-even tr:nth-of-type(even),table.stripes-hover tr:hover{background:#f8f8f7}
th.halign-left,td.halign-left{text-align:left}
th.halign-right,td.halign-right{text-align:right}
th.halign-center,td.halign-center{text-align:center}
th.valign-top,td.valign-top{vertical-align:top}
th.valign-bottom,td.valign-bottom{vertical-align:bottom}
th.valign-middle,td.valign-middle{vertical-align:middle}
table thead th,table tfoot th{font-weight:bold}
tbody tr th{display:table-cell;line-height:1.6;background:#f7f8f7}
tbody tr th,tbody tr th p,tfoot tr th,tfoot tr th p{color:rgba(0,0,0,.8);font-weight:bold}
p.tableblock>code:only-child{background:none;padding:0}
p.tableblock{font-size:1em}
ol{margin-left:1.75em}
ul li ol{margin-left:1.5em}
dl dd{margin-left:1.125em}
dl dd:last-child,dl dd:last-child>:last-child{margin-bottom:0}
ol>li p,ul>li p,ul dd,ol dd,.olist .olist,.ulist .ulist,.ulist .olist,.olist .ulist{margin-bottom:.625em}
ul.checklist,ul.none,ol.none,ul.no-bullet,ol.no-bullet,ol.unnumbered,ul.unstyled,ol.unstyled{list-style-type:none}
ul.no-bullet,ol.no-bullet,ol.unnumbered{margin-left:.625em}
ul.unstyled,ol.unstyled{margin-left:0}
ul.checklist{margin-left:.625em}
ul.checklist li>p:first-child>.fa-square-o:first-child,ul.checklist li>p:first-child>.fa-check-square-o:first-child{width:1.25em;font-size:.8em;position:relative;bottom:.125em}
ul.checklist li>p:first-child>input[type="checkbox"]:first-child{margin-right:.25em}
ul.inline{display:-ms-flexbox;display:-webkit-box;display:flex;-ms-flex-flow:row wrap;-webkit-flex-flow:row wrap;flex-flow:row wrap;list-style:none;margin:0 0 .625em -1.25em}
ul.inline>li{margin-left:1.25em}
.unstyled dl dt{font-weight:400;font-style:normal}
ol.arabic{list-style-type:decimal}
ol.decimal{list-style-type:decimal-leading-zero}
ol.loweralpha{list-style-type:lower-alpha}
ol.upperalpha{list-style-type:upper-alpha}
ol.lowerroman{list-style-type:lower-roman}
ol.upperroman{list-style-type:upper-roman}
ol.lowergreek{list-style-type:lower-greek}
.hdlist>table,.colist>table{border:0;background:none}
.hdlist>table>tbody>tr,.colist>table>tbody>tr{background:none}
td.hdlist1,td.hdlist2{vertical-align:top;padding:0 .625em}
td.hdlist1{font-weight:bold;padding-bottom:1.25em}
.literalblock+.colist,.listingblock+.colist{margin-top:-.5em}
.colist td:not([class]):first-child{padding:.4em .75em 0;line-height:1;vertical-align:top}
.colist td:not([class]):first-child img{max-width:none}
.colist td:not([class]):last-child{padding:.25em 0}
.thumb,.th{line-height:0;display:inline-block;border:solid 4px #fff;-webkit-box-shadow:0 0 0 1px #ddd;box-shadow:0 0 0 1px #ddd}
.imageblock.left{margin:.25em .625em 1.25em 0}
.imageblock.right{margin:.25em 0 1.25em .625em}
.imageblock>.title{margin-bottom:0}
.imageblock.thumb,.imageblock.th{border-width:6px}
.imageblock.thumb>.title,.imageblock.th>.title{padding:0 .125em}
.image.left,.image.right{margin-top:.25em;margin-bottom:.25em;display:inline-block;line-height:0}
.image.left{margin-right:.625em}
.image.right{margin-left:.625em}
a.image{text-decoration:none;display:inline-block}
a.image object{pointer-events:none}
sup.footnote,sup.footnoteref{font-size:.875em;position:static;vertical-align:super}
sup.footnote a,sup.footnoteref a{text-decoration:none}
sup.footnote a:active,sup.footnoteref a:active{text-decoration:underline}
#footnotes{padding-top:.75em;padding-bottom:.75em;margin-bottom:.625em}
#footnotes hr{width:20%;min-width:6.25em;margin:-.25em 0 .75em;border-width:1px 0 0}
#footnotes .footnote{padding:0 .375em 0 .225em;line-height:1.3334;font-size:.875em;margin-left:1.2em;margin-bottom:.2em}
#footnotes .footnote a:first-of-type{font-weight:bold;text-decoration:none;margin-left:-1.05em}
#footnotes .footnote:last-of-type{margin-bottom:0}
#content #footnotes{margin-top:-.625em;margin-bottom:0;padding:.75em 0}
.gist .file-data>table{border:0;background:#fff;width:100%;margin-bottom:0}
.gist .file-data>table td.line-data{width:99%}
div.unbreakable{page-break-inside:avoid}
.big{font-size:larger}
.small{font-size:smaller}
.underline{text-decoration:underline}
.overline{text-decoration:overline}
.line-through{text-decoration:line-through}
.aqua{color:#00bfbf}
.aqua-background{background:#00fafa}
.black{color:#000}
.black-background{background:#000}
.blue{color:#0000bf}
.blue-background{background:#0000fa}
.fuchsia{color:#bf00bf}
.fuchsia-background{background:#fa00fa}
.gray{color:#606060}
.gray-background{background:#7d7d7d}
.green{color:#006000}
.green-background{background:#007d00}
.lime{color:#00bf00}
.lime-background{background:#00fa00}
.maroon{color:#600000}
.maroon-background{background:#7d0000}
.navy{color:#000060}
.navy-background{background:#00007d}
.olive{color:#606000}
.olive-background{background:#7d7d00}
.purple{color:#600060}
.purple-background{background:#7d007d}
.red{color:#bf0000}
.red-background{background:#fa0000}
.silver{color:#909090}
.silver-background{background:#bcbcbc}
.teal{color:#006060}
.teal-background{background:#007d7d}
.white{color:#bfbfbf}
.white-background{background:#fafafa}
.yellow{color:#bfbf00}
.yellow-background{background:#fafa00}
span.icon>.fa{cursor:default}
a span.icon>.fa{cursor:inherit}
.admonitionblock td.icon [class^="fa icon-"]{font-size:2.5em;text-shadow:1px 1px 2px rgba(0,0,0,.5);cursor:default}
.admonitionblock td.icon .icon-note::before{content:"\f05a";color:#19407c}
.admonitionblock td.icon .icon-tip::before{content:"\f0eb";text-shadow:1px 1px 2px rgba(155,155,0,.8);color:#111}
.admonitionblock td.icon .icon-warning::before{content:"\f071";color:#bf6900}
.admonitionblock td.icon .icon-caution::before{content:"\f06d";color:#bf3400}
.admonitionblock td.icon .icon-important::before{content:"\f06a";color:#bf0000}
.conum[data-value]{display:inline-block;color:#fff!important;background:rgba(0,0,0,.8);-webkit-border-radius:100px;border-radius:100px;text-align:center;font-size:.75em;width:1.67em;height:1.67em;line-height:1.67em;font-family:"Open Sans","DejaVu Sans",sans-serif;font-style:normal;font-weight:bold}
.conum[data-value] *{color:#fff!important}
.conum[data-value]+b{display:none}
.conum[data-value]::after{content:attr(data-value)}
pre .conum[data-value]{position:relative;top:-.125em}
b.conum *{color:inherit!important}
.conum:not([data-value]):empty{display:none}
dt,th.tableblock,td.content,div.footnote{text-rendering:optimizeLegibility}
h1,h2,p,td.content,span.alt{letter-spacing:-.01em}
p strong,td.content strong,div.footnote strong{letter-spacing:-.005em}
p,blockquote,dt,td.content,span.alt{font-size:1.0625rem}
p{margin-bottom:1.25rem}
.sidebarblock p,.sidebarblock dt,.sidebarblock td.content,p.tableblock{font-size:1em}
.exampleblock>.content{background:#fffef7;border-color:#e0e0dc;-webkit-box-shadow:0 1px 4px #e0e0dc;box-shadow:0 1px 4px #e0e0dc}
.print-only{display:none!important}
@page{margin:1.25cm .75cm}
@media print{*{-webkit-box-shadow:none!important;box-shadow:none!important;text-shadow:none!important}
html{font-size:80%}
a{color:inherit!important;text-decoration:underline!important}
a.bare,a[href^="#"],a[href^="mailto:"]{text-decoration:none!important}
a[href^="http:"]:not(.bare)::after,a[href^="https:"]:not(.bare)::after{content:"(" attr(href) ")";display:inline-block;font-size:.875em;padding-left:.25em}
abbr[title]::after{content:" (" attr(title) ")"}
pre,blockquote,tr,img,object,svg{page-break-inside:avoid}
thead{display:table-header-group}
svg{max-width:100%}
p,blockquote,dt,td.content{font-size:1em;orphans:3;widows:3}
h2,h3,#toctitle,.sidebarblock>.content>.title{page-break-after:avoid}
#toc,.sidebarblock,.exampleblock>.content{background:none!important}
#toc{border-bottom:1px solid #dddddf!important;padding-bottom:0!important}
body.book #header{text-align:center}
body.book #header>h1:first-child{border:0!important;margin:2.5em 0 1em}
body.book #header .details{border:0!important;display:block;padding:0!important}
body.book #header .details span:first-child{margin-left:0!important}
body.book #header .details br{display:block}
body.book #header .details br+span::before{content:none!important}
body.book #toc{border:0!important;text-align:left!important;padding:0!important;margin:0!important}
body.book #toc,body.book #preamble,body.book h1.sect0,body.book .sect1>h2{page-break-before:always}
.listingblock code[data-lang]::before{display:block}
#footer{padding:0 .9375em}
.hide-on-print{display:none!important}
.print-only{display:block!important}
.hide-for-print{display:none!important}
.show-for-print{display:inherit!important}}
@media print,amzn-kf8{#header>h1:first-child{margin-top:1.25rem}
.sect1{padding:0!important}
.sect1+.sect1{border:0}
#footer{background:none}
#footer-text{color:rgba(0,0,0,.6);font-size:.9em}}
@media amzn-kf8{#header,#content,#footnotes,#footer{padding:0}}
</style>
</head>
<body class="book toc2 toc-left">
<div id="header">
<h1>Ersatz Server User Guide</h1>
<div class="details">
<span id="author" class="author">Christopher J. Stehno</span><br>
<span id="revnumber">version 3.2.0,</span>
<span id="revdate">April 2023</span>
</div>
<div id="toc" class="toc2">
<div id="toctitle">Table of Contents</div>
<ul class="sectlevel1">
<li><a href="#_introduction">Introduction</a></li>
<li><a href="#_whats_new">What&#8217;s New</a>
<ul class="sectlevel2">
<li><a href="#_in_3_2">In 3.2</a></li>
<li><a href="#_in_3_1">In 3.1</a></li>
<li><a href="#_in_3_0">In 3.0</a>
<ul class="sectlevel3">
<li><a href="#_migrating_to_3_0">Migrating to 3.0</a></li>
</ul>
</li>
<li><a href="#_in_2_0">In 2.0</a>
<ul class="sectlevel3">
<li><a href="#_migrating_to_2_0">Migrating to 2.0</a></li>
</ul>
</li>
<li><a href="#_in_1_9">In 1.9</a></li>
<li><a href="#_in_1_8">In 1.8</a></li>
</ul>
</li>
<li><a href="#_getting_started">Getting Started</a>
<ul class="sectlevel2">
<li><a href="#_gradle">Gradle</a></li>
<li><a href="#_maven">Maven</a></li>
<li><a href="#_writing_a_test">Writing a Test</a></li>
</ul>
</li>
<li><a href="#_junit_extension">JUnit Extension</a>
<ul class="sectlevel2">
<li><a href="#_ersatzserverextension">ErsatzServerExtension</a></li>
<li><a href="#_sharedersatzserverextension">SharedErsatzServerExtension</a></li>
</ul>
</li>
<li><a href="#_server_lifecycle">Server Lifecycle</a>
<ul class="sectlevel2">
<li><a href="#_configuration">Configuration</a></li>
<li><a href="#_matching">Matching</a></li>
<li><a href="#_verification">Verification</a></li>
<li><a href="#_cleanup">Cleanup</a></li>
</ul>
</li>
<li><a href="#_server_configuration">Server Configuration</a>
<ul class="sectlevel2">
<li><a href="#_ports">Ports</a></li>
<li><a href="#_auto_start">Auto-Start</a></li>
<li><a href="#_https">HTTPS</a>
<ul class="sectlevel3">
<li><a href="#_keystore">Keystore</a></li>
</ul>
</li>
<li><a href="#_request_timeout">Request Timeout</a></li>
<li><a href="#_report_to_console">Report-to-Console</a></li>
<li><a href="#_logging_response_content">Logging Response Content</a></li>
<li><a href="#_server_threads">Server Threads</a></li>
<li><a href="#_content_transformation">Content Transformation</a></li>
<li><a href="#_expectations">Expectations</a></li>
<li><a href="#_requirements">Requirements</a></li>
</ul>
</li>
<li><a href="#_request_decoders">Request Decoders</a>
<ul class="sectlevel2">
<li><a href="#_provided_decoders">Provided Decoders</a></li>
<li><a href="#_json_decoders">JSON Decoders</a>
<ul class="sectlevel3">
<li><a href="#_groovy">Groovy</a></li>
<li><a href="#_jackson">Jackson</a></li>
</ul>
</li>
</ul>
</li>
<li><a href="#_response_encoders">Response Encoders</a>
<ul class="sectlevel2">
<li><a href="#_provided_encoders">Provided Encoders</a></li>
<li><a href="#_json_encoders">JSON Encoders</a>
<ul class="sectlevel3">
<li><a href="#_groovy_2">Groovy</a></li>
<li><a href="#_jackson_2">Jackson</a></li>
</ul>
</li>
</ul>
</li>
<li><a href="#_request_requirements">Request Requirements</a></li>
<li><a href="#_request_expectations">Request Expectations</a>
<ul class="sectlevel2">
<li><a href="#_request_methods">Request Methods</a>
<ul class="sectlevel3">
<li><a href="#_head">HEAD</a></li>
<li><a href="#_get">GET</a></li>
<li><a href="#_options">OPTIONS</a></li>
<li><a href="#_post">POST</a></li>
<li><a href="#_put">PUT</a></li>
<li><a href="#_delete">DELETE</a></li>
<li><a href="#_patch">PATCH</a></li>
<li><a href="#_any">ANY</a></li>
<li><a href="#_generic_method">Generic Method</a></li>
<li><a href="#_trace">TRACE</a></li>
</ul>
</li>
<li><a href="#_verification_2">Verification</a></li>
<li><a href="#_request_matching">Request Matching</a>
<ul class="sectlevel3">
<li><a href="#_hamcrest_matchers">Hamcrest Matchers</a></li>
</ul>
</li>
<li><a href="#_specialized_matchers">Specialized Matchers</a>
<ul class="sectlevel3">
<li><a href="#_matching_cookies">Matching Cookies</a>
<ul class="sectlevel4">
<li><a href="#_by_name_and_matcher">By Name and Matcher</a></li>
<li><a href="#_by_name_and_value">By Name and Value</a></li>
<li><a href="#_multiple_cookies">Multiple Cookies</a></li>
</ul>
</li>
<li><a href="#_overall_matcher">Overall Matcher</a></li>
<li><a href="#_multipart_request_content">Multipart Request Content</a></li>
</ul>
</li>
<li><a href="#_response_building">Response Building</a>
<ul class="sectlevel3">
<li><a href="#_request_response_compression">Request / Response Compression</a></li>
<li><a href="#_chunked_response">Chunked Response</a></li>
<li><a href="#_multipart_response_content">Multipart Response Content</a></li>
<li><a href="#_request_forwarding">Request Forwarding</a></li>
</ul>
</li>
</ul>
</li>
<li><a href="#_proxy_server">Proxy Server</a></li>
<li><a href="#_shadow_jar">Shadow Jar</a>
<ul class="sectlevel2">
<li><a href="#_gradle_2">Gradle</a></li>
<li><a href="#_maven_2">Maven</a></li>
</ul>
</li>
<li><a href="#_common_usage_examples">Common Usage Examples</a>
<ul class="sectlevel2">
<li><a href="#_url_encoded_form_requests">Url-Encoded Form Requests</a></li>
<li><a href="#_file_upload_post">File Upload (POST)</a></li>
<li><a href="#_file_download_get">File Download (GET)</a></li>
<li><a href="#_kotlin_usage">Kotlin Usage</a></li>
<li><a href="#_matching_xml_body_content">Matching XML Body Content</a></li>
<li><a href="#_forwarding_to_another_server_for_response">Forwarding to Another Server for Response</a></li>
<li><a href="#_using_test_things_with_ersatz">Using Test-Things with Ersatz</a></li>
</ul>
</li>
<li><a href="#_appendices">Appendices</a>
<ul class="sectlevel2">
<li><a href="#_a_development_philosophy">A. Development Philosophy</a></li>
<li><a href="#_b_license">B. License</a></li>
</ul>
</li>
</ul>
</div>
</div>
<div id="content">
<div class="sect1">
<h2 id="_introduction">Introduction</h2>
<div class="sectionbody">
<div class="paragraph">
<p>The Ersatz Server is an HTTP client testing tool, which allows for request and response expectations to be configured in a flexible manner. The expectations will respond to each request in a configured manner allowing tests with different responses and/or error conditions without having to write a lot of boilerplate code.</p>
</div>
<div class="paragraph">
<p>The "mock" server is not really a mock at all, it is an embedded Undertow HTTP server which registers the configured expectations as routes and then responds according to the configured expectation behavior. This approach may seem overly heavy; however, testing an HTTP client can involve a lot of internal state and interactions that the developer is generally unaware of (and should be) - trying to mock those interactions with a pure mocking framework will get out of hand very quickly, and Undertow starts up very quickly.</p>
</div>
<div class="paragraph">
<p>Ersatz provides a balance of mock-like expectation behavior with a real HTTP interface and all of the underlying interactions in place. This allows for rich unit testing, which is what you were trying to do in the first place.</p>
</div>
<div class="paragraph">
<p>Ersatz is written in Java 15 due to its use of the modern functional libraries; however, there is an extension library (ersatz-groovy) which provides a Groovy DSL and extensions to the base library.</p>
</div>
<div class="paragraph">
<p>Lastly, Ersatz is developed with testing in mind. It does not favor any specific testing framework, but it does work well with both the JUnit and Spock frameworks.</p>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<div class="title">Note</div>
</td>
<td class="content">
The code examples throughout this document are written with either Java or Groovy code. Please note that all features are available to both languages and will be configured in a similar manner in each.
</td>
</tr>
</table>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_whats_new">What&#8217;s New</h2>
<div class="sectionbody">
<div class="sect2">
<h3 id="_in_3_2">In 3.2</h3>
<div class="ulist">
<ul>
<li>
<p>Added generic <code>request</code> expectations to the <code>Expectations</code> interface - this allows programmatic specification of the request method.</p>
</li>
<li>
<p>Added static constants for commonly used HTTP headers and response status codes (see <code>HttpHeaders</code> and <code>StatusCode</code>).</p>
</li>
<li>
<p>Added JSON encoder and decoder implementations to the Groovy extension (based on Groovy internal support). These used to be in the core library, but were removed when it was converted to Java.</p>
</li>
<li>
<p>Added request forwarding, such that a matched request can be forwarded to another server, and have that response returned as the response to the original request.</p>
</li>
<li>
<p>Resurrected the <code>ErsatzProxyServer</code> stand-alone proxy server component (temporarily) - the represented functionality will be replaced by the aforementioned request forwarding.</p>
</li>
<li>
<p>Added more functionality to the <code>ErsatzServerExtension</code> JUnit 5 helper class, and added a <code>SharedErsatzServerExtension</code> which uses a shared server instance for all test methods in a test class - rather than creating and destroying it for each test.</p>
</li>
<li>
<p>Minor tweaks, fixes, and updates.</p>
</li>
</ul>
</div>
</div>
<div class="sect2">
<h3 id="_in_3_1">In 3.1</h3>
<div class="ulist">
<ul>
<li>
<p>Reduced the number of IO and Worker threads configured in Undertow by default.</p>
</li>
<li>
<p>Provided a means of configuring the IO/Worker threads in the underlying server (see <code>ServerConfig::serverThreads(int,int)</code>).</p>
</li>
<li>
<p>Big refactoring of how the internal matchers were used and configured as well as provided a more robust matcher framework for the API itself.</p>
</li>
<li>
<p>Added support for <code>Predicate</code>-based matchers.</p>
</li>
<li>
<p>Added global <a href="#_request_requirements">Request Requirements</a> - now you can configure request attributes at the global level</p>
</li>
</ul>
</div>
</div>
<div class="sect2">
<h3 id="_in_3_0">In 3.0</h3>
<div class="ulist">
<ul>
<li>
<p>Not directly backward compatible with the 2.x codebase (see migration notes below).</p>
</li>
<li>
<p>Requires Java 17+</p>
</li>
<li>
<p>Removed support for legacy JUnit&#8201;&#8212;&#8201;now only 5+ is directly supported.</p>
</li>
<li>
<p>Added new option, <code>ServerConfig::logResponseContent()</code>, to enable response content rendering (disabled by default).</p>
</li>
<li>
<p>Removed Web Sockets support –- this may be re-implemented later with a more stable API if there is any interest.</p>
</li>
<li>
<p>Removed the <code>ErsatzProxy</code> component – this may be re-implemented later if there is any interest.</p>
</li>
<li>
<p>Removed built-in support for JSON encoding/decoding to remove the external dependency. See the Encoding and Decoding sections for example source for implementing your own.</p>
</li>
<li>
<p>Extracted the Groovy API into a separate library (<code>ersatz-groovy</code>) so that the main library could be implemented in Java without Groovy dependencies.</p>
</li>
<li>
<p>Added more predefined ContentType constants.</p>
</li>
<li>
<p>Added more encoders and decoders for common scenarios.</p>
</li>
<li>
<p>Updated the dependencies and fixed some exposed dependency isolation issues.</p>
</li>
<li>
<p>No longer published in Bintray (since it&#8217;s dead) - now only Maven Central (thanks JFrog)</p>
</li>
<li>
<p>Removed build-in authentication support&#8201;&#8212;&#8201;there is helper to implement BASIC, if needed.</p>
</li>
<li>
<p>There are more unit tests and they are organized in a more sane manner</p>
</li>
<li>
<p>Repackaged the project from <code>com.stehno.</code> &#8594; <code>io.github.cjstehno.</code></p>
</li>
<li>
<p>Replaced <code>protocol(String)</code> request matcher with <code>secure(boolean)</code></p>
</li>
</ul>
</div>
<div class="sect3">
<h4 id="_migrating_to_3_0">Migrating to 3.0</h4>
<div class="ulist">
<ul>
<li>
<p>You will need to update your dependencies to reflect the new group name, as well as the version.</p>
</li>
<li>
<p>You will need to change the package for Ersatz classes to the new <code>io.github.cjstehno.</code> root package (replacing <code>com.stehno.</code> with <code>io.github.cjstehno.</code> should do the trick).</p>
</li>
<li>
<p>If you use the proxy or web sockets testing support, there is no upgrade path. Please create an <a href="https://github.com/cjstehno/ersatz/issues">Issue</a> or start a <a href="https://github.com/cjstehno/ersatz/discussions">Discussion</a> to show that you are interested in one or both of these features.</p>
</li>
<li>
<p>If you use Groovy for development, you will need to change your dependency references from using the <code>ersatz</code> library to use the new <code>ersatz-groovy</code> library. The same change applies if you are using the safe version of the library. You will also want to change your <code>ErsatzServer</code> uses to the <code>GroovyErsatzServer</code> to use the full Groovy DSL.</p>
</li>
<li>
<p>If you are using the legacy JUnit support helper, you will either need to implement the support class yourself (optionally using the source from the 2.x codebase), or you can submit an <a href="https://github.com/cjstehno/ersatz/issues">Issue</a> or start a <a href="https://github.com/cjstehno/ersatz/discussions">Discussion</a> to show that you are interested in one or both of these features.</p>
</li>
<li>
<p>If you are using the built-in JSON encoder or decoder, you will need to replace them with your own implementation (documentation and sample code are provided in the Decoders and Encoders sections).</p>
</li>
<li>
<p>If you are using the <code>protocol(String)</code> request matcher (with 'HTTP' or 'HTTPS') you can simply change it to the new <code>secure(boolean)</code> matcher, where 'HTTPS' is <code>true</code> and 'HTTP' is <code>false</code>.</p>
</li>
</ul>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_in_2_0">In 2.0</h3>
<div class="ulist">
<ul>
<li>
<p>Not directly backward compatible with 1.x codebase (see migration notes below).</p>
</li>
<li>
<p>Requires Java 11+.</p>
</li>
<li>
<p>Refactored code and packaging as well as code-conversion from Groovy to Java (no loss of support for using with Groovy).</p>
</li>
<li>
<p>Removed deprecated methods.</p>
</li>
<li>
<p>Refactored the HTTP method names to be uppercase.</p>
</li>
<li>
<p>Added optional timeout for standard request verify calls.</p>
</li>
<li>
<p>Converted the underlying response content from String to byte[] (also changed response encoder API)</p>
</li>
<li>
<p>Refactored the underlying server into a more abstract integration so that it may be swapped out in the future.</p>
</li>
<li>
<p>Pulled external Closure helper API code into codebase (to avoid breaking maven-central support)</p>
</li>
<li>
<p>Refactored the JUnit support (4 and 5)</p>
</li>
</ul>
</div>
<div class="sect3">
<h4 id="_migrating_to_2_0">Migrating to 2.0</h4>
<div class="ulist">
<ul>
<li>
<p>Change all HTTP method names to uppercase (e.g. if you have a head('/foo') call, change it to HEAD('/foo')).</p>
</li>
<li>
<p>Replace any deprecated method usages with appropriate replacements.</p>
</li>
<li>
<p>If you use the ErsatzProxy or JUnit helper classes, you will need to change the package information.</p>
</li>
<li>
<p>Most of the DSL classes were repackaged and will require updates to the package names imported.</p>
</li>
</ul>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_in_1_9">In 1.9</h3>
<div class="ulist">
<ul>
<li>
<p>Corrections to the closure variable scoping.</p>
</li>
<li>
<p>Support for configuring the server port - though, in general, this is not recommended.</p>
</li>
<li>
<p>Some added usage documentation</p>
</li>
</ul>
</div>
</div>
<div class="sect2">
<h3 id="_in_1_8">In 1.8</h3>
<div class="ulist">
<ul>
<li>
<p>Variable scope changes – the configuration Groovy DSL closures had incorrect (or inadequate) resolution strategies specified which caused variables to be resolved incorrectly in some situations. All of the closures now use DELEGATE_FIRST; however, beware this may cause some issues with existing code.</p>
</li>
<li>
<p>Deprecation of the Response::content(&#8230;&#8203;) methods in favor of the new body(&#8230;&#8203;) methods.</p>
</li>
<li>
<p>ANSI color codes were added to the match failure reports to make them a bit more readable.</p>
</li>
<li>
<p>A couple of helper methods were added to ErsatzServer to facilitate simple URL string building – see httpUrl(String) and httpsUrl(String).</p>
</li>
<li>
<p>A JUnit 5 Extension was added to make server management simple with JUnit 5, similar to what already existed for JUnit 4.</p>
</li>
<li>
<p>Support for "chunked" responses with fixed or random delays between chunks has been added.</p>
</li>
</ul>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_getting_started">Getting Started</h2>
<div class="sectionbody">
<div class="paragraph">
<p>The ersatz libraries are available via the Maven Central Repository; you can add them to your project using one of the following methods:</p>
</div>
<div class="sect2">
<h3 id="_gradle">Gradle</h3>
<div class="paragraph">
<p>For Gradle, add the following to your <code>build.gradle</code> file <code>dependencies</code> block:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="groovy"><span class="n">testImplementation</span> <span class="s1">'io.github.cjstehno.ersatz:ersatz:3.2.0'</span>

<span class="c1">// or, for the Groovy extensions</span>
<span class="n">testImplementation</span> <span class="s1">'io.github.cjstehno.ersatz:ersatz-groovy:3.2.0'</span></code></pre>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_maven">Maven</h3>
<div class="paragraph">
<p>For Maven, add the code below to your <code>pom.xml</code> file <code>&lt;dependencies&gt;</code> section:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="xml"><span class="nt">&lt;dependency&gt;</span>
    <span class="nt">&lt;groupId&gt;</span>io.github.cjstehno.ersatz<span class="nt">&lt;/groupId&gt;</span>
    <span class="nt">&lt;artifactId&gt;</span>ersatz<span class="nt">&lt;/artifactId&gt;</span>
    <span class="nt">&lt;version&gt;</span>3.2.0<span class="nt">&lt;/version&gt;</span>
    <span class="nt">&lt;scope&gt;</span>test<span class="nt">&lt;/scope&gt;</span>
<span class="nt">&lt;/dependency&gt;</span>

<span class="c">&lt;!-- or, for the Groovy extensions --&gt;</span>
<span class="nt">&lt;dependency&gt;</span>
    <span class="nt">&lt;groupId&gt;</span>io.github.cjstehno.ersatz<span class="nt">&lt;/groupId&gt;</span>
    <span class="nt">&lt;artifactId&gt;</span>ersatz-groovy<span class="nt">&lt;/artifactId&gt;</span>
    <span class="nt">&lt;version&gt;</span>3.2.0<span class="nt">&lt;/version&gt;</span>
    <span class="nt">&lt;scope&gt;</span>test<span class="nt">&lt;/scope&gt;</span>
<span class="nt">&lt;/dependency&gt;</span></code></pre>
</div>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<div class="title">Note</div>
</td>
<td class="content">
If you are using Groovy, you need only add the <code>ersatz-groovy</code> dependency, as it will pull in the core <code>ersatz</code> library as a dependency of itself.
</td>
</tr>
</table>
</div>
</div>
<div class="sect2">
<h3 id="_writing_a_test">Writing a Test</h3>
<div class="paragraph">
<p>Once you have configured the library dependency, you can use it in a JUnit 5 test as follows:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="java"><span class="kn">import</span> <span class="nn">io.github.cjstehno.ersatz.ErsatzServer</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">io.github.cjstehno.ersatz.junit.ErsatzServerExtension</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">org.junit.jupiter.api.Test</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">org.junit.jupiter.api.extension.ExtendWith</span><span class="o">;</span>

<span class="kn">import</span> <span class="nn">java.net.URI</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">java.net.http.HttpRequest</span><span class="o">;</span>

<span class="kn">import</span> <span class="nn">static</span> <span class="n">io</span><span class="o">.</span><span class="na">github</span><span class="o">.</span><span class="na">cjstehno</span><span class="o">.</span><span class="na">ersatz</span><span class="o">.</span><span class="na">cfg</span><span class="o">.</span><span class="na">ContentType</span><span class="o">.</span><span class="na">TEXT_PLAIN</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">static</span> <span class="n">java</span><span class="o">.</span><span class="na">net</span><span class="o">.</span><span class="na">http</span><span class="o">.</span><span class="na">HttpClient</span><span class="o">.</span><span class="na">newHttpClient</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">static</span> <span class="n">java</span><span class="o">.</span><span class="na">net</span><span class="o">.</span><span class="na">http</span><span class="o">.</span><span class="na">HttpResponse</span><span class="o">.</span><span class="na">BodyHandlers</span><span class="o">.</span><span class="na">ofString</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">static</span> <span class="n">org</span><span class="o">.</span><span class="na">junit</span><span class="o">.</span><span class="na">jupiter</span><span class="o">.</span><span class="na">api</span><span class="o">.</span><span class="na">Assertions</span><span class="o">.</span><span class="na">assertEquals</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">static</span> <span class="n">org</span><span class="o">.</span><span class="na">junit</span><span class="o">.</span><span class="na">jupiter</span><span class="o">.</span><span class="na">api</span><span class="o">.</span><span class="na">Assertions</span><span class="o">.</span><span class="na">assertTrue</span><span class="o">;</span>

<span class="nd">@ExtendWith</span><span class="o">(</span><span class="nc">ErsatzServerExtension</span><span class="o">.</span><span class="na">class</span><span class="o">)</span>
<span class="kd">class</span> <span class="nc">HelloTest</span> <span class="o">{</span>

    <span class="nd">@Test</span> <span class="kt">void</span> <span class="nf">sayHello</span><span class="o">(</span><span class="kd">final</span> <span class="nc">ErsatzServer</span> <span class="n">server</span><span class="o">)</span> <span class="kd">throws</span> <span class="nc">Exception</span> <span class="o">{</span>
        <span class="n">server</span><span class="o">.</span><span class="na">expectations</span><span class="o">(</span><span class="n">expect</span> <span class="o">-&gt;</span> <span class="o">{</span>
            <span class="n">expect</span><span class="o">.</span><span class="na">GET</span><span class="o">(</span><span class="s">"/say/hello"</span><span class="o">,</span> <span class="n">req</span> <span class="o">-&gt;</span> <span class="o">{</span>
                <span class="n">req</span><span class="o">.</span><span class="na">called</span><span class="o">(</span><span class="mi">1</span><span class="o">);</span>
                <span class="n">req</span><span class="o">.</span><span class="na">query</span><span class="o">(</span><span class="s">"name"</span><span class="o">,</span> <span class="s">"Ersatz"</span><span class="o">);</span>
                <span class="n">req</span><span class="o">.</span><span class="na">responder</span><span class="o">(</span><span class="n">res</span> <span class="o">-&gt;</span> <span class="o">{</span>
                    <span class="n">res</span><span class="o">.</span><span class="na">body</span><span class="o">(</span><span class="s">"Hello, Ersatz"</span><span class="o">,</span> <span class="no">TEXT_PLAIN</span><span class="o">);</span>
                <span class="o">});</span>
            <span class="o">});</span>
        <span class="o">});</span>

        <span class="kd">final</span> <span class="kt">var</span> <span class="n">request</span> <span class="o">=</span> <span class="nc">HttpRequest</span>
            <span class="o">.</span><span class="na">newBuilder</span><span class="o">(</span><span class="k">new</span> <span class="no">URI</span><span class="o">(</span><span class="n">server</span><span class="o">.</span><span class="na">httpUrl</span><span class="o">(</span><span class="s">"/say/hello?name=Ersatz"</span><span class="o">)))</span>
            <span class="o">.</span><span class="na">GET</span><span class="o">()</span>
            <span class="o">.</span><span class="na">build</span><span class="o">();</span>

        <span class="kd">final</span> <span class="kt">var</span> <span class="n">response</span> <span class="o">=</span> <span class="n">newHttpClient</span><span class="o">().</span><span class="na">send</span><span class="o">(</span><span class="n">request</span><span class="o">,</span> <span class="n">ofString</span><span class="o">());</span>

        <span class="n">assertEquals</span><span class="o">(</span><span class="mi">200</span><span class="o">,</span> <span class="n">response</span><span class="o">.</span><span class="na">statusCode</span><span class="o">());</span>
        <span class="n">assertEquals</span><span class="o">(</span><span class="s">"Hello, Ersatz"</span><span class="o">,</span> <span class="n">response</span><span class="o">.</span><span class="na">body</span><span class="o">());</span>
        <span class="n">assertTrue</span><span class="o">(</span><span class="n">server</span><span class="o">.</span><span class="na">verify</span><span class="o">());</span>
    <span class="o">}</span>
<span class="o">}</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>The server is configured to expect a single <code>GET /say/hello</code> request with <code>name=Ersatz</code> on the query string. When it receives that request, the server will respond with status code 200 (by default), and a response with <code>content-type "text/plain"</code> and <code>"Hello, Ersatz"</code> as the body content. If the server does not receive the expected request, the <code>verify()</code> call will fail, likewise, the expected response content would not be returned.</p>
</div>
<div class="paragraph">
<p>The test above could be written similarly in Groovy, using the Groovy extensions (i.e. <code>ersatz-groovy</code> library):</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="groovy"><span class="kn">import</span> <span class="nn">io.github.cjstehno.ersatz.GroovyErsatzServer</span>
<span class="kn">import</span> <span class="nn">io.github.cjstehno.ersatz.junit.ErsatzServerExtension</span>
<span class="kn">import</span> <span class="nn">org.junit.jupiter.api.Test</span>
<span class="kn">import</span> <span class="nn">org.junit.jupiter.api.extension.ExtendWith</span>

<span class="kn">import</span> <span class="nn">java.net.http.HttpRequest</span>

<span class="kn">import</span> <span class="nn">static</span> <span class="n">io</span><span class="o">.</span><span class="na">github</span><span class="o">.</span><span class="na">cjstehno</span><span class="o">.</span><span class="na">ersatz</span><span class="o">.</span><span class="na">cfg</span><span class="o">.</span><span class="na">ContentType</span><span class="o">.</span><span class="na">TEXT_PLAIN</span>
<span class="kn">import</span> <span class="nn">static</span> <span class="n">java</span><span class="o">.</span><span class="na">net</span><span class="o">.</span><span class="na">http</span><span class="o">.</span><span class="na">HttpClient</span><span class="o">.</span><span class="na">newHttpClient</span>
<span class="kn">import</span> <span class="nn">static</span> <span class="n">java</span><span class="o">.</span><span class="na">net</span><span class="o">.</span><span class="na">http</span><span class="o">.</span><span class="na">HttpResponse</span><span class="o">.</span><span class="na">BodyHandlers</span><span class="o">.</span><span class="na">ofString</span>
<span class="kn">import</span> <span class="nn">static</span> <span class="n">org</span><span class="o">.</span><span class="na">junit</span><span class="o">.</span><span class="na">jupiter</span><span class="o">.</span><span class="na">api</span><span class="o">.</span><span class="na">Assertions</span><span class="o">.</span><span class="na">assertEquals</span>
<span class="kn">import</span> <span class="nn">static</span> <span class="n">org</span><span class="o">.</span><span class="na">junit</span><span class="o">.</span><span class="na">jupiter</span><span class="o">.</span><span class="na">api</span><span class="o">.</span><span class="na">Assertions</span><span class="o">.</span><span class="na">assertTrue</span>

<span class="nd">@ExtendWith</span><span class="o">(</span><span class="n">ErsatzServerExtension</span><span class="o">)</span>
<span class="kd">class</span> <span class="nc">HelloGroovyTest</span> <span class="o">{</span>

    <span class="nd">@Test</span> <span class="kt">void</span> <span class="s1">'say hello'</span><span class="o">(</span><span class="kd">final</span> <span class="n">GroovyErsatzServer</span> <span class="n">server</span><span class="o">)</span> <span class="o">{</span>
        <span class="n">server</span><span class="o">.</span><span class="na">expectations</span> <span class="o">{</span>
            <span class="n">GET</span><span class="o">(</span><span class="s1">'/say/hello'</span><span class="o">)</span> <span class="o">{</span>
                <span class="n">called</span> <span class="mi">1</span>
                <span class="n">query</span> <span class="s1">'name'</span><span class="o">,</span> <span class="s1">'Ersatz'</span>
                <span class="n">responder</span> <span class="o">{</span>
                    <span class="n">body</span> <span class="s1">'Hello, Ersatz'</span><span class="o">,</span> <span class="n">TEXT_PLAIN</span>
                <span class="o">}</span>
            <span class="o">}</span>
        <span class="o">}</span>

        <span class="kd">final</span> <span class="n">var</span> <span class="n">request</span> <span class="o">=</span> <span class="n">HttpRequest</span>
                <span class="o">.</span><span class="na">newBuilder</span><span class="o">(</span><span class="k">new</span> <span class="n">URI</span><span class="o">(</span><span class="n">server</span><span class="o">.</span><span class="na">httpUrl</span><span class="o">(</span><span class="s1">'/say/hello?name=Ersatz'</span><span class="o">)))</span>
                <span class="o">.</span><span class="na">GET</span><span class="o">()</span>
                <span class="o">.</span><span class="na">build</span><span class="o">()</span>

        <span class="kd">final</span> <span class="n">var</span> <span class="n">response</span> <span class="o">=</span> <span class="n">newHttpClient</span><span class="o">().</span><span class="na">send</span><span class="o">(</span><span class="n">request</span><span class="o">,</span> <span class="n">ofString</span><span class="o">())</span>

        <span class="n">assertEquals</span> <span class="mi">200</span><span class="o">,</span> <span class="n">response</span><span class="o">.</span><span class="na">statusCode</span><span class="o">()</span>
        <span class="n">assertEquals</span> <span class="s1">'Hello, Ersatz'</span><span class="o">,</span> <span class="n">response</span><span class="o">.</span><span class="na">body</span><span class="o">()</span>
        <span class="n">assertTrue</span> <span class="n">server</span><span class="o">.</span><span class="na">verify</span><span class="o">()</span>
    <span class="o">}</span>
<span class="o">}</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Note that the configuration is almost identical between the two, though with Groovy it&#8217;s just a bit cleaner. Also note that for the Groovy version, the <code>GroovyErsatzServer</code> is used instead of the <code>ErsatzServer</code>&#8201;&#8212;&#8201;this provides additional Groovy DSL support.</p>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_junit_extension">JUnit Extension</h2>
<div class="sectionbody">
<div class="paragraph">
<p>The framework provides two JUnit 5 Extensions:</p>
</div>
<div class="ulist">
<ul>
<li>
<p><code>ErsatzServerExtension</code>. A configurable server management extension that creates and destroys the server after each test method.</p>
</li>
<li>
<p><code>SharedErsatzServerExtension</code>. A server management extension that creates the server at the start of the test class, and destroys it when all tests are done.</p>
</li>
</ul>
</div>
<div class="sect2">
<h3 id="_ersatzserverextension">ErsatzServerExtension</h3>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<div class="title">Note</div>
</td>
<td class="content">
This is the extension that has been around for a while - the new extension was created with a different name so as not to break existing tests.
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>The main functionality of the extension is to provide two test lifecycle hooks:</p>
</div>
<div class="ulist">
<ul>
<li>
<p><code>beforeEach</code>: Before each test method is executed, the server will be created, configured, and started.</p>
</li>
<li>
<p><code>afterEach</code>: After each test method is done executing, the server will be stopped, and the expectations cleared.</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>Configuration of the test server can take one of the following forms (in order of precedence):</p>
</div>
<div class="ulist">
<ul>
<li>
<p><strong>Annotated Method.</strong> If the test method is annotated with the <code>@ApplyServerConfig(method)</code> annotation, the specified method will be called to populate a <code>ServerConfig</code> instance, which will be used to configure an instance of <code>ErsatzServer</code>, which will be exposed as a test method parameter.</p>
</li>
<li>
<p><strong>Annotated Class.</strong> If the test class is annotated with the <code>@ApplyServerConfig(method)</code> annotation, the specified method will be called to populate a <code>ServerConfig</code> instance, which will be used to configure an instance of <code>ErsatzServer</code>, which will be exposed as a test method parameter.</p>
</li>
<li>
<p><strong>Typed field without value.</strong> If a field of type <code>ErsatzServer</code> is added to the test, with no explicit value, the server will be created and used to populate that field. The created server will also be exposed as a test method parameter.</p>
</li>
<li>
<p><strong>Typed field with value.</strong> If a field of type <code>ErsatzServer</code> is added to the test with a value, that value will be used as the server, and also exposed as a test method parameter.</p>
</li>
<li>
<p><strong>No configuration.</strong> If no explicit configuration is added to the test, it will create an instance of <code>ErsatzServer</code> and expose it as an available test method parameter.</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>The <code>@ApplyServerConfig</code> annotation may be added to the test class, for global default configuration, or to a test method, to define the configuration to be used by a single test method. The value of the annotation should be the name of a method of the test class which accepts a single argument of type <code>ServerConfig</code>. The method should use the provided <code>ServerConfig</code> instance and configure it.</p>
</div>
<div class="paragraph">
<p>Lastly, if a test method adds a parameter of type <code>ErsatzServer</code>, it will be populated with the currently configured server instance for the test - this removes the need to store the server instance in a field of the test class.</p>
</div>
<div class="paragraph">
<p>An example with some of the available configuration could look like the following:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="java"><span class="nd">@ExtendWith</span><span class="o">(</span><span class="nc">ErsatzServerExtension</span><span class="o">.</span><span class="na">class</span><span class="o">)</span>
<span class="nd">@ApplyServerConfig</span><span class="o">(</span><span class="s">"defaultConfig"</span><span class="o">)</span>
<span class="kd">class</span> <span class="nc">SomeTesting</span> <span class="o">{</span>

    <span class="nd">@Test</span> <span class="kt">void</span> <span class="nf">defaultTest</span><span class="o">(</span><span class="kd">final</span> <span class="nc">ErsatzServer</span> <span class="n">server</span><span class="o">){</span>
        <span class="c1">// do some testing with the server - defaultConfig</span>
    <span class="o">}</span>

    <span class="nd">@Test</span> <span class="nd">@ApplyServerConfig</span><span class="o">(</span><span class="s">"anotherConfig"</span><span class="o">)</span>
    <span class="kt">void</span> <span class="nf">anotherTest</span><span class="o">(</span><span class="kd">final</span> <span class="nc">ErsatzServer</span> <span class="n">server</span><span class="o">){</span>
        <span class="c1">// do some more testing with the server - anotherConfig</span>
    <span class="o">}</span>

    <span class="kd">private</span> <span class="kt">void</span> <span class="nf">defaultConfig</span><span class="o">(</span><span class="kd">final</span> <span class="nc">ServerConfig</span> <span class="n">conf</span><span class="o">){</span>
        <span class="c1">// apply some config</span>
    <span class="o">}</span>

    <span class="kd">private</span> <span class="kt">void</span> <span class="nf">anotherConfig</span><span class="o">(</span><span class="kd">final</span> <span class="nc">ServerConfig</span> <span class="n">conf</span><span class="o">){</span>
        <span class="c1">// apply some other config</span>
    <span class="o">}</span>
<span class="o">}</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>The legacy style of test configuration will continue to work, but now you have some additional options to help clean things up a bit.</p>
</div>
</div>
<div class="sect2">
<h3 id="_sharedersatzserverextension">SharedErsatzServerExtension</h3>
<div class="paragraph">
<p>This JUnit extension provides some of the features of the other extension, though its main purpose is to provide a means
of simple and fast server management.</p>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<div class="title">Note</div>
</td>
<td class="content">
While theoretically, creating and starting the server once per test class <em>should</em> be faster than doing it for each test method, your results may vary&#8230;&#8203; and it will be highly dependant on how many tests you have in the class. As a general rule, I would suggest starting with this extension and then switching to the other one if/when you need more flexible configuration.
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>This extension differ from the other in that it creates the server instance in <code>beforeAll</code> and destroys it in <code>afterAll</code>, so that there is one server running and available for all of the tests in the class. This cuts down on the startup and shutdown time, at the cost of being able to configure the server for each test method.</p>
</div>
<div class="paragraph">
<p>The server expectations are cleared after each test method completes (e.g. <code>afterEach</code>).</p>
</div>
<div class="paragraph">
<p>Configuration of the server instance may be done using a class-level <code>@ApplyServerConfig</code> annotation (not method level), or, if none is provided, the default configuration will be used to create the server. Also, note that for this extension, the configuration method must be <code>static</code>.</p>
</div>
<div class="paragraph">
<p>Test methods should add an <code>ErsatzServer</code> or <code>GroovyErsatzServer</code> typed parameter to the test methods that require access to the server instance.</p>
</div>
<div class="paragraph">
<p>A simple example (similar to the one above), would be:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="java"><span class="nd">@ExtendWith</span><span class="o">(</span><span class="nc">SharedErsatzServerExtension</span><span class="o">.</span><span class="na">class</span><span class="o">)</span>
<span class="nd">@ApplyServerConfig</span>
<span class="kd">class</span> <span class="nc">SomeTesting</span> <span class="o">{</span>

    <span class="nd">@Test</span> <span class="kt">void</span> <span class="nf">defaultTest</span><span class="o">(</span><span class="kd">final</span> <span class="nc">ErsatzServer</span> <span class="n">server</span><span class="o">){</span>
        <span class="c1">// do some testing with the server - defaultConfig</span>
    <span class="o">}</span>

    <span class="kd">private</span> <span class="kd">static</span> <span class="kt">void</span> <span class="nf">serverConfig</span><span class="o">(</span><span class="kd">final</span> <span class="nc">ServerConfig</span> <span class="n">conf</span><span class="o">){</span>
        <span class="c1">// apply some config</span>
    <span class="o">}</span>
<span class="o">}</span></code></pre>
</div>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_server_lifecycle">Server Lifecycle</h2>
<div class="sectionbody">
<div class="paragraph">
<p>The core component of the Ersatz Server framework is the <code>ErsatzServer</code> class. It is used to manage the server lifecycle as well as providing the configuration interface.</p>
</div>
<div class="paragraph">
<p>The lifecycle of the server can be broken down into four states: Configuration, Matching, Verification, and Cleanup. Each is detailed in the following sections.</p>
</div>
<div class="sect2">
<h3 id="_configuration">Configuration</h3>
<div class="paragraph">
<p>The first lifecycle state is "configuration", where the server is instantiated, request expectations are configured and the server is started.</p>
</div>
<div class="paragraph">
<p>An Ersatz server is created as an instance of either <code>ErsatzServer</code> or <code>GroovyErsatzServer</code> with optional configuration performed by providing a <code>Consumer&lt;ServerConfig&gt;</code> or a <code>Closure</code> respectively. Both will have an instance of <code>ServerConfig</code> passed into them for the configuration to be applied.</p>
</div>
<div class="paragraph">
<p>Global decoders and encoders may also be configured with the server, as such they will be used as defaults across all configured expectations.</p>
</div>
<div class="paragraph">
<p>At this point, there is no HTTP server running, and it is ready for further configuration, as well specifying the request expectations (using the <code>expectations(&#8230;&#8203;)</code> and <code>expects()</code> methods).</p>
</div>
<div class="paragraph">
<p>Once the request expectations are configured, if auto-start is enabled (the default), the server will automatically start. If auto-start is disabled (using <code>autoStart(false)</code>), the server will need to be started using the <code>start()</code> method. If the server is not started, you will receive connection errors during testing.</p>
</div>
<div class="paragraph">
<p>The server is now ready for "matching".</p>
</div>
</div>
<div class="sect2">
<h3 id="_matching">Matching</h3>
<div class="paragraph">
<p>The second state of the server, is "matching", where request/response interactions are made against the server.</p>
</div>
<div class="paragraph">
<p>Any HTTP client can be used to make requests against an Ersatz server. The <code>ErsatzServer</code> instance has some helpful methods for use by the client, in order to get the URLs, ports as exposed by the server.</p>
</div>
</div>
<div class="sect2">
<h3 id="_verification">Verification</h3>
<div class="paragraph">
<p>Once the testing has been performed, it may be desirable to verify whether the expected requests were matched the expected number of times (using the <code>Request::called(&#8230;&#8203;)</code> methods) rather than just that they were called at all.</p>
</div>
<div class="paragraph">
<p>To execute verification, one the <code>ErsatzServer::verify(&#8230;&#8203;)</code> must be called, which will return a boolean value of true if the verification passed.</p>
</div>
<div class="paragraph">
<p>Verification is optional and may simply be skipped if you have no need for counting the executed requests.</p>
</div>
</div>
<div class="sect2">
<h3 id="_cleanup">Cleanup</h3>
<div class="paragraph">
<p>After matching and verification, when all test interactions have completed, the server must be stopped in order to free up resources and close connections. This is done by calling the <code>ErsatzServer::stop()</code> method or its alias <code>close()</code>. This is an important step, as odd test failures have been noticed during multi-test runs if the server is not properly stopped.</p>
</div>
<div class="paragraph">
<p>If you use JUnit 5, you can use the <code>ErsatzServerExtension</code> to perform server instantiation and cleanup for you.</p>
</div>
<div class="paragraph">
<p>For Spock, you can use the <code>@AutoCleanup</code> annotation on the <code>ErsatzServer</code> (or <code>GroovyErsatzServer</code>) to perform the cleanup automatically.</p>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<div class="title">Note</div>
</td>
<td class="content">
A stopped server may be restarted, though if you want to clean out expectations, you may want to call the <code>ErsatzServer::clearExpectations()</code> method before starting it again.
</td>
</tr>
</table>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_server_configuration">Server Configuration</h2>
<div class="sectionbody">
<div class="paragraph">
<p>The <code>ServerConfig</code> interface provides the configuration methods for the server and requests, at the global level.</p>
</div>
<div class="sect2">
<h3 id="_ports">Ports</h3>
<div class="paragraph">
<p>It is recommended to let the server find the best available port for your run&#8201;&#8212;&#8201;it starts on an ephemeral port by default. There are some cases when you need to explicitly specify the HTTP or HTTPS server port and you can do so in the following manner:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="java"><span class="kd">final</span> <span class="kt">var</span> <span class="n">server</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">ErsatzServer</span><span class="o">(</span><span class="n">cfg</span> <span class="o">-&gt;</span> <span class="o">{</span>
    <span class="n">cfg</span><span class="o">.</span><span class="na">httpPort</span><span class="o">(</span><span class="mi">1111</span><span class="o">);</span>
    <span class="n">cfg</span><span class="o">.</span><span class="na">httpsPort</span><span class="o">(</span><span class="mi">2222</span><span class="o">);</span>
<span class="o">));</span></code></pre>
</div>
</div>
<div class="admonitionblock warning">
<table>
<tr>
<td class="icon">
<div class="title">Warning</div>
</td>
<td class="content">
The danger of doing this is that with a fixed port you run the risk of having port collisions with other services or even other running instances of your tests. This should only be used in extremely rare cases.
</td>
</tr>
</table>
</div>
</div>
<div class="sect2">
<h3 id="_auto_start">Auto-Start</h3>
<div class="paragraph">
<p>The auto-start flag is enabled by default to allow the server to start automatically once the expectations have been applied (e.g. after the <code>expectations(&#8230;&#8203;)</code> method has been called. This removes the need to explicitly call the <code>start()</code> method in your tests.</p>
</div>
<div class="paragraph">
<p>If you want to disable the auto-start feature, you can do the following:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="java"><span class="kd">final</span> <span class="kt">var</span> <span class="n">server</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">ErsatzServer</span><span class="o">(</span><span class="n">cfg</span> <span class="o">-&gt;</span> <span class="o">{</span>
    <span class="n">cfg</span><span class="o">.</span><span class="na">autoStart</span><span class="o">(</span><span class="kc">false</span><span class="o">);</span>
<span class="o">));</span></code></pre>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_https">HTTPS</h3>
<div class="paragraph">
<p>The server supports HTTPS requests when the <code>https(&#8230;&#8203;)</code> feature flag is enabled. When enabled, the server will set up both an HTTP and HTTPS listener which will have access to all configured expectations.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="java"><span class="kd">final</span> <span class="kt">var</span> <span class="n">server</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">ErsatzServer</span><span class="o">(</span><span class="n">cfg</span> <span class="o">-&gt;</span> <span class="o">{</span>
    <span class="n">cfg</span><span class="o">.</span><span class="na">https</span><span class="o">();</span>
<span class="o">));</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>In order to limit a specific request expectation to HTTP or HTTPS, apply the <code>secure(boolean)</code> request matcher with a value of <code>true</code> for HTTPS and <code>false</code> for HTTP, similar to the following:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="java"><span class="n">server</span><span class="o">.</span><span class="na">expectations</span><span class="o">(</span><span class="n">expect</span> <span class="o">-&gt;</span> <span class="o">{</span>
    <span class="n">expect</span><span class="o">.</span><span class="na">GET</span><span class="o">(</span><span class="s">"/something"</span><span class="o">).</span><span class="na">secure</span><span class="o">(</span><span class="kc">true</span><span class="o">).</span><span class="na">responding</span><span class="o">(</span><span class="s">"stuff"</span><span class="o">);</span>
<span class="o">});</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>The code above will match an HTTPS request to <code>GET /something</code> and send a response with "stuff" as its body; however, it will not match an HTTP request to the same method and path.</p>
</div>
<div class="admonitionblock warning">
<table>
<tr>
<td class="icon">
<div class="title">Warning</div>
</td>
<td class="content">
The HTTPS support is rudimentary and meant to test HTTPS endpoints, not any explicit features of HTTPS itself. Also, your client will need to be able to ignore any self-signed certificate issues in one way or another.
</td>
</tr>
</table>
</div>
<div class="sect3">
<h4 id="_keystore">Keystore</h4>
<div class="paragraph">
<p>A default keystore is provided with the Ersatz library, and it should suffice for most test cases; however, you may need/wish to provide your own custom keystore for whatever reason. A supported keystore file may be created using the following command:</p>
</div>
<div class="listingblock">
<div class="content">
<pre>./keytool -genkey -alias &lt;NAME&gt; -keyalg RSA -keystore &lt;FILE_LOCATION&gt;</pre>
</div>
</div>
<div class="paragraph">
<p>where <code>&lt;NAME&gt;</code> is the key name and <code>&lt;FILE_LOCATION&gt;</code> is the location where the keystore file is to be created. You will be asked a few questions about the key being created. The default keystore name is <code>ersatz</code> and it has the following properties.</p>
</div>
<div class="listingblock">
<div class="content">
<pre>CN=Ersatz, OU=Ersatz, O=Ersatz, L=Nowhere, ST=Nowhere, C=US</pre>
</div>
</div>
<div class="paragraph">
<p>Obviously, it is only for testing purposes.</p>
</div>
<div class="paragraph">
<p>The keystore then needs to be provided during the server configuration, as follows:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="java"><span class="kd">final</span> <span class="kt">var</span> <span class="n">server</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">ErsatzServer</span><span class="o">(</span><span class="n">cfg</span> <span class="o">-&gt;</span> <span class="o">{</span>
    <span class="n">cfg</span><span class="o">.</span><span class="na">https</span><span class="o">();</span>
    <span class="n">cfg</span><span class="o">.</span><span class="na">keystore</span><span class="o">(</span><span class="no">KEYSTORE_URL</span><span class="o">,</span> <span class="no">KEYSTORE_PASS</span><span class="o">);</span>
<span class="o">));</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>where <code>KEYSTORE_URL</code> is the URL to your custom keystore file, and <code>KEYSTORE_PASS</code> is the password (maybe omitted if you used "ersatz" as the password).</p>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_request_timeout">Request Timeout</h3>
<div class="paragraph">
<p>The server request timeout configuration may be specified using the <code>timeout(&#8230;&#8203;)</code> configuration methods.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="java"><span class="kd">final</span> <span class="kt">var</span> <span class="n">server</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">ErsatzServer</span><span class="o">(</span><span class="n">cfg</span> <span class="o">-&gt;</span> <span class="o">{</span>
    <span class="n">cfg</span><span class="o">.</span><span class="na">timeout</span><span class="o">(</span><span class="mi">15</span><span class="o">,</span> <span class="nc">TimeUnit</span><span class="o">.</span><span class="na">SECONDS</span><span class="o">);</span>
<span class="o">));</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>This will allow some wiggle room in tests with high volumes of data or having complex matching logic to be resolved.</p>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<div class="title">Note</div>
</td>
<td class="content">
This timeout is a bit of a shotgun approach, as it sets a handful of timeout options on the server to the specified value. See the API docs for more details, if required.
</td>
</tr>
</table>
</div>
</div>
<div class="sect2">
<h3 id="_report_to_console">Report-to-Console</h3>
<div class="paragraph">
<p>If the report-to-console flag is enabled (disabled by default), additional details will be written to the console when request matching fails (in addition to writing it in the logs, as it always does).</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="java"><span class="kd">final</span> <span class="kt">var</span> <span class="n">server</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">ErsatzServer</span><span class="o">(</span><span class="n">cfg</span> <span class="o">-&gt;</span> <span class="o">{</span>
    <span class="n">cfg</span><span class="o">.</span><span class="na">reportToConsole</span><span class="o">();</span>
<span class="o">));</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>The rendered report would be written to the console similar to following:</p>
</div>
<div class="listingblock">
<div class="content">
<pre># Expectations

Expectation 0 (3 matchers):
+ HTTP method matches &lt;GET&gt;
+ Path matches "/say/hello"
X Query string name matches a collection containing "Ersatz"
(3 matchers: 2 matched, 1 failed)</pre>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_logging_response_content">Logging Response Content</h3>
<div class="paragraph">
<p>By default, the content of a response is only logged as its length (in bytes). If the log-response-content feature flag is enabled, the entire content of the response will be written to the logs. This is helpful when debugging issues with tests.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="java"><span class="kd">final</span> <span class="kt">var</span> <span class="n">server</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">ErsatzServer</span><span class="o">(</span><span class="n">cfg</span> <span class="o">-&gt;</span> <span class="o">{</span>
    <span class="n">cfg</span><span class="o">.</span><span class="na">logResponseContent</span><span class="o">();</span>
<span class="o">));</span></code></pre>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_server_threads">Server Threads</h3>
<div class="paragraph">
<p>By default (as of 3.1), the underlying server has 2 IO threads and 16 Worker threads configured (based on the recommended configuration for the underlying Undertow server). If you need to configure these values, you can use one of the <code>serverThreads</code> methods:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="java"><span class="kd">final</span> <span class="kt">var</span> <span class="n">server</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">ErsatzServer</span><span class="o">(</span><span class="n">cfg</span> <span class="o">-&gt;</span> <span class="o">{</span>
    <span class="n">cfg</span><span class="o">.</span><span class="na">serverThreads</span><span class="o">(</span><span class="mi">3</span><span class="o">);</span>
<span class="o">});</span></code></pre>
</div>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<div class="title">Note</div>
</td>
<td class="content">
With the standard use case being a server setup to handle only a minimal number of requests, and most likely not asynchronous, the underlying Undertow server does not need to use as many threads as a production instance would require.
</td>
</tr>
</table>
</div>
</div>
<div class="sect2">
<h3 id="_content_transformation">Content Transformation</h3>
<div class="paragraph">
<p>The transformation of request/response body content is performed using:</p>
</div>
<div class="ulist">
<ul>
<li>
<p><strong>Request Decoders</strong> to convert incoming request body content into a desired type for comparison.</p>
</li>
<li>
<p><strong>Response Encoders</strong> to convert outgoing response objects into HTTP response byte[] data.</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>These decoders and encoders are configured in a layered manner so that they may be configured and shared across multiple request/response interactions while still allowing them to be overridden as needed.</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Decoders/Encoders configured on the <code>ServerConfig</code> instance are considered "global" and will be used if no overriding transformers are configured elsewhere.</p>
</li>
<li>
<p>Decoders/Encoders configured in the request/response expectations are considered "local" and will override any other matching transformers for the same content.</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>Refer to the <a href="#_request_decoders">Request Decoders</a> and <a href="#_response_encoders">Response Encoders</a> sections for more details on the configuration and usage of decoders and encoders.</p>
</div>
</div>
<div class="sect2">
<h3 id="_expectations">Expectations</h3>
<div class="paragraph">
<p>Request expectations are the core of the Ersatz server functionality; conceptually, they are HTTP server request routes which are used to match an incoming HTTP request with a request handler or to respond with a status of 404, if no matching request was configured.</p>
</div>
<div class="paragraph">
<p>The expectations are configured on an instance of the <code>Expectations</code> interface, which provides multiple configuration methods for each of the supported HTTP request methods (<code>GET</code>, <code>HEAD</code>, <code>POST</code>, <code>PUT</code>, <code>DELETE</code>, <code>PATCH</code>, <code>OPTIONS</code>, and <code>TRACE</code>), with the method name corresponding to the HTTP request method name.</p>
</div>
<div class="paragraph">
<p>Refer to the <a href="#_request_expectations">Request Expectations</a> section for a more detailed discussion of the configuration and usage of the expectations framework.</p>
</div>
</div>
<div class="sect2">
<h3 id="_requirements">Requirements</h3>
<div class="paragraph">
<p>Request requirements allow for expectation-like request verification at the global level so that common expectation matching code does not need to be duplicated in multiple expectations. Similar to expectations, the requirements determine whether there is a matching requirement configured (by request method and path), if so, the configured requirement must be matched or the request will be rejected.</p>
</div>
<div class="paragraph">
<p>Requirements serve only to allow quick-rejection of bad requests, and provide no responders.</p>
</div>
<div class="paragraph">
<p>Refer to the <a href="#_request_requirements">Request Requirements</a> section for a more detailed discussion of the configuration and useage of the requirements framework.</p>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_request_decoders">Request Decoders</h2>
<div class="sectionbody">
<div class="paragraph">
<p>The decoders are used to convert request content bytes into a specified object type for matching in the expectations. They are implemented as a <code>BiFunction&lt;byte[], DecodingContext, Object&gt;</code>, where <code>byte[]</code> is the request content and the <code>Object</code> is the result of transforming the content. The <code>DecodingContext</code> is used to provide additional information about the request being decoded (e.g. content-length, content-type, character-encoding), along with a reference to the decoder chain.</p>
</div>
<div class="paragraph">
<p>Decoders are defined at the various levels with the same method signature:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="java"><span class="nc">ServerConfig</span> <span class="nf">decoder</span><span class="o">(</span><span class="nc">String</span> <span class="n">contentType</span><span class="o">,</span> <span class="nc">BiFunction</span><span class="o">&lt;</span><span class="kt">byte</span><span class="o">[],</span> <span class="nc">DecodingContext</span><span class="o">,</span> <span class="nc">Object</span><span class="o">&gt;</span> <span class="n">decoder</span><span class="o">)</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>See the API docs for more details.</p>
</div>
<div class="admonitionblock tip">
<table>
<tr>
<td class="icon">
<div class="title">Tip</div>
</td>
<td class="content">
As a design decision, no decoders are defined and registered on the server by default. If you need one, you need to register it.
</td>
</tr>
</table>
</div>
<div class="sect2">
<h3 id="_provided_decoders">Provided Decoders</h3>
<div class="paragraph">
<p>The API provides a handful of commonly used decoders. These are defined in the <code>io.github.cjstehno.ersatz.encdec.Decoders</code> class, and described below:</p>
</div>
<div class="ulist">
<ul>
<li>
<p><strong>Pass-through.</strong> A decoder that simply passes the content byte array through as an array of bytes.</p>
</li>
<li>
<p><strong>Strings.</strong> A few decoders that convert the request content bytes into a <code>String</code> object, with optional <code>Charset</code> specification.</p>
</li>
<li>
<p><strong>URL-Encoded.</strong> Decoder that converts request content bytes in a url-encoded format into a map of name/value pairs.</p>
</li>
<li>
<p><strong>Multipart.</strong> Decoder that converts request content bytes into a <code>MultipartRequestContent</code> object populated with the multipart request content.</p>
</li>
</ul>
</div>
</div>
<div class="sect2">
<h3 id="_json_decoders">JSON Decoders</h3>
<div class="paragraph">
<p>As of v3.0.0 the built-in JSON decoder was removed to avoid dependency lock-in. Below are some simple/common implementations that could be used.</p>
</div>
<div class="sect3">
<h4 id="_groovy">Groovy</h4>
<div class="paragraph">
<p>A decoder (deserializer) implemented with the Groovy <code>JsonSlurper</code> would look like the following (in Groovy):</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="groovy"><span class="n">decoder</span><span class="o">(</span><span class="n">ContentType</span><span class="o">.</span><span class="na">APPLICATION_JSON</span><span class="o">){</span> <span class="n">content</span><span class="o">,</span> <span class="n">context</span> <span class="o">-&gt;</span>
    <span class="k">new</span> <span class="nf">JsonSlurper</span><span class="o">().</span><span class="na">parse</span><span class="o">(</span><span class="n">content</span> <span class="o">?:</span> <span class="s1">'{}'</span><span class="o">.</span><span class="na">bytes</span><span class="o">)</span>
<span class="o">}</span></code></pre>
</div>
</div>
<div class="admonitionblock tip">
<table>
<tr>
<td class="icon">
<div class="title">Tip</div>
</td>
<td class="content">
If you are using the Groovy extension library, this decoder is available as the <code>JsonDecoder</code> class.
</td>
</tr>
</table>
</div>
</div>
<div class="sect3">
<h4 id="_jackson">Jackson</h4>
<div class="paragraph">
<p>A decoder (deserializer) implemented with the Jackson <code>ObjectMapper</code> would be implemented as (in Java):</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="java"><span class="n">decoder</span><span class="o">(</span><span class="nc">ContentType</span><span class="o">.</span><span class="na">APPLICATION_JSON</span><span class="o">,</span> <span class="o">(</span><span class="n">content</span><span class="o">,</span> <span class="n">context</span><span class="o">)</span> <span class="o">-&gt;</span> <span class="o">{</span>
    <span class="k">return</span> <span class="k">new</span> <span class="nf">ObjectMapper</span><span class="o">().</span><span class="na">readValue</span><span class="o">(</span><span class="n">content</span><span class="o">,</span> <span class="nc">Map</span><span class="o">.</span><span class="na">class</span><span class="o">);</span>
<span class="o">});</span></code></pre>
</div>
</div>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_response_encoders">Response Encoders</h2>
<div class="sectionbody">
<div class="paragraph">
<p>The Encoders are used to convert response configuration data types into the outbound request content string. They are implemented as a`Function&lt;Object,byte[]&gt;` with the input <code>Object</code> being the configuration object being converted, and the <code>byte[]</code> is the return type.</p>
</div>
<div class="paragraph">
<p>The various configuration levels have the same method signature:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="groovy"><span class="n">ServerConfig</span> <span class="nf">encoder</span><span class="o">(</span><span class="n">String</span> <span class="n">contentType</span><span class="o">,</span> <span class="n">Class</span> <span class="n">objectType</span><span class="o">,</span> <span class="n">Function</span><span class="o">&lt;</span><span class="n">Object</span><span class="o">,</span> <span class="kt">byte</span><span class="o">[]&gt;</span> <span class="n">encoder</span><span class="o">)</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>The <code>contentType</code> is the response content type to be encoded and the <code>objectType</code> is the type of configuration object to be encoded - this allows for the same content-type to have different encoders for different configuration object types.</p>
</div>
<div class="paragraph">
<p>A simple example of an encoder would be the default "text" encoder (provided in the <code>io.github.cjstehno.ersatz.encdec.Encoders</code> class):</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="java"><span class="kd">static</span> <span class="nc">Function</span><span class="o">&lt;</span><span class="nc">Object</span><span class="o">,</span> <span class="kt">byte</span><span class="o">[]&gt;</span> <span class="nf">text</span><span class="o">(</span><span class="kd">final</span> <span class="nc">Charset</span> <span class="n">charset</span><span class="o">)</span> <span class="o">{</span>
    <span class="k">return</span> <span class="n">obj</span> <span class="o">-&gt;</span> <span class="o">(</span><span class="n">obj</span> <span class="o">!=</span> <span class="kc">null</span> <span class="o">?</span> <span class="n">obj</span><span class="o">.</span><span class="na">toString</span><span class="o">()</span> <span class="o">:</span> <span class="s">""</span><span class="o">).</span><span class="na">getBytes</span><span class="o">(</span><span class="n">charset</span><span class="o">);</span>
<span class="o">}</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Simply stated, the response content object has <code>toString()</code> called on it and the result is then converted to bytes of the specified character set.</p>
</div>
<div class="paragraph">
<p>To use this encoder, you can configure it in a similar manner in both the server configuration block or in the response configuration block itself, which is shown below:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="java"><span class="n">server</span><span class="o">.</span><span class="na">expectations</span><span class="o">(</span><span class="n">expect</span> <span class="o">-&gt;</span> <span class="o">{</span>
    <span class="n">expect</span><span class="o">.</span><span class="na">POST</span><span class="o">(</span><span class="err">'</span><span class="o">/</span><span class="n">submit</span><span class="err">'</span><span class="o">,</span> <span class="n">req</span> <span class="o">-&gt;</span> <span class="o">{</span>
        <span class="n">req</span><span class="o">.</span><span class="na">responder</span><span class="o">(</span><span class="n">res</span> <span class="o">-&gt;</span> <span class="o">{</span>
            <span class="n">res</span><span class="o">.</span><span class="na">encoder</span><span class="o">(</span><span class="no">TEXT_PLAIN</span><span class="o">,</span> <span class="nc">String</span><span class="o">.</span><span class="na">class</span><span class="o">,</span> <span class="nc">Encoders</span><span class="o">.</span><span class="na">text</span><span class="o">(</span><span class="no">UTF_8</span><span class="o">));</span>
            <span class="n">req</span><span class="o">.</span><span class="na">body</span><span class="o">(</span><span class="s">"This is a string response!"</span><span class="o">,</span> <span class="no">TEXT_PLAIN</span><span class="o">);</span>
        <span class="o">});</span>
    <span class="o">});</span>
<span class="o">});</span></code></pre>
</div>
</div>
<div class="admonitionblock tip">
<table>
<tr>
<td class="icon">
<div class="title">Tip</div>
</td>
<td class="content">
As a design decision, no encoders are defined and registered on the server by default. If you need one, you need to register it. The only caveat to this is that if no encoder is specified, an attempt will be made to convert the body content to a byte array, if such a method is available.
</td>
</tr>
</table>
</div>
<div class="sect2">
<h3 id="_provided_encoders">Provided Encoders</h3>
<div class="paragraph">
<p>The API provides a handful of commonly used encoders. These are defined in the <code>io.github.cjstehno.ersatz.encdec.Encoders</code> class, and described below:</p>
</div>
<div class="ulist">
<ul>
<li>
<p><strong>Text.</strong> Encodes the object as a <code>String</code> of text, with optional character set specification.</p>
</li>
<li>
<p><strong>Content.</strong> Loads the content at the specified destination and returns it as a byte array. The content destination may be specified as an <code>InputStream</code>, <code>String</code>, <code>Path</code>, <code>File</code>, <code>URI</code>, or <code>URL</code>.</p>
</li>
<li>
<p><strong>Binary Base64.</strong> Encodes a byte array, InputStream or other object with a "getBytes()" method into a base-64 string.</p>
</li>
<li>
<p><strong>Multipart.</strong> Encodes a <code>MultipartResponseContent</code> object to its multipart string representation.</p>
</li>
</ul>
</div>
</div>
<div class="sect2">
<h3 id="_json_encoders">JSON Encoders</h3>
<div class="paragraph">
<p>As of 3.0.0 the built-in JSON Encoder was removed (to avoid dependency lock-in). Below are provided some simple/common implementations of them for use in your code:</p>
</div>
<div class="sect3">
<h4 id="_groovy_2">Groovy</h4>
<div class="paragraph">
<p>An encoder (serializer) implemented with the Groovy <code>JsonOutput</code> could be implemented as:</p>
</div>
<div class="paragraph">
<p>public static final Function&lt;Object, byte[]&gt; json = obj &#8594; (obj != null ? toJson(obj) : "{}").getBytes(UTF_8);</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="groovy"><span class="n">encoder</span><span class="o">(</span><span class="n">ContentType</span><span class="o">.</span><span class="na">APPLICATION_JSON</span><span class="o">,</span> <span class="n">MyType</span><span class="o">){</span> <span class="n">obj</span> <span class="o">-&gt;</span>
    <span class="n">JsonOutput</span><span class="o">.</span><span class="na">toJson</span><span class="o">(</span><span class="n">obj</span><span class="o">).</span><span class="na">getBytes</span><span class="o">(</span><span class="n">UTF_8</span><span class="o">)</span>
<span class="o">}</span></code></pre>
</div>
</div>
<div class="admonitionblock tip">
<table>
<tr>
<td class="icon">
<div class="title">Tip</div>
</td>
<td class="content">
If you are using the Groovy extension library, this encoder is available as the <code>JsonEncoder</code> class.
</td>
</tr>
</table>
</div>
</div>
<div class="sect3">
<h4 id="_jackson_2">Jackson</h4>
<div class="paragraph">
<p>An encoder (serializer) implemented using the Jackson JSON library could be implemented as:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="java"><span class="n">encoder</span><span class="o">(</span><span class="nc">ContentType</span><span class="o">.</span><span class="na">APPLICATION_JSON</span><span class="o">,</span> <span class="nc">MyType</span><span class="o">.</span><span class="na">class</span><span class="o">,</span> <span class="n">obj</span> <span class="o">-&gt;</span> <span class="o">{</span>
    <span class="k">return</span> <span class="k">new</span> <span class="nf">ObjectMapper</span><span class="o">().</span><span class="na">writeValueAsBytes</span><span class="o">(</span><span class="n">obj</span><span class="o">);</span>
<span class="o">});</span></code></pre>
</div>
</div>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_request_requirements">Request Requirements</h2>
<div class="sectionbody">
<div class="paragraph">
<p>Global request requirements allow for common configuration of expectation matching requirements in the <code>ServerConfig</code> rather than in the individual expectations.</p>
</div>
<div class="paragraph">
<p>Requirements have no response mechanism, they only serve to provide a common interface for shared request matching logic. Consider the case where every request to a server must have some security token configured as a header (say "Security-Token") and that all requests must use HTTPS. We could accomplish this with expectations with something like:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="java"><span class="kt">var</span> <span class="n">server</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">ErsatzServer</span><span class="o">(</span><span class="n">cfg</span> <span class="o">-&gt;</span> <span class="n">cfg</span><span class="o">.</span><span class="na">https</span><span class="o">());</span>
<span class="n">server</span><span class="o">.</span><span class="na">expectations</span><span class="o">(</span><span class="n">expect</span> <span class="o">-&gt;</span> <span class="o">{</span>
    <span class="n">expect</span><span class="o">.</span><span class="na">GET</span><span class="o">(</span><span class="s">"/retrieve"</span><span class="o">,</span> <span class="n">req</span> <span class="o">-&gt;</span> <span class="o">{</span>
        <span class="n">req</span><span class="o">.</span><span class="na">secure</span><span class="o">();</span>
        <span class="n">req</span><span class="o">.</span><span class="na">header</span><span class="o">(</span><span class="s">"Security-Token"</span><span class="o">,</span> <span class="n">expectedToken</span><span class="o">);</span>
        <span class="n">req</span><span class="o">.</span><span class="na">responder</span><span class="o">(</span><span class="n">res</span> <span class="o">-&gt;</span> <span class="o">{</span>
            <span class="n">res</span><span class="o">.</span><span class="na">body</span><span class="o">(</span><span class="n">aResponse</span><span class="o">,</span> <span class="no">APPLICATION_JSON</span><span class="o">);</span>
        <span class="o">});</span>
    <span class="o">});</span>
<span class="o">});</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>In this instance, it&#8217;s not all that bad, but consider now the case where you have multiple endpoints and you want to do some thorough testing against them&#8230;&#8203; you will be writing a lot of expectations and repeating a lot of that boiler-plate code simply to provide the request matcher.</p>
</div>
<div class="paragraph">
<p>The requirements framework allows this to be simplified. For the same scenario above, with requirements, we will have:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="java"><span class="kt">var</span> <span class="n">server</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">ErsatzServer</span><span class="o">(</span><span class="n">cfg</span> <span class="o">-&gt;</span> <span class="o">{</span>
    <span class="n">cfg</span><span class="o">.</span><span class="na">requirements</span><span class="o">(</span><span class="n">require</span> <span class="o">-&gt;</span> <span class="o">{</span>
        <span class="n">require</span><span class="o">.</span><span class="na">that</span><span class="o">(</span><span class="no">ANY</span><span class="o">,</span> <span class="n">anyPath</span><span class="o">(),</span> <span class="n">and</span> <span class="o">-&gt;</span> <span class="o">{</span>
            <span class="n">and</span><span class="o">.</span><span class="na">secure</span><span class="o">();</span>
            <span class="n">and</span><span class="o">.</span><span class="na">header</span><span class="o">(</span><span class="s">"Security-Token"</span><span class="o">,</span> <span class="n">expectedToken</span><span class="o">);</span>
        <span class="o">});</span>
    <span class="o">});</span>
<span class="o">});</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>This code defines a requirement that any request made using any request method or request path must use HTTPS and have the configured security token header. Any request that does not meet these requirements will be rejected just as if the configuration had been done in the expectations.</p>
</div>
<div class="paragraph">
<p>Now, you can write your expectations without the boilerplate code. The earlier code becomes:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="java"><span class="n">server</span><span class="o">.</span><span class="na">expectations</span><span class="o">(</span><span class="n">expect</span> <span class="o">-&gt;</span> <span class="o">{</span>
    <span class="n">expect</span><span class="o">.</span><span class="na">GET</span><span class="o">(</span><span class="s">"/retrieve"</span><span class="o">,</span> <span class="n">req</span> <span class="o">-&gt;</span> <span class="o">{</span>
        <span class="n">req</span><span class="o">.</span><span class="na">responder</span><span class="o">(</span><span class="n">res</span> <span class="o">-&gt;</span> <span class="o">{</span>
            <span class="n">res</span><span class="o">.</span><span class="na">body</span><span class="o">(</span><span class="n">aResponse</span><span class="o">,</span> <span class="no">APPLICATION_JSON</span><span class="o">);</span>
        <span class="o">});</span>
    <span class="o">});</span>
<span class="o">});</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Requirements provide a similar interface to the expectations, but provide no means of configuring a response.</p>
</div>
<div class="paragraph">
<p>The configured requirements are matched using the configured method and path matchers. If a request comes in matching the method and path matchers for a requirement, that request must then also match the configured request parameter requirements.</p>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_request_expectations">Request Expectations</h2>
<div class="sectionbody">
<div class="paragraph">
<p>The expectation definition methods take four common forms:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>One taking a <code>String path</code> returning an instance of the <code>Request</code> interface</p>
</li>
<li>
<p>One taking a <code>String path</code> and a <code>Consumer&lt;Request&gt;</code> returning an instance of the <code>Request</code> interface</p>
</li>
<li>
<p>One taking a <code>String path</code> and a Groovy <code>Closure</code> returning an instance of the <code>Request</code> interface</p>
</li>
<li>
<p>All the above with the <code>String path</code> replaced by a Hamcrest <code>Matcher&lt;String&gt;</code> for matching the path</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>The <code>Consumer&lt;Request&gt;</code> methods will provide a <code>Consumer&lt;Request&gt;</code> implementation to perform the configuration on a <code>Request</code> instance passed into the consumer function. The <code>path</code> strings in the verb methods may be called with <code><strong></code> as a wildcard value - this will match any request with that request method (e.g. <code>GET('</strong>')</code> would match any GET request while <code>any('*')</code> could be used to match <em>ANY</em> request made on the server).</p>
</div>
<div class="paragraph">
<p>The <code>Closure</code> support is similar to that of the consumer; however, this is a Groovy DSL approach where the <code>Closure</code> operations are delegated onto the a <code>Request</code> instance in order to configure the request.</p>
</div>
<div class="paragraph">
<p>All the expectation method types return an instance of the request being configured (<code>Request</code> or <code>RequestWithContent</code>).</p>
</div>
<div class="paragraph">
<p>There is also an <code>ANY</code> request method matcher configuration which will match a request regardless of the request method, if it matches the rest of the configured criteria.</p>
</div>
<div class="paragraph">
<p>The primary role of expectations is to provide a means of matching incoming requests in order to respond in a desired and repeatable manner. They are used for building up matching rules based on request properties to help filter and route the incoming request properly. <a href="http://hamcrest.org/">Hamcrest</a> Matcher support allows for flexible request matching based on various request properties.</p>
</div>
<div class="paragraph">
<p>The configuration interfaces support three main approaches to configuration, a chained builder approach, such as:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="groovy"><span class="n">HEAD</span><span class="o">(</span><span class="s1">'/foo'</span><span class="o">)</span>
    <span class="o">.</span><span class="na">query</span><span class="o">(</span><span class="s1">'a'</span><span class="o">,</span><span class="s1">'42'</span><span class="o">)</span>
    <span class="o">.</span><span class="na">cookie</span><span class="o">(</span><span class="s1">'stamp'</span><span class="o">,</span><span class="s1">'1234'</span><span class="o">)</span>
    <span class="o">.</span><span class="na">respond</span><span class="o">().</span><span class="na">header</span><span class="o">(</span><span class="s1">'ok'</span><span class="o">,</span><span class="s1">'true'</span><span class="o">)</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>where the code is a chain of builder-style method calls used to wire up the request expectation. The second method is available to users of the Groovy language, the Groovy DSL approach would code the same thing as:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="groovy"><span class="n">HEAD</span><span class="o">(</span><span class="s1">'/foo'</span><span class="o">){</span>
    <span class="n">query</span> <span class="s1">'a'</span><span class="o">,</span> <span class="s1">'42'</span>
    <span class="n">cookie</span> <span class="s1">'stamp'</span><span class="o">,</span> <span class="s1">'1234'</span>
    <span class="n">responder</span> <span class="o">{</span>
        <span class="n">header</span> <span class="s1">'ok'</span><span class="o">,</span> <span class="s2">"true"</span>
    <span class="o">}</span>
<span class="o">}</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>which can be more expressive, especially when creating more complicated expectations. A third approach is a Java-based approach more similar to the Groovy DSL, using the <code>Consumer&lt;?&gt;</code> methods of the interface, this would yield:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="java"><span class="no">HEAD</span><span class="o">(</span><span class="err">'</span><span class="o">/</span><span class="n">foo</span><span class="err">'</span><span class="o">,</span> <span class="n">req</span> <span class="o">-&gt;</span> <span class="o">{</span>
    <span class="n">req</span><span class="o">.</span><span class="na">query</span><span class="o">(</span><span class="s">"a"</span><span class="o">,</span> <span class="s">"42"</span><span class="o">)</span>
    <span class="n">req</span><span class="o">.</span><span class="na">cookie</span><span class="o">(</span><span class="s">"stamp"</span><span class="o">,</span> <span class="s">"1234"</span><span class="o">)</span>
    <span class="n">req</span><span class="o">.</span><span class="na">responder</span><span class="o">(</span> <span class="n">res</span><span class="o">-&gt;</span> <span class="o">{</span>
        <span class="n">res</span><span class="o">.</span><span class="na">header</span><span class="o">(</span><span class="s">"ok"</span><span class="o">,</span> <span class="s">"true"</span><span class="o">)</span>
    <span class="o">})</span>
<span class="o">})</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Any of the three may be used in conjunction with each other to build up expectations in the desired manner.</p>
</div>
<div class="admonitionblock tip">
<table>
<tr>
<td class="icon">
<div class="title">Tip</div>
</td>
<td class="content">
The matching of expectations is performed in the order the expectations are configured, such that if an incoming request could be matched by more than one expectation, the first one configured will be applied.
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>Request expectations may be configured to respond differently based on how many times a request is matched, for example, if you wanted the first request of <code>GET /something</code> to respond with <code>Hello</code> and second (and all subsequent) request of the same URL to respond with <code>Goodbye</code>, you would configure multiple responses, in order:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="groovy"><span class="n">GET</span><span class="o">(</span><span class="s1">'/something'</span><span class="o">){</span>
    <span class="n">responder</span> <span class="o">{</span>
        <span class="n">content</span> <span class="s1">'Hello'</span>
    <span class="o">}</span>
    <span class="n">responder</span> <span class="o">{</span>
        <span class="n">content</span> <span class="s1">'Goodbye'</span>
    <span class="o">}</span>
    <span class="n">called</span> <span class="mi">2</span>
<span class="o">}</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Adding the <code>called</code> configuration adds the extra safety of ensuring that if the request is called more than our expected two times, the verification will fail (and with that, the test).</p>
</div>
<div class="paragraph">
<p>Expectations may be cleared from the server using the <code>clearExpectations()</code> method. This is useful when you need to redefine expectations for one test only, but all the others have a common set of expectations.</p>
</div>
<div class="sect2">
<h3 id="_request_methods">Request Methods</h3>
<div class="paragraph">
<p>The Ersatz server supports all the standard HTTP request headers along with a few non-standard ones. The table below denotes the supported methods their contents.</p>
</div>
<table class="tableblock frame-all grid-all stretch">
<colgroup>
<col style="width: 25%;">
<col style="width: 25%;">
<col style="width: 25%;">
<col style="width: 25%;">
</colgroup>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">Method</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Request Body</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Response Body</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Reference</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">GET</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">N</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Y</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><a href="https://www.w3.org/Protocols/rfc2616/rfc2616-sec9.html#sec9.3">RFC2616 Sec 9.3</a></p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">HEAD</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">N</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">N</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><a href="https://www.w3.org/Protocols/rfc2616/rfc2616-sec9.html#sec9.4">RFC2616 Sec 9.4</a></p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">OPTIONS</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">N</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">N</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><a href="https://www.w3.org/Protocols/rfc2616/rfc2616-sec9.html#sec9.2">RFC2616 Sec 9.2</a></p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">POST</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Y</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Y</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><a href="https://www.w3.org/Protocols/rfc2616/rfc2616-sec9.html#sec9.5">RFC2616 Sec 9.5</a></p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">PUT</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Y</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">N</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><a href="https://www.w3.org/Protocols/rfc2616/rfc2616-sec9.html#sec9.6">RFC2616 Sec 9.6</a></p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">DELETE</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">N</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">N</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><a href="https://www.w3.org/Protocols/rfc2616/rfc2616-sec9.html#sec9.7">RFC2616 Sec 9.7</a></p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">PATCH</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Y</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">N</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><a href="https://tools.ietf.org/html/rfc5789">RFC5789</a></p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">TRACE</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">N</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Y</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><a href="https://www.w3.org/Protocols/rfc2616/rfc2616-sec9.html#sec9.8">RFC2616 Sec 9.8</a></p></td>
</tr>
</tbody>
</table>
<div class="paragraph">
<p>The following sections describe how each method is supported with a simple example.</p>
</div>
<div class="paragraph">
<p>While Ersatz does constrain the content of the request and response based on the request method, it is generally up to the mocker to provide the desired and/or appropriate responses (including most headers). This implementation leniency is intentional, and is meant to allow for endpoint implementations that do not necessarily follow the published specification, but likewise still need to be tested as they really exist rather than how they <em>should</em> exist.</p>
</div>
<div class="sect3">
<h4 id="_head">HEAD</h4>
<div class="paragraph">
<p>A <code>HEAD</code> request is used to retrieve the headers for a URL, basically a <code>GET</code> request without any response body. An Ersatz mocking example would be:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="groovy"><span class="n">ersatzServer</span><span class="o">.</span><span class="na">expectations</span> <span class="o">{</span>
    <span class="n">HEAD</span><span class="o">(</span><span class="s1">'/something'</span><span class="o">).</span><span class="na">responds</span><span class="o">().</span><span class="na">header</span><span class="o">(</span><span class="s1">'X-Alpha'</span><span class="o">,</span><span class="s1">'Interesting-data'</span><span class="o">).</span><span class="na">code</span><span class="o">(</span><span class="mi">200</span><span class="o">)</span>
<span class="o">}</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>which would respond to <code>HEAD /something</code> with an empty response and the response header <code>X-Alpha</code> with the specified value.</p>
</div>
</div>
<div class="sect3">
<h4 id="_get">GET</h4>
<div class="paragraph">
<p>The <code>GET</code> request is a common HTTP request, and what browsers do by default. It has no request body, but it does have response content. You mock <code>GET</code> requests using the <code>get()</code> methods, as follows:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="groovy"><span class="n">ersatzServer</span><span class="o">.</span><span class="na">expectations</span> <span class="o">{</span>
    <span class="n">GET</span><span class="o">(</span><span class="s1">'/something'</span><span class="o">).</span><span class="na">responds</span><span class="o">().</span><span class="na">body</span><span class="o">(</span><span class="s1">'This is INTERESTING!'</span><span class="o">,</span> <span class="s1">'text/plain'</span><span class="o">).</span><span class="na">code</span><span class="o">(</span><span class="mi">200</span><span class="o">)</span>
<span class="o">}</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>In a RESTful interface, a <code>GET</code> request is usually used to "read" or retrieve a resource representation.</p>
</div>
</div>
<div class="sect3">
<h4 id="_options">OPTIONS</h4>
<div class="paragraph">
<p>The <code>OPTIONS</code> HTTP request method is similar to an <code>HEAD</code> request, having no request or response body. The primary response value in an <code>OPTIONS</code> request is the content of the <code>Allow</code> response header, which will contain a comma-separated list of the request methods supported by the server. The request may be made against a specific URL path, or against <code>*</code> in order to determine what methods are available to the entire server.</p>
</div>
<div class="paragraph">
<p>In order to mock out an <code>OPTIONS</code> request, you will want to respond with a provided <code>Allow</code> header. This may be done using the
<code>Response.allows(HttpMethod&#8230;&#8203;)</code> method in the responder. An example would be something like:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="groovy"><span class="n">ersatzServer</span><span class="o">.</span><span class="na">expectations</span> <span class="o">{</span>
    <span class="n">OPTIONS</span><span class="o">(</span><span class="s1">'/options'</span><span class="o">).</span><span class="na">responds</span><span class="o">().</span><span class="na">allows</span><span class="o">(</span><span class="n">GET</span><span class="o">,</span> <span class="n">POST</span><span class="o">).</span><span class="na">code</span><span class="o">(</span><span class="mi">200</span><span class="o">)</span>
    <span class="n">OPTIONS</span><span class="o">(</span><span class="s1">'/*'</span><span class="o">).</span><span class="na">responds</span><span class="o">().</span><span class="na">allows</span><span class="o">(</span><span class="n">DELETE</span><span class="o">,</span> <span class="n">GET</span><span class="o">,</span> <span class="n">OPTIONS</span><span class="o">).</span><span class="na">code</span><span class="o">(</span><span class="mi">200</span><span class="o">)</span>
<span class="o">}</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>This will provide different allowed options for <code>/options</code> and for the "entire server" (<code>*</code>). You can also specify the <code>Allow</code> header as a standard response header.</p>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<div class="title">Note</div>
</td>
<td class="content">
Not all client and servers will support the <code>OPTIONS</code> request method.
</td>
</tr>
</table>
</div>
</div>
<div class="sect3">
<h4 id="_post">POST</h4>
<div class="paragraph">
<p>The <code>POST</code> request is often used to send browser form data to a backend server. It can have both request and response content.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="groovy"><span class="n">ersatzServer</span><span class="o">.</span><span class="na">expectations</span> <span class="o">{</span>
    <span class="n">POST</span><span class="o">(</span><span class="s1">'/form'</span><span class="o">){</span>
        <span class="n">body</span><span class="o">([</span><span class="nl">first:</span><span class="s1">'John'</span><span class="o">,</span> <span class="nl">last:</span><span class="s1">'Doe'</span><span class="o">],</span> <span class="n">APPLICATION_URLENCODED</span><span class="o">)</span>
        <span class="n">responder</span> <span class="o">{</span>
            <span class="n">body</span><span class="o">(</span><span class="s1">'{ status:"saved" }'</span><span class="o">,</span> <span class="n">APPLICATION_JSON</span><span class="o">)</span>
        <span class="o">}</span>
    <span class="o">}</span>
<span class="o">}</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>In a RESTful interface, the <code>POST</code> method is generally used to "create" new resources.</p>
</div>
</div>
<div class="sect3">
<h4 id="_put">PUT</h4>
<div class="paragraph">
<p>A <code>PUT</code> request is similar to a <code>POST</code> except that while there is request content, there is no response body content.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="groovy"><span class="n">ersatzServer</span><span class="o">.</span><span class="na">expectations</span> <span class="o">{</span>
    <span class="n">PUT</span><span class="o">(</span><span class="s1">'/form'</span><span class="o">){</span>
        <span class="n">query</span><span class="o">(</span><span class="s1">'id'</span><span class="o">,</span><span class="s1">'1234'</span><span class="o">)</span>
        <span class="n">body</span><span class="o">([</span><span class="nl">middle:</span><span class="s1">'Q'</span><span class="o">],</span> <span class="n">APPLICATION_URLENCODED</span><span class="o">)</span>
        <span class="n">responder</span> <span class="o">{</span>
            <span class="n">code</span><span class="o">(</span><span class="mi">200</span><span class="o">)</span>
        <span class="o">}</span>
    <span class="o">}</span>
<span class="o">}</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>In a RESTful interface, a <code>PUT</code> request if most often used as an "update" operation.</p>
</div>
</div>
<div class="sect3">
<h4 id="_delete">DELETE</h4>
<div class="paragraph">
<p>A <code>DELETE</code> request has not request or response content. It would look something like:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="groovy"><span class="n">ersatzServer</span><span class="o">.</span><span class="na">expectations</span> <span class="o">{</span>
    <span class="n">DELETE</span><span class="o">(</span><span class="s1">'/user'</span><span class="o">).</span><span class="na">query</span><span class="o">(</span><span class="s1">'id'</span><span class="o">,</span><span class="s1">'1234'</span><span class="o">).</span><span class="na">responds</span><span class="o">().</span><span class="na">code</span><span class="o">(</span><span class="mi">200</span><span class="o">)</span>
<span class="o">}</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>In a RESTful interface, a <code>DELETE</code> request may be used as a "delete" operation.</p>
</div>
</div>
<div class="sect3">
<h4 id="_patch">PATCH</h4>
<div class="paragraph">
<p>The <code>PATCH</code> request method creates a request that can have body content; however, the response will have no content.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="groovy"><span class="n">ersatzServer</span><span class="o">.</span><span class="na">expectations</span> <span class="o">{</span>
    <span class="n">PATCH</span><span class="o">(</span><span class="s1">'/user'</span><span class="o">){</span>
        <span class="n">query</span><span class="o">(</span><span class="s1">'id'</span><span class="o">,</span><span class="s1">'1234'</span><span class="o">)</span>
        <span class="n">body</span><span class="o">(</span><span class="s1">'{ "middle":"Q"}'</span><span class="o">,</span> <span class="n">APPLICATION_JSON</span><span class="o">)</span>
        <span class="n">responder</span> <span class="o">{</span>
            <span class="n">code</span><span class="o">(</span><span class="mi">200</span><span class="o">)</span>
        <span class="o">}</span>
    <span class="o">}</span>
<span class="o">}</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>In a RESTful interface, a <code>PATCH</code> request may be used as a "modify" operation for an existing resource.</p>
</div>
</div>
<div class="sect3">
<h4 id="_any">ANY</h4>
<div class="paragraph">
<p>The <code>ANY</code> request method creates a request expectation that can match any HTTP method - the body of the expectation will
have the same format as the HTTP method expectations described earlier.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="java"><span class="n">server</span><span class="o">.</span><span class="na">expectations</span><span class="o">(</span><span class="n">expect</span> <span class="o">-&gt;</span> <span class="o">{</span>
    <span class="n">expect</span><span class="o">.</span><span class="na">ANY</span><span class="o">(</span><span class="s">"/something"</span><span class="o">,</span> <span class="n">req</span> <span class="o">-&gt;</span> <span class="o">{</span>
        <span class="n">req</span><span class="o">.</span><span class="na">secure</span><span class="o">();</span>
        <span class="n">req</span><span class="o">.</span><span class="na">called</span><span class="o">(</span><span class="mi">1</span><span class="o">);</span>
        <span class="n">req</span><span class="o">.</span><span class="na">responder</span><span class="o">(</span><span class="n">res</span> <span class="o">-&gt;</span> <span class="n">res</span><span class="o">.</span><span class="na">body</span><span class="o">(</span><span class="n">responseText</span><span class="o">,</span> <span class="no">TEXT_PLAIN</span><span class="o">));</span>
    <span class="o">});</span>
<span class="o">});</span></code></pre>
</div>
</div>
</div>
<div class="sect3">
<h4 id="_generic_method">Generic Method</h4>
<div class="paragraph">
<p>In version 3.2 a generic set of request expectation methods were added to allow the definition of request expectations
based on variable HTTP request methods:</p>
</div>
<div class="listingblock">
<div class="content">
<pre>Request request(final HttpMethod method, final String path)
Request request(final HttpMethod method, final Matcher&lt;String&gt; matcher)
Request request(final HttpMethod method, final String path, Consumer&lt;Request&gt; consumer)
Request request(final HttpMethod method, final Matcher&lt;String&gt; matcher, final Consumer&lt;Request&gt; consumer)
Request request(final HttpMethod method, final PathMatcher pathMatcher)
Request request(final HttpMethod method, final PathMatcher pathMatcher, Consumer&lt;Request&gt; consumer)</pre>
</div>
</div>
<div class="paragraph">
<p>These expectation methods work in the same manner as the method-specific interfaces described above.</p>
</div>
<div class="paragraph">
<p>This functionality is useful when writing tests for an endpoint that may accept multiple HTTP methods for the same
underlying endpoint resource.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="java"><span class="n">server</span><span class="o">.</span><span class="na">expectations</span><span class="o">(</span><span class="n">expect</span> <span class="o">-&gt;</span> <span class="o">{</span>
    <span class="n">expect</span><span class="o">.</span><span class="na">request</span><span class="o">(</span><span class="no">GET</span><span class="o">,</span> <span class="s">"/something"</span><span class="o">,</span> <span class="n">req</span> <span class="o">-&gt;</span> <span class="o">{</span>
        <span class="n">req</span><span class="o">.</span><span class="na">secure</span><span class="o">();</span>
        <span class="n">req</span><span class="o">.</span><span class="na">called</span><span class="o">(</span><span class="mi">1</span><span class="o">);</span>
        <span class="n">req</span><span class="o">.</span><span class="na">responds</span><span class="o">().</span><span class="na">body</span><span class="o">(</span><span class="n">responseText</span><span class="o">,</span> <span class="no">TEXT_PLAIN</span><span class="o">);</span>
    <span class="o">});</span>
<span class="o">});</span></code></pre>
</div>
</div>
</div>
<div class="sect3">
<h4 id="_trace">TRACE</h4>
<div class="paragraph">
<p>The <code>TRACE</code> method is generally meant for debugging and diagnostics. The request will have no request content; however, if the request is valid, the response will contain the entire request message in the entity-body, with a Content-Type of <code>message/http</code>. With that in mind, the <code>TRACE</code> method is implemented a bit differently than the other HTTP methods. It&#8217;s not available for mocking, but it will provide an echo of the request as it is supposed to. For example the following request (raw):</p>
</div>
<div class="listingblock">
<div class="content">
<pre>TRACE / HTTP/1.1
Host: www.something.com</pre>
</div>
</div>
<div class="paragraph">
<p>would respond with something like the following response (raw):</p>
</div>
<div class="listingblock">
<div class="content">
<pre>HTTP/1.1 200 OK
Server: Microsoft-IIS/5.0
Date: Tue, 31 Oct 2006 08:01:48 GMT
Connection: close
Content-Type: message/http
Content-Length: 39

TRACE / HTTP/1.1
Host: www.something.com</pre>
</div>
</div>
<div class="paragraph">
<p>Since this functionality is already designed for diagnostics purposes, it was decided that it would be best to simply implement and support the request method rather than allow it to be mocked.</p>
</div>
<div class="paragraph">
<p>Making a <code>TRACE</code> request to Ersatz looks like the following (Groovy):</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="groovy"><span class="n">ersatzServer</span><span class="o">.</span><span class="na">start</span><span class="o">()</span>

<span class="n">URL</span> <span class="n">url</span> <span class="o">=</span> <span class="k">new</span> <span class="n">URL</span><span class="o">(</span><span class="s2">"${ersatzServer.httpUrl}/info?data=foo+bar"</span><span class="o">)</span>
<span class="n">HttpURLConnection</span> <span class="n">connection</span> <span class="o">=</span> <span class="n">url</span><span class="o">.</span><span class="na">openConnection</span><span class="o">()</span> <span class="k">as</span> <span class="n">HttpURLConnection</span>
<span class="n">connection</span><span class="o">.</span><span class="na">requestMethod</span> <span class="o">=</span> <span class="s1">'TRACE'</span>

<span class="k">assert</span> <span class="n">connection</span><span class="o">.</span><span class="na">contentType</span> <span class="o">==</span> <span class="n">MESSAGE_HTTP</span><span class="o">.</span><span class="na">value</span>
<span class="k">assert</span> <span class="n">connection</span><span class="o">.</span><span class="na">responseCode</span> <span class="o">==</span> <span class="mi">200</span>

<span class="k">assert</span> <span class="n">connection</span><span class="o">.</span><span class="na">inputStream</span><span class="o">.</span><span class="na">text</span><span class="o">.</span><span class="na">readLines</span><span class="o">()*.</span><span class="na">trim</span><span class="o">()</span> <span class="o">==</span> <span class="s2">"""TRACE /info?data=foo+barHTTP/1.1
    Accept: text/html, image/gif, image/jpeg, *; q=.2, */*; q=.2
    Connection: keep-alive
    User-Agent: Java/1.9.0.1_121
    Host: localhost:${ersatzServer.httpPort}
"""</span><span class="o">.</span><span class="na">readLines</span><span class="o">()*.</span><span class="na">trim</span><span class="o">()</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>The explicit <code>start()</code> call is required since there are no expectations specified (auto-start won&#8217;t fire). The <code>HttpUrlConnection</code> is used to make the request, and it can be seen that the response content is the same as the original request content.</p>
</div>
<div class="paragraph">
<p>The <code>TRACE</code> method is supported using the built-in <code>HttpTraceHandler</code> provided by the embedded <a href="http://undertow.io">Undertow</a> server.</p>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<div class="title">Note</div>
</td>
<td class="content">
At some point, if there are valid use cases for allowing mocks of <code>TRACE</code> it could be supported. Feel free to
<a href="https://github.com/cjstehno/ersatz/issues/new">create an Issue ticket</a> describing your use case, and it will be addressed.
</td>
</tr>
</table>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_verification_2">Verification</h3>
<div class="paragraph">
<p>A timeout (and unit) parameter is available on the <code>verify</code> method so that a failed verification can fail-out in a timely manner, while still waiting for messages that are not coming.</p>
</div>
</div>
<div class="sect2">
<h3 id="_request_matching">Request Matching</h3>
<div class="paragraph">
<p>When a request comes into the server an attempt is made to match it against the configured request expectations. When a match is found, the configured response it returned to the client; however, when no expectation matches the request a 404 response will be returned and a mismatch report will be written to the logs, an example is shown below:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="text"># Unmatched Request

HTTP GET /alpha/foo ? selected=[one, two], id=[1002]
Headers:
    - alpha: [bravo-1, bravo-2]
    - charlie: [delta]
    - Content-Type: [text/plain]
Cookies:
    - ident (null, null): asdfasdfasdf
Character-Encoding: UTF-8
Content-type: text/plain
Content-Length: 1234
Content:
    [84, 104, 105, 115, 32, 105, 115, 32, 115, 111, 109, 101, 32, 116, 101, 120, 116, 32, 99, 111, 110, 116, 101, 110, 116]

# Expectations

Expectation 0 (2 matchers):
    X HTTP method matches &lt;POST&gt;
    ✓ Path matches "/alpha/foo"
    (2 matchers: 1 matched, 1 failed)

Expectation 1 (3 matchers):
    X HTTP method matches &lt;PUT&gt;
    X Path matches a string starting with "/alpha/bar"
    X Protocol matches equalToIgnoringCase("HTTPS")
    (3 matchers: 0 matched, 3 failed)</code></pre>
</div>
</div>
<div class="paragraph">
<p>It will show the incoming request that was not matched with all of its known details, as well as a detailed explanation of the configured expectations and each matcher it provides. Successful matches are marked with a checkmark (<code>✓</code>), and mis-matches with an <code>X</code>.</p>
</div>
<div class="paragraph">
<p>Alternately, you may specify the <code>reportToConsole true</code> configuration in the server config. This will cause the report to be written to the standard output console as well as into the log output. This is useful for cases when you might have logging turned off.</p>
</div>
<div class="admonitionblock tip">
<table>
<tr>
<td class="icon">
<div class="title">Tip</div>
</td>
<td class="content">
Be aware that any <a href="#_request_requirements">Request Requirements</a> are tested before expectation request matchers.
</td>
</tr>
</table>
</div>
<div class="sect3">
<h4 id="_hamcrest_matchers">Hamcrest Matchers</h4>
<div class="paragraph">
<p>Many of the expectation methods accept <a href="http://hamcrest.org/">Hamcrest</a> <code>Matcher</code> instances as an alternate argument. Hamcrest matchers allow for a more rich and expressive matching configuration. Consider the following configuration:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="groovy"><span class="n">server</span><span class="o">.</span><span class="na">expectations</span> <span class="o">{</span>
    <span class="n">GET</span><span class="o">(</span> <span class="n">startsWith</span><span class="o">(</span><span class="s1">'/foo'</span><span class="o">)</span> <span class="o">){</span>
        <span class="n">called</span> <span class="nf">greaterThanOrEqualTo</span><span class="o">(</span><span class="mi">2</span><span class="o">)</span>
        <span class="n">query</span> <span class="s1">'user-key'</span><span class="o">,</span> <span class="n">notNullValue</span><span class="o">()</span>
        <span class="n">responder</span> <span class="o">{</span>
            <span class="n">body</span> <span class="s1">'ok'</span><span class="o">,</span> <span class="n">TEXT_PLAIN</span>
        <span class="o">}</span>
    <span class="o">}</span>
<span class="o">}</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>This configuration would match a <code>GET</code> request to a URL starting with <code>/foo</code>, with a non-null query string "user-key" value. This request matcher is expected to be called at least twice and it will respond with a <code>text/plain</code> response of <code>ok</code>.</p>
</div>
<div class="paragraph">
<p>The methods that accept matchers will have a non-matcher version which provides a sensible default matcher (e.g. <code>GET(Matcher)</code> has <code>GET(String)</code> which provides delegates to <code>GET( equalTo( string ) )</code> to wrap the provided path string in a matcher.</p>
</div>
<div class="paragraph">
<p>If you are using Groovy, you can actually replace Hamcrest matchers with a <code>Closure</code> emulating the same interface - basically a method that takes the parameter and returns whether the condition was matched. The same example above could be re-written as:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="groovy"><span class="n">server</span><span class="o">.</span><span class="na">expectations</span> <span class="o">{</span>
    <span class="n">GET</span><span class="o">({</span> <span class="n">p</span><span class="o">-&gt;</span> <span class="n">p</span><span class="o">.</span><span class="na">startsWith</span><span class="o">(</span><span class="s1">'/foo'</span><span class="o">)</span> <span class="o">}){</span>
        <span class="n">called</span> <span class="o">{</span> <span class="n">i</span><span class="o">-&gt;</span> <span class="n">i</span> <span class="o">&gt;=</span> <span class="mi">2</span> <span class="o">}</span>
        <span class="n">query</span> <span class="s1">'user-key'</span><span class="o">,</span> <span class="n">notNullValue</span><span class="o">()</span>
        <span class="n">responder</span> <span class="o">{</span>
            <span class="n">body</span> <span class="s1">'ok'</span><span class="o">,</span> <span class="n">TEXT_PLAIN</span>
        <span class="o">}</span>
    <span class="o">}</span>
<span class="o">}</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>This allows for additional flexibility in configuring expectations.</p>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_specialized_matchers">Specialized Matchers</h3>
<div class="paragraph">
<p>There are a handful of specialized Hamcrest matchers defined and used in the API. They are used as the underlying internal matchers, but are also useful in your code - these may be found in the <code>io.github.cjstehno.ersatz.match</code> package:</p>
</div>
<div class="ulist">
<ul>
<li>
<p><code>BodyMatcher</code> - provides various matching methods for body content.</p>
</li>
<li>
<p><code>BodyParamMatcher</code> - provides matching methods for request body paramters.</p>
</li>
<li>
<p><code>PathMatcher</code> - provides matching methods for request paths.</p>
</li>
<li>
<p><code>QueryParamMatcher</code> - provides matching methods for request query string parameters.</p>
</li>
<li>
<p><code>HeaderMatcher</code> - provides matching methods for request header values.</p>
</li>
<li>
<p><code>RequestCookieMatcher</code> - provides matching methods for request cookie data.</p>
</li>
<li>
<p><code>PredicateMatcher</code> - provides an adapter for wrapping simple <code>Predicate</code> functions as matchers.</p>
</li>
</ul>
</div>
<div class="sect3">
<h4 id="_matching_cookies">Matching Cookies</h4>
<div class="paragraph">
<p>There are four methods for matching cookies associated with a request (found in the <code>io.github.cjstehno.ersatz.cfg.Request</code> interface):</p>
</div>
<div class="sect4">
<h5 id="_by_name_and_matcher">By Name and Matcher</h5>
<div class="paragraph">
<p>The <code>cookie(String name, Matcher&lt;Cookie&gt; matcher)</code> method configures the specified matcher for the cookie with the given name.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="groovy"><span class="n">server</span><span class="o">.</span><span class="na">expectations</span> <span class="o">{</span>
    <span class="n">GET</span><span class="o">(</span><span class="s1">'/somewhere'</span><span class="o">){</span>
        <span class="n">cookie</span> <span class="s1">'user-key'</span><span class="o">,</span> <span class="n">CookieMatcher</span><span class="o">.</span><span class="na">cookieMatcher</span> <span class="o">{</span>
            <span class="n">value</span> <span class="nf">startsWith</span><span class="o">(</span><span class="s1">'key-'</span><span class="o">)</span>
            <span class="n">domain</span> <span class="s1">'mydomain.com'</span>
        <span class="o">}</span>
        <span class="n">responds</span><span class="o">().</span><span class="na">code</span><span class="o">(</span><span class="mi">200</span><span class="o">)</span>
    <span class="o">}</span>
<span class="o">}</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>The Hamcrest matcher used may be a custom <code>Matcher</code> implementation, or the provided <code>io.github.cjstehno.ersatz.match.CookieMatcher</code>.</p>
</div>
</div>
<div class="sect4">
<h5 id="_by_name_and_value">By Name and Value</h5>
<div class="paragraph">
<p>The <code>cookie(String name, String value)</code> method is a shortcut for configuring simple name/value matching where the cookie value must be equal to the specified value. An example:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="groovy"><span class="n">server</span><span class="o">.</span><span class="na">expectations</span> <span class="o">{</span>
    <span class="n">GET</span><span class="o">(</span><span class="s1">'/somewhere'</span><span class="o">).</span><span class="na">cookie</span><span class="o">(</span><span class="s1">'user-key'</span><span class="o">,</span> <span class="s1">'key-23435HJKSDGF86'</span><span class="o">).</span><span class="na">responds</span><span class="o">().</span><span class="na">code</span><span class="o">(</span><span class="mi">200</span><span class="o">)</span>
<span class="o">}</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>This is equivalent to calling the matcher-based version of the method:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="groovy"><span class="n">server</span><span class="o">.</span><span class="na">expectations</span> <span class="o">{</span>
    <span class="n">GET</span><span class="o">(</span><span class="s1">'/somewhere'</span><span class="o">){</span>
        <span class="n">cookie</span> <span class="s1">'user-key'</span><span class="o">,</span> <span class="n">CookieMatcher</span><span class="o">.</span><span class="na">cookieMatcher</span> <span class="o">{</span>
            <span class="n">value</span> <span class="nf">equalTo</span><span class="o">(</span><span class="s1">'key-23435HJKSDGF86'</span><span class="o">)</span>
        <span class="o">}</span>
        <span class="n">responds</span><span class="o">().</span><span class="na">code</span><span class="o">(</span><span class="mi">200</span><span class="o">)</span>
    <span class="o">}</span>
<span class="o">}</span></code></pre>
</div>
</div>
</div>
<div class="sect4">
<h5 id="_multiple_cookies">Multiple Cookies</h5>
<div class="paragraph">
<p>The <code>cookies(Map&lt;String,Object&gt;)</code> method provides a means of configuring multiple cookie matchers (as value `String`s or cookie `Matcher`s). In the following example matchers are configured to match the 'user-key' cookie for values "starting with" the specified value, the request should also have an 'app-id' cookie with a value of "user-manager", and finally the request should <em>not</em> have the 'timeout' cookie specified.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="groovy"><span class="n">server</span><span class="o">.</span><span class="na">expectations</span> <span class="o">{</span>
    <span class="n">GET</span><span class="o">(</span><span class="s1">'/something'</span><span class="o">){</span>
        <span class="n">cookies</span><span class="o">([</span>
            <span class="s1">'user-key'</span><span class="o">:</span> <span class="n">cookieMatcher</span> <span class="o">{</span>
                <span class="n">value</span> <span class="nf">startsWith</span><span class="o">(</span><span class="s1">'key-'</span><span class="o">)</span>
            <span class="o">},</span>
            <span class="s1">'appid'</span><span class="o">:</span> <span class="s1">'user-manager'</span><span class="o">,</span>
            <span class="s1">'timeout'</span><span class="o">:</span> <span class="n">nullValue</span><span class="o">()</span>
        <span class="o">])</span>
        <span class="n">responds</span><span class="o">().</span><span class="na">code</span><span class="o">(</span><span class="mi">200</span><span class="o">)</span>
    <span class="o">}</span>
<span class="o">}</span></code></pre>
</div>
</div>
</div>
</div>
<div class="sect3">
<h4 id="_overall_matcher">Overall Matcher</h4>
<div class="paragraph">
<p>The <code>cookies(Matcher&lt;Map&lt;String,Cookie&gt;)</code> method is used to specify a <code>Matcher</code> for the map of cookie names to <code>io.github.cjstehno.ersatz.cfg.Cookie</code> objects. The matcher may be any custom matcher, or the <code>io.github.cjstehno.ersatz.match.NoCookiesMatcher</code> may be used to match for the case where no cookies should be defined
in the request:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="groovy"><span class="n">server</span><span class="o">.</span><span class="na">expectations</span> <span class="o">{</span>
    <span class="n">get</span><span class="o">(</span><span class="s1">'/something'</span><span class="o">){</span>
        <span class="n">cookies</span> <span class="n">NoCookiesMatcher</span><span class="o">.</span><span class="na">noCookies</span><span class="o">()</span>
        <span class="n">responds</span><span class="o">().</span><span class="na">code</span><span class="o">(</span><span class="mi">200</span><span class="o">)</span>
    <span class="o">}</span>
<span class="o">}</span></code></pre>
</div>
</div>
</div>
<div class="sect3">
<h4 id="_multipart_request_content">Multipart Request Content</h4>
<div class="paragraph">
<p>Ersatz server supports multipart file upload requests (<code>multipart/form-data</code> content-type) using the <a href="https://commons.apache.org/proper/commons-fileupload/">Apache File Upload</a> library on the "server" side. The expectations for multipart requests are
configured using the <code>MultipartRequestContent</code> class to build up an equivalent multipart matcher:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="groovy"><span class="n">ersatz</span><span class="o">.</span><span class="na">expectataions</span> <span class="o">{</span>
    <span class="n">POST</span><span class="o">(</span><span class="s1">'/upload'</span><span class="o">)</span> <span class="o">{</span>
        <span class="n">decoder</span> <span class="n">MULTIPART_MIXED</span><span class="o">,</span> <span class="n">Decoders</span><span class="o">.</span><span class="na">multipart</span>
        <span class="n">decoder</span> <span class="n">IMAGE_PNG</span><span class="o">,</span> <span class="n">Decoders</span><span class="o">.</span><span class="na">passthrough</span>
        <span class="n">body</span> <span class="n">multipart</span> <span class="o">{</span>
            <span class="n">part</span> <span class="s1">'something'</span><span class="o">,</span> <span class="s1">'interesting'</span>
            <span class="n">part</span> <span class="s1">'infoFile'</span><span class="o">,</span> <span class="s1">'info.txt'</span><span class="o">,</span> <span class="n">TEXT_PLAIN</span><span class="o">,</span> <span class="n">infoText</span>
            <span class="n">part</span> <span class="s1">'imageFile'</span><span class="o">,</span> <span class="s1">'image.png'</span><span class="o">,</span> <span class="n">IMAGE_PNG</span><span class="o">,</span> <span class="n">imageBytes</span>
        <span class="o">},</span> <span class="n">MULTIPART_MIXED</span>
        <span class="n">responder</span> <span class="o">{</span>
            <span class="n">body</span> <span class="s1">'ok'</span>
        <span class="o">}</span>
    <span class="o">}</span>
<span class="o">}</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>which will need to exactly match the incoming request body in order to be considered a match. There is also a <code>MultipartRequestMatcher</code> used to provide a more flexible Hamcrest-based matching of the request body:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="groovy"><span class="n">server</span><span class="o">.</span><span class="na">expectations</span> <span class="o">{</span>
    <span class="n">POST</span><span class="o">(</span><span class="s1">'/upload'</span><span class="o">)</span> <span class="o">{</span>
        <span class="n">decoder</span> <span class="n">MULTIPART_MIXED</span><span class="o">,</span> <span class="n">Decoders</span><span class="o">.</span><span class="na">multipart</span>
        <span class="n">decoder</span> <span class="n">IMAGE_PNG</span><span class="o">,</span> <span class="n">Decoders</span><span class="o">.</span><span class="na">passthrough</span>
        <span class="n">body</span> <span class="n">multipartMatcher</span> <span class="o">{</span>
            <span class="n">part</span> <span class="s1">'something'</span><span class="o">,</span> <span class="n">notNullValue</span><span class="o">()</span>
            <span class="n">part</span> <span class="s1">'infoFile'</span><span class="o">,</span> <span class="n">endsWith</span><span class="o">(</span><span class="s1">'.txt'</span><span class="o">),</span> <span class="n">TEXT_PLAIN</span><span class="o">,</span> <span class="n">notNullValue</span><span class="o">()</span>
            <span class="n">part</span> <span class="s1">'imageFile'</span><span class="o">,</span> <span class="n">endsWith</span><span class="o">(</span><span class="s1">'.png'</span><span class="o">),</span> <span class="n">IMAGE_PNG</span><span class="o">,</span> <span class="n">notNullValue</span><span class="o">()</span>
        <span class="o">},</span> <span class="n">MULTIPART_MIXED</span>
        <span class="n">responder</span> <span class="o">{</span>
            <span class="n">body</span> <span class="s1">'ok'</span>
        <span class="o">}</span>
    <span class="o">}</span>
<span class="o">}</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>This will configure a match of the request body content based on the individual matchers, rather than overall equivalence.</p>
</div>
<div class="paragraph">
<p>A key point in multipart request support are the "decoders", which are used to decode the incoming request content into an expected object type.</p>
</div>
<div class="admonitionblock tip">
<table>
<tr>
<td class="icon">
<div class="title">Tip</div>
</td>
<td class="content">
No decoders are provided by default, any used in the request content <em>must</em> be provided in configuration.
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>Some common reusable decoders are provided in the <code>Decoders</code> utility class.</p>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_response_building">Response Building</h3>
<div class="paragraph">
<p>The <code>responds(&#8230;&#8203;)</code>, <code>responder(&#8230;&#8203;)</code>, and <code>forward(&#8230;&#8203;)</code> methods of the <code>Request</code> matcher allow for the customization of the response to the request. Basic response properties such as headers, status code, and content body are available, as well as some more advanced configuration options, described below:</p>
</div>
<div class="sect3">
<h4 id="_request_response_compression">Request / Response Compression</h4>
<div class="paragraph">
<p>Ersatz supports GZip compression seamlessly as long as the <code>Accept-Encoding</code> header is specified as <code>gzip</code>. If the response is compressed, a <code>Content-Encoding</code> header will be added to the response with the appropriate compression type as the value.</p>
</div>
</div>
<div class="sect3">
<h4 id="_chunked_response">Chunked Response</h4>
<div class="paragraph">
<p>A response may be configured as a "chunked" response, wherein the response data is sent to the client in small bits along with an additional response header, the <code>Transfer-encoding: chunked</code> header. For testing purposes, a fixed or randomized range of time delay may be configured so that the chunks may be sent slowly, to more accurately simulate a real environment.</p>
</div>
<div class="paragraph">
<p>To configure a chunked response, provide a <code>ChunkingConfig</code> to the response configuration:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="groovy"><span class="n">ersatzServer</span><span class="o">.</span><span class="na">expectations</span> <span class="o">{</span>
    <span class="n">GET</span><span class="o">(</span><span class="s1">'/chunky'</span><span class="o">).</span><span class="na">responder</span> <span class="o">{</span>
        <span class="n">body</span> <span class="s1">'This is chunked content'</span><span class="o">,</span> <span class="n">TEXT_PLAIN</span>
        <span class="n">chunked</span> <span class="o">{</span>
            <span class="n">chunks</span> <span class="mi">3</span>
            <span class="n">delay</span> <span class="mi">100</span><span class="o">..</span><span class="mi">500</span>
        <span class="o">}</span>
    <span class="o">}</span>
<span class="o">}</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>In the example, the response content will be broken into <code>3</code> roughly equal chunks, each of which is sent to the client after a random delay between 100 and 500 milliseconds. This <code>delay</code> value may also be a fixed number of milliseconds, or omitted to send the content as fast as possible.</p>
</div>
<div class="admonitionblock tip">
<table>
<tr>
<td class="icon">
<div class="title">Tip</div>
</td>
<td class="content">
The <code>Transfer-encoding</code> response header will be set automatically when a <code>chunked</code> configuration is specified on the response.
</td>
</tr>
</table>
</div>
</div>
<div class="sect3">
<h4 id="_multipart_response_content">Multipart Response Content</h4>
<div class="paragraph">
<p>Multipart response content is supported, though most browsers do not fully support it - the expected use case would be a RESTful or other HTTP-based API. The response content will have the standard <code>multipart/form-data</code> content type and format. The response content parts are provided using an instance of the <code>MultipartResponseContent</code> class along with the <code>Encoders.multipart</code> multipart response content encoder (configured on the server or response).</p>
</div>
<div class="paragraph">
<p>The content parts are provided as "field" parts with only a field name and value, or as "file" parts with a field name, content-type, file name and content object. These configurations are made on the <code>MultipartResponseContent</code> object via DSL or functional interface.</p>
</div>
<div class="paragraph">
<p>The part content objects are serialized for data transfer as <code>byte[]</code> content using configured encoders, which are simply instances of
<code>Function&lt;Object,byte[]&gt;</code> used to do the object to byte array conversion. These are configured either on a per-response basis or by sharing a <code>ResponseEncoders</code> instance between multipart configurations - the shared encoders will be used if not explicitly overridden by the multipart response configuration. No part encoders are provided by default.</p>
</div>
<div class="paragraph">
<p>An example multipart response with a field and an image file would be something like:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="groovy"><span class="n">ersatz</span><span class="o">.</span><span class="na">expectations</span> <span class="o">{</span>
    <span class="n">GET</span><span class="o">(</span><span class="s1">'/data'</span><span class="o">)</span> <span class="o">{</span>
        <span class="n">responder</span> <span class="o">{</span>
            <span class="n">encoder</span> <span class="n">ContentType</span><span class="o">.</span><span class="na">MULTIPART_MIXED</span><span class="o">,</span> <span class="n">MultipartResponseContent</span><span class="o">,</span> <span class="n">Encoders</span><span class="o">.</span><span class="na">multipart</span>
            <span class="n">body</span><span class="o">(</span><span class="n">multipart</span> <span class="o">{</span>
                <span class="c1">// configure the part encoders</span>
                <span class="n">encoder</span> <span class="n">TEXT_PLAIN</span><span class="o">,</span> <span class="n">CharSequence</span><span class="o">,</span> <span class="o">{</span> <span class="n">o</span> <span class="o">-&gt;</span> <span class="o">(</span><span class="n">o</span> <span class="k">as</span> <span class="n">String</span><span class="o">).</span><span class="na">bytes</span> <span class="o">}</span>
                <span class="n">encoder</span> <span class="n">IMAGE_JPG</span><span class="o">,</span> <span class="n">File</span><span class="o">,</span> <span class="o">{</span> <span class="n">o</span> <span class="o">-&gt;</span> <span class="o">((</span><span class="n">File</span><span class="o">)</span><span class="n">o</span><span class="o">).</span><span class="na">bytes</span> <span class="o">}</span>

                <span class="c1">// a field part</span>
                <span class="n">field</span> <span class="s1">'comments'</span><span class="o">,</span> <span class="s1">'This is a cool image.'</span>

                <span class="c1">// a file part</span>
                <span class="n">part</span> <span class="s1">'image'</span><span class="o">,</span> <span class="s1">'test-image.jpg'</span><span class="o">,</span> <span class="n">IMAGE_JPG</span><span class="o">,</span> <span class="k">new</span> <span class="n">File</span><span class="o">(</span><span class="s1">'/test-image.jpg'</span><span class="o">),</span> <span class="s1">'base64'</span>
            <span class="o">})</span>
        <span class="o">}</span>
    <span class="o">}</span>
<span class="o">}</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>The resulting response body would look like the following (as a String):</p>
</div>
<div class="listingblock">
<div class="content">
<pre>--WyAJDTEVlYgGjdI13o
Content-Disposition: form-data; name="comments"
Content-Type: text/plain

This is a cool image.
--WyAJDTEVlYgGjdI13o
Content-Disposition: form-data; name="image"; filename="test-image.jpg"
Content-Transfer-Encoding: base64
Content-Type: image/jpeg

... more content follows ...</pre>
</div>
</div>
<div class="paragraph">
<p>which could be decoded in the same manner a multipart <em>request</em> content (an example using the Apache File Upload multipart parser can be found in the unit tests).</p>
</div>
</div>
<div class="sect3">
<h4 id="_request_forwarding">Request Forwarding</h4>
<div class="paragraph">
<p>The <code>forward(String)</code> response configuration method causes the incoming request to be forwarded to another server - the <code>String</code> parameter is the scheme, host, and port of the target server. The response generated by the same incoming request, on that server, is then returned to the original client. As an example:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="java"><span class="n">ersatz</span><span class="o">.</span><span class="na">expectations</span><span class="o">(</span><span class="n">expect</span> <span class="o">-&gt;</span> <span class="o">{</span>
    <span class="n">expect</span><span class="o">.</span><span class="na">GET</span><span class="o">(</span><span class="s">"/api/widgets/list"</span><span class="o">,</span> <span class="n">req</span> <span class="o">-&gt;</span> <span class="o">{</span>
        <span class="n">req</span><span class="o">.</span><span class="na">called</span><span class="o">();</span>
        <span class="n">req</span><span class="o">.</span><span class="na">query</span><span class="o">(</span><span class="s">"partial"</span><span class="o">,</span> <span class="s">"true"</span><span class="o">);</span>
        <span class="n">req</span><span class="o">.</span><span class="na">forward</span><span class="o">(</span><span class="s">"http://somehost:1234"</span><span class="o">);</span>
    <span class="o">});</span>
<span class="o">});</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>This will expect that a GET request to <code>/api/widgets/list?partial=true</code> will be called once, and that its response will be the response from making the same request against <code><a href="http://somehost:1234/api/widgets/list?partial=true" class="bare">http://somehost:1234/api/widgets/list?partial=true</a></code>.</p>
</div>
<div class="paragraph">
<p>This feature allows you to ensure that a request is made, with optional expectations, but that the response comes from the other source.</p>
</div>
<div class="paragraph">
<p>This feature works with both HTTP and HTTPS requests, though the target URI must reflect the desired scheme.</p>
</div>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_proxy_server">Proxy Server</h2>
<div class="sectionbody">
<div class="admonitionblock warning">
<table>
<tr>
<td class="icon">
<div class="title">Warning</div>
</td>
<td class="content">
This functionality has been brought back into the framework, and slightly updated, but it will be removed in a near-future release. The request forwarding functionality should be used instead, as it provides a more flexible and expressive framework.
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>A simple standalone proxy server is available/ The <code>io.github.cjstehno.ersatz.ErsatzProxyServer</code> is useful for testing proxied HTTP connections.
The proxy server has a similar configuration to the <code>ErsatzServer</code> and allows limited expectation configuration; it is expected that more detailed expectation configuration will be done on a standard <code>ErsatzServer</code> instance at the other end of the proxy, something like the following:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="java"><span class="kt">var</span> <span class="n">ersatzServer</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">ErsatzServer</span><span class="o">(</span><span class="n">cfg</span> <span class="o">-&gt;</span> <span class="o">{</span>
    <span class="n">cfg</span><span class="o">.</span><span class="na">expectations</span><span class="o">(</span><span class="n">expect</span> <span class="o">-&gt;</span> <span class="o">{</span>
        <span class="n">expect</span><span class="o">.</span><span class="na">get</span><span class="o">(</span><span class="s">"/"</span><span class="o">).</span><span class="na">called</span><span class="o">(</span><span class="mi">1</span><span class="o">).</span><span class="na">responds</span><span class="o">().</span><span class="na">code</span><span class="o">(</span><span class="mi">200</span><span class="o">).</span><span class="na">content</span><span class="o">(</span><span class="s">"Hello"</span><span class="o">,</span> <span class="no">TEXT_PLAIN</span><span class="o">);</span>
        <span class="n">expect</span><span class="o">.</span><span class="na">get</span><span class="o">(</span><span class="s">"/foo"</span><span class="o">).</span><span class="na">called</span><span class="o">(</span><span class="mi">1</span><span class="o">).</span><span class="na">responds</span><span class="o">().</span><span class="na">code</span><span class="o">(</span><span class="mi">200</span><span class="o">).</span><span class="na">content</span><span class="o">(</span><span class="s">"Foo!"</span><span class="o">,</span> <span class="no">TEXT_PLAIN</span><span class="o">);</span>
    <span class="o">});</span>
<span class="o">});</span>

<span class="kt">var</span> <span class="n">ersatzProxy</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">ErsatzProxyServer</span><span class="o">(</span><span class="n">cfg</span> <span class="o">-&gt;</span> <span class="o">{</span>
    <span class="n">cfg</span><span class="o">.</span><span class="na">target</span><span class="o">(</span><span class="n">ersatzServer</span><span class="o">.</span><span class="na">httpUrl</span><span class="o">);</span>
    <span class="n">cfg</span><span class="o">.</span><span class="na">expectations</span><span class="o">(</span><span class="n">expect</span> <span class="o">-&gt;</span> <span class="o">{</span>
        <span class="n">expect</span><span class="o">.</span><span class="na">get</span><span class="o">(</span><span class="s">"/"</span><span class="o">);</span>
        <span class="n">expect</span><span class="o">.</span><span class="na">get</span><span class="o">(</span><span class="s">"/foo"</span><span class="o">);</span>
    <span class="o">});</span>
<span class="o">});</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Such that, hitting the proxy <code>/foo</code> URL will forward the request to the <code>/foo</code> URL on the server, and likewise it will pass through the response.</p>
</div>
<div class="paragraph">
<p>Notice that the <code>ErsatzProxy</code> has the same lifecycle as the <code>ErsatzServer</code>: you should call the <code>verify()</code> method to ensure that the expected requests were proxied, and the <code>stop()</code> method must be closed once the server is no longer needed.</p>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<div class="title">Note</div>
</td>
<td class="content">
One difference from the <code>ErsatzServer</code> lifecycle is that the proxy server defaults auto-starting, and must be disabled if this is not desired.
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>The requests made to the proxy server are passed through to the <code>targetUri</code> and the response from that server is returned as the response from the proxy server.</p>
</div>
<div class="paragraph">
<p>The proxy server is usable from both Java and Groovy based on the use of Groovy `Closure`s or Java `Consumer`s for configuration.</p>
</div>
<div class="paragraph">
<p>Currently, the proxy server only supports HTTP endpoints (HTTPS <em>may</em> be supported in a future release).</p>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_shadow_jar">Shadow Jar</h2>
<div class="sectionbody">
<div class="paragraph">
<p>The embedded version of Undertow used by Ersatz has caused issues with some server frameworks which also use Undertow (e.g. Grails, and Spring-boot).</p>
</div>
<div class="paragraph">
<p>If you run into errors using the standard jar distribution, please try using the <code>safe</code> distribution, which is a shadowed jar that includes the Undertow library and many of the other dependencies repackaged in the jar. You can use this version in the manner described below for your build system.</p>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<div class="title">Note</div>
</td>
<td class="content">
There are examples of various usage configurations in the <a href="https://github.com/cjstehno/ersatz-usage-tests">Ersatz Usage Tests</a> project.
</td>
</tr>
</table>
</div>
<div class="sect2">
<h3 id="_gradle_2">Gradle</h3>
<div class="paragraph">
<p>A Gradle <code>gradle.build</code> file would have the following defined in the <code>dependencies</code> block:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="groovy"><span class="n">testImplementation</span><span class="o">(</span><span class="s1">'io.github.cjstehno.ersatz:ersatz:3.2.0:safe'</span><span class="o">){</span>
    <span class="n">exclude</span> <span class="nl">group:</span><span class="s1">'io.undertow'</span><span class="o">,</span> <span class="nl">module:</span><span class="s1">'undertow-core'</span>
    <span class="n">exclude</span> <span class="nl">group:</span><span class="s1">'javax.servlet'</span><span class="o">,</span> <span class="nl">module:</span><span class="s1">'javax.servlet-api'</span>
    <span class="n">exclude</span> <span class="nl">group:</span><span class="s1">'commons-fileupload'</span><span class="o">,</span> <span class="nl">module:</span><span class="s1">'commons-fileupload'</span>
<span class="o">}</span>

<span class="c1">// or for the Groovy DSL</span>
<span class="n">testImplementation</span><span class="o">(</span><span class="s1">'io.github.cjstehno.ersatz:ersatz-groovy:3.2.0:safe'</span><span class="o">){</span>
    <span class="n">exclude</span> <span class="nl">group:</span><span class="s1">'io.undertow'</span><span class="o">,</span> <span class="nl">module:</span><span class="s1">'undertow-core'</span>
    <span class="n">exclude</span> <span class="nl">group:</span><span class="s1">'javax.servlet'</span><span class="o">,</span> <span class="nl">module:</span><span class="s1">'javax.servlet-api'</span>
    <span class="n">exclude</span> <span class="nl">group:</span><span class="s1">'commons-fileupload'</span><span class="o">,</span> <span class="nl">module:</span><span class="s1">'commons-fileupload'</span>
<span class="o">}</span>
<span class="n">testImplementation</span> <span class="s1">'org.codehaus.groovy:groovy:3.0.9'</span>
<span class="n">testImplementation</span> <span class="s1">'javax.activation:activation:1.1.1'</span>
<span class="n">testImplementation</span> <span class="s1">'org.hamcrest:hamcrest-library:2.2'</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>The inclusions and exclusions are required to truly isolate and configure the artifact, due to some odd maven publishing requirements.</p>
</div>
</div>
<div class="sect2">
<h3 id="_maven_2">Maven</h3>
<div class="paragraph">
<p>For a Maven <code>pom.xml</code> entry, this would be:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="xml"><span class="nt">&lt;dependency&gt;</span>
    <span class="nt">&lt;groupId&gt;</span>io.github.cjstehno.ersatz<span class="nt">&lt;/groupId&gt;</span>
    <span class="nt">&lt;artifactId&gt;</span>ersatz<span class="nt">&lt;/artifactId&gt;</span>
    <span class="nt">&lt;classifier&gt;</span>safe<span class="nt">&lt;/classifier&gt;</span>
    <span class="nt">&lt;version&gt;</span>3.2.0<span class="nt">&lt;/version&gt;</span>
    <span class="nt">&lt;scope&gt;</span>test<span class="nt">&lt;/scope&gt;</span>
    <span class="nt">&lt;exclusions&gt;</span>
        <span class="nt">&lt;exclusion&gt;</span>
            <span class="nt">&lt;groupId&gt;</span>io.undertow<span class="nt">&lt;/groupId&gt;</span>
            <span class="nt">&lt;artifactId&gt;</span>undertow-core<span class="nt">&lt;/artifactId&gt;</span>
        <span class="nt">&lt;/exclusion&gt;</span>
        <span class="nt">&lt;exclusion&gt;</span>
            <span class="nt">&lt;groupId&gt;</span>javax.servlet<span class="nt">&lt;/groupId&gt;</span>
            <span class="nt">&lt;artifactId&gt;</span>javax.servlet-api<span class="nt">&lt;/artifactId&gt;</span>
        <span class="nt">&lt;/exclusion&gt;</span>
        <span class="nt">&lt;exclusion&gt;</span>
            <span class="nt">&lt;groupId&gt;</span>commons-fileupload<span class="nt">&lt;/groupId&gt;</span>
            <span class="nt">&lt;artifactId&gt;</span>commons-fileupload<span class="nt">&lt;/artifactId&gt;</span>
        <span class="nt">&lt;/exclusion&gt;</span>
    <span class="nt">&lt;/exclusions&gt;</span>
<span class="nt">&lt;/dependency&gt;</span>

<span class="c">&lt;!-- or, for the Groovy DSL --&gt;</span>
<span class="nt">&lt;dependency&gt;</span>
    <span class="nt">&lt;groupId&gt;</span>io.github.cjstehno.ersatz<span class="nt">&lt;/groupId&gt;</span>
    <span class="nt">&lt;artifactId&gt;</span>ersatz-groovy<span class="nt">&lt;/artifactId&gt;</span>
    <span class="nt">&lt;classifier&gt;</span>safe<span class="nt">&lt;/classifier&gt;</span>
    <span class="nt">&lt;version&gt;</span>3.2.0<span class="nt">&lt;/version&gt;</span>
    <span class="nt">&lt;type&gt;</span>jar<span class="nt">&lt;/type&gt;</span>
    <span class="nt">&lt;scope&gt;</span>test<span class="nt">&lt;/scope&gt;</span>
    <span class="nt">&lt;exclusions&gt;</span>
        <span class="nt">&lt;exclusion&gt;</span>
            <span class="nt">&lt;groupId&gt;</span>io.undertow<span class="nt">&lt;/groupId&gt;</span>
            <span class="nt">&lt;artifactId&gt;</span>undertow-core<span class="nt">&lt;/artifactId&gt;</span>
        <span class="nt">&lt;/exclusion&gt;</span>
        <span class="nt">&lt;exclusion&gt;</span>
            <span class="nt">&lt;groupId&gt;</span>javax.servlet<span class="nt">&lt;/groupId&gt;</span>
            <span class="nt">&lt;artifactId&gt;</span>javax.servlet-api<span class="nt">&lt;/artifactId&gt;</span>
        <span class="nt">&lt;/exclusion&gt;</span>
        <span class="nt">&lt;exclusion&gt;</span>
            <span class="nt">&lt;groupId&gt;</span>commons-fileupload<span class="nt">&lt;/groupId&gt;</span>
            <span class="nt">&lt;artifactId&gt;</span>commons-fileupload<span class="nt">&lt;/artifactId&gt;</span>
        <span class="nt">&lt;/exclusion&gt;</span>
    <span class="nt">&lt;/exclusions&gt;</span>
<span class="nt">&lt;/dependency&gt;</span>
<span class="nt">&lt;dependency&gt;</span>
    <span class="nt">&lt;groupId&gt;</span>org.codehaus.groovy<span class="nt">&lt;/groupId&gt;</span>
    <span class="nt">&lt;artifactId&gt;</span>groovy<span class="nt">&lt;/artifactId&gt;</span>
    <span class="nt">&lt;version&gt;</span>3.0.9<span class="nt">&lt;/version&gt;</span>
    <span class="nt">&lt;scope&gt;</span>test<span class="nt">&lt;/scope&gt;</span>
<span class="nt">&lt;/dependency&gt;</span>
<span class="nt">&lt;dependency&gt;</span>
    <span class="nt">&lt;groupId&gt;</span>javax.activation<span class="nt">&lt;/groupId&gt;</span>
    <span class="nt">&lt;artifactId&gt;</span>activation<span class="nt">&lt;/artifactId&gt;</span>
    <span class="nt">&lt;version&gt;</span>1.1.1<span class="nt">&lt;/version&gt;</span>
    <span class="nt">&lt;scope&gt;</span>test<span class="nt">&lt;/scope&gt;</span>
<span class="nt">&lt;/dependency&gt;</span>
<span class="nt">&lt;dependency&gt;</span>
    <span class="nt">&lt;groupId&gt;</span>org.hamcrest<span class="nt">&lt;/groupId&gt;</span>
    <span class="nt">&lt;artifactId&gt;</span>hamcrest-library<span class="nt">&lt;/artifactId&gt;</span>
    <span class="nt">&lt;version&gt;</span>2.2<span class="nt">&lt;/version&gt;</span>
    <span class="nt">&lt;scope&gt;</span>test<span class="nt">&lt;/scope&gt;</span>
<span class="nt">&lt;/dependency&gt;</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>The inclusions and exclusions are required to truly isolate and configure the artifact, due to some odd maven publishing requirements.</p>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_common_usage_examples">Common Usage Examples</h2>
<div class="sectionbody">
<div class="paragraph">
<p>This section contains some recipe-style usage examples.</p>
</div>
<div class="sect2">
<h3 id="_url_encoded_form_requests">Url-Encoded Form Requests</h3>
<div class="paragraph">
<p>Url-encoded form requests are supported by default when the request content-type is specified as <code>application/x-www-form-urlencoded</code>. The request <code>body</code> expectation configuration will expect a <code>Map&lt;String,String&gt;</code> equivalent to the name-value pairs specified in the request body content. An example would be:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="java"><span class="n">server</span><span class="o">.</span><span class="na">expectations</span><span class="o">(</span><span class="n">expect</span> <span class="o">-&gt;</span> <span class="o">{</span>
    <span class="n">expect</span><span class="o">.</span><span class="na">POST</span><span class="o">(</span><span class="s">"/form"</span><span class="o">,</span> <span class="n">req</span> <span class="o">-&gt;</span> <span class="o">{</span>
        <span class="n">req</span><span class="o">.</span><span class="na">body</span><span class="o">(</span><span class="nc">Map</span><span class="o">.</span><span class="na">of</span><span class="o">(</span>
            <span class="s">"alpha"</span><span class="o">,</span> <span class="s">"some data"</span><span class="o">,</span>
            <span class="s">"bravo"</span><span class="o">,</span> <span class="s">"42"</span>
        <span class="o">),</span> <span class="nc">ContentType</span><span class="o">.</span><span class="na">APPLICATION_URLENCODED</span><span class="o">);</span>
        <span class="n">req</span><span class="o">.</span><span class="na">responder</span><span class="o">(</span><span class="n">res</span> <span class="o">-&gt;</span> <span class="o">{</span>
            <span class="n">res</span><span class="o">.</span><span class="na">body</span><span class="o">(</span><span class="s">"ok"</span><span class="o">);</span>
        <span class="o">});</span>
    <span class="o">});</span>
<span class="o">});</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>where the <code>POST</code> content data would look like:</p>
</div>
<div class="listingblock">
<div class="content">
<pre>alpha=some+data&amp;bravo=42</pre>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_file_upload_post">File Upload (POST)</h3>
<div class="paragraph">
<p>You can set up an expectation for a file upload POST using the <code>multipart</code> support, something like:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="groovy"><span class="kn">import</span> <span class="nn">io.github.cjstehno.erstaz.ErsatzServer</span>
<span class="kn">import</span> <span class="nn">io.github.cjstehno.ersatz.MultipartRequestContent</span>
<span class="kn">import</span> <span class="nn">static</span> <span class="n">io</span><span class="o">.</span><span class="na">github</span><span class="o">.</span><span class="na">cjstehno</span><span class="o">.</span><span class="na">ersatz</span><span class="o">.</span><span class="na">ContentType</span><span class="o">.</span><span class="na">TEXT_PLAIN</span>

<span class="kt">def</span> <span class="n">ersatz</span> <span class="o">=</span> <span class="k">new</span> <span class="n">ErsatzServer</span><span class="o">({</span>
    <span class="n">encoder</span> <span class="n">TEXT_PLAIN</span><span class="o">,</span> <span class="n">File</span><span class="o">,</span> <span class="n">Encoders</span><span class="o">.</span><span class="na">text</span>
<span class="o">})</span>

<span class="kt">def</span> <span class="n">file</span> <span class="o">=</span> <span class="k">new</span> <span class="n">File</span><span class="o">(</span><span class="cm">/* some file */</span><span class="o">)</span>

<span class="n">ersatz</span><span class="o">.</span><span class="na">expectations</span> <span class="o">{</span>
    <span class="n">POST</span><span class="o">(</span><span class="s1">'/upload'</span><span class="o">)</span> <span class="o">{</span>
        <span class="n">decoder</span> <span class="n">TEXT_PLAIN</span><span class="o">,</span> <span class="n">Decoders</span><span class="o">.</span><span class="na">utf8String</span>
        <span class="n">decoder</span> <span class="n">MULTIPART_MIXED</span><span class="o">,</span> <span class="n">Decoders</span><span class="o">.</span><span class="na">multipart</span>

        <span class="n">body</span> <span class="n">MultipartRequestContent</span><span class="o">.</span><span class="na">multipart</span> <span class="o">{</span>
            <span class="n">part</span> <span class="s1">'fileName'</span><span class="o">,</span> <span class="n">file</span><span class="o">.</span><span class="na">name</span>
            <span class="n">part</span> <span class="s1">'file'</span><span class="o">,</span> <span class="n">file</span><span class="o">.</span><span class="na">name</span><span class="o">,</span> <span class="s1">'text/plain; charset=utf-8'</span><span class="o">,</span> <span class="n">file</span><span class="o">.</span><span class="na">text</span>
        <span class="o">},</span> <span class="n">MULTIPART_MIXED</span>

        <span class="n">responder</span> <span class="o">{</span>
            <span class="n">body</span> <span class="s1">'ok'</span>
        <span class="o">}</span>
    <span class="o">}</span>
<span class="o">}</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>This will expect the posting of the given file content to the <code>/upload</code> path of the server.</p>
</div>
</div>
<div class="sect2">
<h3 id="_file_download_get">File Download (GET)</h3>
<div class="paragraph">
<p>Setting up an expectation for a GET request to respond with a file to download can be done as follows:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="groovy"><span class="kn">import</span> <span class="nn">io.github.cjstehno.erstaz.ErsatzServer</span>
<span class="kn">import</span> <span class="nn">static</span> <span class="n">io</span><span class="o">.</span><span class="na">github</span><span class="o">.</span><span class="na">cjstehno</span><span class="o">.</span><span class="na">ersatz</span><span class="o">.</span><span class="na">ContentType</span><span class="o">.</span><span class="na">TEXT_PLAIN</span>

<span class="kt">def</span> <span class="n">ersatz</span> <span class="o">=</span> <span class="k">new</span> <span class="n">ErsatzServer</span><span class="o">({</span>
    <span class="n">encoder</span> <span class="n">TEXT_PLAIN</span><span class="o">,</span> <span class="n">File</span><span class="o">,</span> <span class="n">Encoders</span><span class="o">.</span><span class="na">text</span>
<span class="o">})</span>

<span class="kt">def</span> <span class="n">file</span> <span class="o">=</span> <span class="k">new</span> <span class="n">File</span><span class="o">(</span><span class="cm">/* some file */</span><span class="o">)</span>

<span class="n">ersatz</span><span class="o">.</span><span class="na">expectations</span> <span class="o">{</span>
    <span class="n">GET</span><span class="o">(</span><span class="s1">'/download'</span><span class="o">){</span>
        <span class="n">responder</span> <span class="o">{</span>
            <span class="n">header</span> <span class="s1">'Content-Disposition'</span><span class="o">,</span> <span class="s2">"attachment; filename=\"${file.name}\""</span>
            <span class="n">body</span> <span class="n">file</span><span class="o">,</span> <span class="n">TEXT_PLAIN</span>
        <span class="o">}</span>
    <span class="o">}</span>
<span class="o">}</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>This will respond to the request with file download content.</p>
</div>
</div>
<div class="sect2">
<h3 id="_kotlin_usage">Kotlin Usage</h3>
<div class="paragraph">
<p>You can use the Ersatz Server from the Kotlin programming language just as easily as Java or Groovy:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="kotlin"><span class="kd">val</span> <span class="py">ersatz</span> <span class="p">=</span> <span class="nc">ErsatzServer</span> <span class="p">{</span> <span class="n">config</span> <span class="p">-&gt;</span> <span class="n">config</span><span class="p">.</span><span class="nf">autoStart</span><span class="p">(</span><span class="k">true</span><span class="p">)</span> <span class="p">}</span>

<span class="n">ersatz</span><span class="p">.</span><span class="nf">expectations</span> <span class="p">{</span> <span class="n">expectations</span> <span class="p">-&gt;</span>
    <span class="n">expectations</span><span class="p">.</span><span class="nc">GET</span><span class="p">(</span><span class="s">"/kotlin"</span><span class="p">).</span><span class="nf">called</span><span class="p">(</span><span class="mi">1</span><span class="p">).</span><span class="nf">responder</span> <span class="p">{</span> <span class="n">response</span> <span class="p">-&gt;</span>
        <span class="n">response</span><span class="p">.</span><span class="nf">body</span><span class="p">(</span><span class="s">"Hello Kotlin!"</span><span class="p">,</span> <span class="nc">ContentType</span><span class="p">.</span><span class="nc">TEXT_PLAIN</span><span class="p">).</span><span class="nf">code</span><span class="p">(</span><span class="mi">200</span><span class="p">)</span>
    <span class="p">}</span>
<span class="p">}</span>

<span class="kd">val</span> <span class="py">http</span> <span class="p">=</span> <span class="nc">OkHttpClient</span><span class="p">.</span><span class="nc">Builder</span><span class="p">().</span><span class="nf">build</span><span class="p">()</span>
<span class="kd">val</span> <span class="py">request</span><span class="p">:</span> <span class="n">okhttp3</span><span class="p">.</span><span class="nc">Request</span> <span class="p">=</span> <span class="n">okhttp3</span><span class="p">.</span><span class="nc">Request</span><span class="p">.</span><span class="nc">Builder</span><span class="p">().</span><span class="nf">url</span><span class="p">(</span><span class="s">"${ersatz.httpUrl}/kotlin"</span><span class="p">).</span><span class="nf">build</span><span class="p">()</span>
<span class="nf">println</span><span class="p">(</span> <span class="n">http</span><span class="p">.</span><span class="nf">newCall</span><span class="p">(</span><span class="n">request</span><span class="p">).</span><span class="nf">execute</span><span class="p">().</span><span class="nf">body</span><span class="p">().</span><span class="nf">string</span><span class="p">()</span> <span class="p">)</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>which will print out "Hello Kotlin!" when executed.</p>
</div>
</div>
<div class="sect2">
<h3 id="_matching_xml_body_content">Matching XML Body Content</h3>
<div class="paragraph">
<p>An example of how to use the Hamcrest matchers in a request (in a Groovy test using Spock).</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="groovy"><span class="kn">import</span> <span class="nn">io.github.cjstehno.ersatz.encdec.DecodingContext</span>
<span class="kn">import</span> <span class="nn">io.github.cjstehno.ersatz.ErsatzServer</span>
<span class="kn">import</span> <span class="nn">okhttp3.MediaType</span>
<span class="kn">import</span> <span class="nn">okhttp3.Response</span>
<span class="kn">import</span> <span class="nn">spock.lang.AutoCleanup</span>
<span class="kn">import</span> <span class="nn">spock.lang.Specification</span>

<span class="kn">import</span> <span class="nn">javax.xml.parsers.DocumentBuilderFactory</span>

<span class="kn">import</span> <span class="nn">static</span> <span class="n">io</span><span class="o">.</span><span class="na">github</span><span class="o">.</span><span class="na">cjstehno</span><span class="o">.</span><span class="na">ersatz</span><span class="o">.</span><span class="na">encdec</span><span class="o">.</span><span class="na">ContentType</span><span class="o">.</span><span class="na">TEXT_XML</span>
<span class="kn">import</span> <span class="nn">static</span> <span class="n">io</span><span class="o">.</span><span class="na">github</span><span class="o">.</span><span class="na">cjstehno</span><span class="o">.</span><span class="na">ersatz</span><span class="o">.</span><span class="na">encdec</span><span class="o">.</span><span class="na">Decoders</span><span class="o">.</span><span class="na">utf8String</span>
<span class="kn">import</span> <span class="nn">static</span> <span class="n">io</span><span class="o">.</span><span class="na">github</span><span class="o">.</span><span class="na">cjstehno</span><span class="o">.</span><span class="na">ersatz</span><span class="o">.</span><span class="na">encdec</span><span class="o">.</span><span class="na">Encoders</span><span class="o">.</span><span class="na">text</span>
<span class="kn">import</span> <span class="nn">static</span> <span class="n">okhttp3</span><span class="o">.</span><span class="na">RequestBody</span><span class="o">.</span><span class="na">create</span>
<span class="kn">import</span> <span class="nn">static</span> <span class="n">org</span><span class="o">.</span><span class="na">hamcrest</span><span class="o">.</span><span class="na">CoreMatchers</span><span class="o">.</span><span class="na">equalTo</span>
<span class="kn">import</span> <span class="nn">static</span> <span class="n">org</span><span class="o">.</span><span class="na">hamcrest</span><span class="o">.</span><span class="na">xml</span><span class="o">.</span><span class="na">HasXPath</span><span class="o">.</span><span class="na">hasXPath</span>

<span class="kd">class</span> <span class="nc">BodyContentMatcherSpec</span> <span class="kd">extends</span> <span class="n">Specification</span> <span class="o">{</span>

    <span class="nd">@AutoCleanup</span> <span class="kd">private</span> <span class="kd">final</span> <span class="n">ErsatzServer</span> <span class="n">server</span> <span class="o">=</span> <span class="k">new</span> <span class="n">ErsatzServer</span><span class="o">()</span>
    <span class="kd">private</span> <span class="kd">final</span> <span class="n">HttpClient</span> <span class="n">http</span> <span class="o">=</span> <span class="k">new</span> <span class="n">HttpClient</span><span class="o">()</span>

    <span class="kt">void</span> <span class="s1">'matching part of body content'</span><span class="o">()</span> <span class="o">{</span>
        <span class="nl">setup:</span>
        <span class="n">String</span> <span class="n">requestXml</span> <span class="o">=</span> <span class="s1">'&lt;request&gt;&lt;node foo="bar"/&gt;&lt;/request&gt;'</span>
        <span class="n">String</span> <span class="n">responseXml</span> <span class="o">=</span> <span class="s1">'&lt;response&gt;OK&lt;/response&gt;'</span>

        <span class="n">server</span><span class="o">.</span><span class="na">expectations</span> <span class="o">{</span>
            <span class="n">POST</span><span class="o">(</span><span class="s1">'/posting'</span><span class="o">)</span> <span class="o">{</span>
                <span class="n">decoder</span><span class="o">(</span><span class="s1">'text/xml; charset=utf-8'</span><span class="o">)</span> <span class="o">{</span> <span class="kt">byte</span><span class="o">[]</span> <span class="n">bytes</span><span class="o">,</span> <span class="n">DecodingContext</span> <span class="n">ctx</span> <span class="o">-&gt;</span>
                    <span class="n">DocumentBuilderFactory</span><span class="o">.</span><span class="na">newInstance</span><span class="o">()</span>
                        <span class="o">.</span><span class="na">newDocumentBuilder</span><span class="o">()</span>
                        <span class="o">.</span><span class="na">parse</span><span class="o">(</span><span class="k">new</span> <span class="n">ByteArrayInputStream</span><span class="o">(</span><span class="n">bytes</span><span class="o">))</span>
                <span class="o">}</span>
                <span class="n">body</span><span class="o">(</span>
                    <span class="n">hasXPath</span><span class="o">(</span><span class="s1">'string(//request/node/@foo)'</span><span class="o">,</span> <span class="n">equalTo</span><span class="o">(</span><span class="s1">'bar'</span><span class="o">)),</span>
                    <span class="s1">'text/xml; charset=utf-8'</span>
                <span class="o">)</span>
                <span class="n">called</span> <span class="mi">1</span>
                <span class="n">responder</span> <span class="o">{</span>
                    <span class="n">body</span> <span class="n">responseXml</span><span class="o">,</span> <span class="n">TEXT_XML</span>
                    <span class="n">encoder</span> <span class="n">TEXT_XML</span><span class="o">,</span> <span class="n">String</span><span class="o">,</span> <span class="n">text</span>
                <span class="o">}</span>
            <span class="o">}</span>
        <span class="o">}</span>

        <span class="nl">when:</span>
        <span class="n">Response</span> <span class="n">response</span> <span class="o">=</span> <span class="n">http</span><span class="o">.</span><span class="na">post</span><span class="o">(</span>
            <span class="n">server</span><span class="o">.</span><span class="na">httpUrl</span><span class="o">(</span><span class="s1">'/posting'</span><span class="o">),</span>
            <span class="n">create</span><span class="o">(</span><span class="n">MediaType</span><span class="o">.</span><span class="na">get</span><span class="o">(</span><span class="s1">'text/xml; charset=utf-8'</span><span class="o">),</span> <span class="n">requestXml</span><span class="o">)</span>
        <span class="o">)</span>

        <span class="nl">then:</span>
        <span class="n">response</span><span class="o">.</span><span class="na">body</span><span class="o">().</span><span class="na">string</span><span class="o">()</span> <span class="o">==</span> <span class="n">responseXml</span>

        <span class="nl">when:</span>
        <span class="n">response</span> <span class="o">=</span> <span class="n">http</span><span class="o">.</span><span class="na">post</span><span class="o">(</span>
            <span class="n">server</span><span class="o">.</span><span class="na">httpUrl</span><span class="o">(</span><span class="s1">'/posting'</span><span class="o">),</span>
            <span class="n">create</span><span class="o">(</span>
                <span class="n">MediaType</span><span class="o">.</span><span class="na">get</span><span class="o">(</span><span class="s1">'text/xml; charset=utf-8'</span><span class="o">),</span>
                <span class="s1">'&lt;request&gt;&lt;node foo="blah"/&gt;&lt;/request&gt;'</span>
            <span class="o">)</span>
        <span class="o">)</span>

        <span class="nl">then:</span>
        <span class="n">response</span><span class="o">.</span><span class="na">code</span><span class="o">()</span> <span class="o">==</span> <span class="mi">404</span>

        <span class="nl">and:</span>
        <span class="n">server</span><span class="o">.</span><span class="na">verify</span><span class="o">()</span>
    <span class="o">}</span>
<span class="o">}</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>This test sets up a POST expectation with the XML request body content being used as one of the matching criteria. Hamcrest provides an XPath-based matcher, <code>hasXPath(String, Matcher)</code>, which works well here. A custom XML-decoder was installed to parse the request into the XML document format required by the matcher.</p>
</div>
<div class="paragraph">
<p>The test shows two requests made to the server, one with the expected content and one without - the results verify that only the correct call was actually matched.</p>
</div>
<div class="paragraph">
<p>See the <a href="http://hamcrest.org/JavaHamcrest/">Hamcrest</a> documentation for more details about pre-existing and custom `Matcher`s.</p>
</div>
</div>
<div class="sect2">
<h3 id="_forwarding_to_another_server_for_response">Forwarding to Another Server for Response</h3>
<div class="paragraph">
<p>A test case may arise where you have a real server running, where you want to verify the contents of your request, but then respond with the real server response to that request. The "request forwarding" functionality can do that:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="java"><span class="n">server</span><span class="o">.</span><span class="na">expectations</span><span class="o">(</span><span class="n">expect</span> <span class="o">-&gt;</span> <span class="o">{</span>
    <span class="n">expect</span><span class="o">.</span><span class="na">GET</span><span class="o">(</span><span class="s">"/endpoint/get"</span><span class="o">,</span> <span class="n">req</span> <span class="o">-&gt;</span> <span class="o">{</span>
        <span class="n">req</span><span class="o">.</span><span class="na">secure</span><span class="o">();</span>
        <span class="n">req</span><span class="o">.</span><span class="na">called</span><span class="o">();</span>
        <span class="n">req</span><span class="o">.</span><span class="na">query</span><span class="o">(</span><span class="s">"foo"</span><span class="o">,</span> <span class="s">"bar"</span><span class="o">);</span>
        <span class="n">req</span><span class="o">.</span><span class="na">forward</span><span class="o">(</span><span class="s">"https://someother:9753"</span><span class="o">);</span>
    <span class="o">});</span>
<span class="o">});</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>In this example, a GET request is expected at the <code>/endpoint/get</code> path. It should be an HTTPS request, with the query string <code>foo=bar</code>. The Ersatz server will match the request, and if it matches it will forward the request to the configured server (<code><a href="https://somother:9753/endpoint/get?foo=bar" class="bare">https://somother:9753/endpoint/get?foo=bar</a></code> in this case). The response from that request will be returned as the response from the Ersatz server.</p>
</div>
<div class="paragraph">
<p>With this, you can verify that you sent the expected request, once, and that it retrieves the expected response from the server.</p>
</div>
</div>
<div class="sect2">
<h3 id="_using_test_things_with_ersatz">Using Test-Things with Ersatz</h3>
<div class="paragraph">
<p>In the test <code>io.github.cjstehno.ersatz.examples.ErsatzThingsTest</code> example, you can see how well the <a href="https://cjstehno.github.io/test-things/">Test-Things</a> library integrates with Ersatz (yes, it&#8217;s another project of mine). The example is a bit contrived, but is shows how you can use the <code>SharedRandomExtension</code>, and <code>ResourcesExtension</code> with the <code>ErsatzExtension</code> to simplify random value generation and resource loading.</p>
</div>
<div class="paragraph">
<p>The example configures a GET request that will respond with JPG image content, when a secret header value is matched in the request - the header value is randomly generated. Yes, there are simpler means of generating a single random number, but this is just to show how the randomizers might be useful with Ersatz.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="java"><span class="kn">package</span> <span class="nn">io.github.cjstehno.ersatz.examples</span><span class="o">;</span>

<span class="kn">import</span> <span class="nn">io.github.cjstehno.ersatz.ErsatzServer</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">io.github.cjstehno.ersatz.junit.SharedErsatzServerExtension</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">io.github.cjstehno.ersatz.util.HttpClientExtension</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">io.github.cjstehno.ersatz.util.HttpClientExtension.Client</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">io.github.cjstehno.testthings.junit.Resource</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">io.github.cjstehno.testthings.junit.ResourcesExtension</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">io.github.cjstehno.testthings.junit.SharedRandomExtension</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">lombok.val</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">org.junit.jupiter.api.Test</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">org.junit.jupiter.api.extension.ExtendWith</span><span class="o">;</span>

<span class="kn">import</span> <span class="nn">static</span> <span class="n">io</span><span class="o">.</span><span class="na">github</span><span class="o">.</span><span class="na">cjstehno</span><span class="o">.</span><span class="na">ersatz</span><span class="o">.</span><span class="na">cfg</span><span class="o">.</span><span class="na">ContentType</span><span class="o">.</span><span class="na">IMAGE_JPG</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">static</span> <span class="n">io</span><span class="o">.</span><span class="na">github</span><span class="o">.</span><span class="na">cjstehno</span><span class="o">.</span><span class="na">testthings</span><span class="o">.</span><span class="na">rando</span><span class="o">.</span><span class="na">NumberRandomizers</span><span class="o">.</span><span class="na">aFloat</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">static</span> <span class="n">org</span><span class="o">.</span><span class="na">junit</span><span class="o">.</span><span class="na">jupiter</span><span class="o">.</span><span class="na">api</span><span class="o">.</span><span class="na">Assertions</span><span class="o">.</span><span class="na">assertEquals</span><span class="o">;</span>

<span class="cm">/**
 * A bit of a contrived example to show how you can use the
 * &lt;a href="https://cjstehno.github.io/test-things/"&gt;Test-Things&lt;/a&gt; testing library with Ersatz, also written by me.
 */</span>
<span class="nd">@ExtendWith</span><span class="o">({</span>
    <span class="c1">// provides a means of pinning randomness</span>
    <span class="nc">SharedRandomExtension</span><span class="o">.</span><span class="na">class</span><span class="o">,</span>

    <span class="c1">// provides access to resources</span>
    <span class="nc">ResourcesExtension</span><span class="o">.</span><span class="na">class</span><span class="o">,</span>

    <span class="c1">// provides the server management</span>
    <span class="nc">SharedErsatzServerExtension</span><span class="o">.</span><span class="na">class</span><span class="o">,</span>

    <span class="c1">// provides a pre-wired test client for ersatz (internal only)</span>
    <span class="nc">HttpClientExtension</span><span class="o">.</span><span class="na">class</span>
<span class="o">})</span>
<span class="kd">public</span> <span class="kd">class</span> <span class="nc">ErsatzThingsTest</span> <span class="o">{</span>

    <span class="kd">private</span> <span class="kd">static</span> <span class="kd">final</span> <span class="nc">String</span> <span class="no">SECRET_HEADER</span> <span class="o">=</span> <span class="s">"X-Secret"</span><span class="o">;</span>

    <span class="c1">// loads the image resource as a byte array</span>
    <span class="nd">@Resource</span><span class="o">(</span><span class="s">"/test-image.jpg"</span><span class="o">)</span> <span class="kd">private</span> <span class="kd">static</span> <span class="kt">byte</span><span class="o">[]</span> <span class="no">IMAGE_CONTENT</span><span class="o">;</span>

    <span class="c1">// stores the http client instance</span>
    <span class="kd">private</span> <span class="nc">Client</span> <span class="n">client</span><span class="o">;</span>

    <span class="nd">@Test</span> <span class="kt">void</span> <span class="nf">things</span><span class="o">(</span><span class="kd">final</span> <span class="nc">ErsatzServer</span> <span class="n">ersatz</span><span class="o">)</span> <span class="kd">throws</span> <span class="nc">Exception</span> <span class="o">{</span>
        <span class="c1">// generates a random secret value</span>
        <span class="n">val</span> <span class="n">secret</span> <span class="o">=</span> <span class="n">aFloat</span><span class="o">().</span><span class="na">one</span><span class="o">().</span><span class="na">toString</span><span class="o">();</span>

        <span class="n">ersatz</span><span class="o">.</span><span class="na">expectations</span><span class="o">(</span><span class="n">expect</span> <span class="o">-&gt;</span> <span class="o">{</span>
            <span class="n">expect</span><span class="o">.</span><span class="na">GET</span><span class="o">(</span><span class="s">"/images/42"</span><span class="o">,</span> <span class="n">req</span> <span class="o">-&gt;</span> <span class="o">{</span>
                <span class="n">req</span><span class="o">.</span><span class="na">called</span><span class="o">();</span>
                <span class="n">req</span><span class="o">.</span><span class="na">header</span><span class="o">(</span><span class="no">SECRET_HEADER</span><span class="o">,</span> <span class="n">secret</span><span class="o">);</span>
                <span class="n">req</span><span class="o">.</span><span class="na">responder</span><span class="o">(</span><span class="n">res</span> <span class="o">-&gt;</span> <span class="o">{</span>
                    <span class="n">res</span><span class="o">.</span><span class="na">body</span><span class="o">(</span><span class="no">IMAGE_CONTENT</span><span class="o">,</span> <span class="no">IMAGE_JPG</span><span class="o">);</span>
                    <span class="n">res</span><span class="o">.</span><span class="na">code</span><span class="o">(</span><span class="mi">200</span><span class="o">);</span>
                <span class="o">});</span>
            <span class="o">});</span>
        <span class="o">});</span>

        <span class="c1">// make the request</span>
        <span class="n">val</span> <span class="n">response</span> <span class="o">=</span> <span class="n">client</span><span class="o">.</span><span class="na">get</span><span class="o">(</span><span class="s">"/images/42"</span><span class="o">,</span> <span class="n">builder</span> <span class="o">-&gt;</span> <span class="n">builder</span><span class="o">.</span><span class="na">header</span><span class="o">(</span><span class="no">SECRET_HEADER</span><span class="o">,</span> <span class="n">secret</span><span class="o">));</span>
        <span class="n">assertEquals</span><span class="o">(</span><span class="mi">200</span><span class="o">,</span> <span class="n">response</span><span class="o">.</span><span class="na">code</span><span class="o">());</span>
        <span class="n">assertEquals</span><span class="o">(</span><span class="mi">721501</span><span class="o">,</span> <span class="n">response</span><span class="o">.</span><span class="na">body</span><span class="o">().</span><span class="na">bytes</span><span class="o">().</span><span class="na">length</span><span class="o">);</span>

        <span class="n">ersatz</span><span class="o">.</span><span class="na">assertVerified</span><span class="o">();</span>
    <span class="o">}</span>
<span class="o">}</span></code></pre>
</div>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<div class="title">Note</div>
</td>
<td class="content">
The <code>HttpClientExtension</code> show in the example is an internal client management extension used in testing Ersatz itself, but the general idea is that it provides an HTTP client wired up to the configured Ersatz server. Yes. even my test tools, have test tools.
</td>
</tr>
</table>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_appendices">Appendices</h2>
<div class="sectionbody">
<div class="sect2">
<h3 id="_a_development_philosophy">A. Development Philosophy</h3>
<div class="paragraph">
<p>As this project starts its seventh year (started in December 2016) it&#8217;s doing well, and it is stable, but I have less time to devote to it. I figured it would be a good time to outline my general development philosophy/strategy for the project as it moves forward.</p>
</div>
<div class="paragraph">
<p>The primary goal of the 3.x release was increased simplicity and ease of development. This is why I removed some of the more niche features in favor of keeping it more maintainable. I also removed some automated development tools (e.g. Coveralls and Travis). There is some maintenance effort involved in keeping them current, and I am a one-developer team - the information provided by these tools can easily be discovered by building the project (and will be published with the releases).</p>
</div>
<div class="paragraph">
<p>Being that this is a project used in writing unit tests, I don&#8217;t generally feel the need for strict backwards compatability as long as there is a simple upgrade path. That being said, if some change causes a major problem, I am not against cutting a new release with changes that make the transition easier.</p>
</div>
<div class="paragraph">
<p>The audience for this project is very small and there are very few bugs and feature requests, so if that continues, I will plan on putting out a new release once a year to keep up with current JDK and dependency versions.</p>
</div>
</div>
<div class="sect2">
<h3 id="_b_license">B. License</h3>
<div class="paragraph">
<p>This project is licensed under the <a href="https://www.apache.org/licenses/LICENSE-2.0">Apache 2.0 License</a>.</p>
</div>
<div class="listingblock">
<div class="content">
<pre>Copyright (C) 2023 Christopher J. Stehno

Licensed under the Apache License, Version 2.0 (the "License");
you may not use this file except in compliance with the License.
You may obtain a copy of the License at

        http://www.apache.org/licenses/LICENSE-2.0

Unless required by applicable law or agreed to in writing, software
distributed under the License is distributed on an "AS IS" BASIS,
WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
See the License for the specific language governing permissions and
limitations under the License.</pre>
</div>
</div>
</div>
</div>
</div>
</div>
<div id="footer">
<div id="footer-text">
Version 3.2.0<br>
Last updated 2023-04-25 04:05:12 -0500
</div>
</div>
<style>
pre.rouge table td { padding: 5px; }
pre.rouge table pre { margin: 0; }
pre.rouge .cm {
  color: #999988;
  font-style: italic;
}
pre.rouge .cp {
  color: #999999;
  font-weight: bold;
}
pre.rouge .c1 {
  color: #999988;
  font-style: italic;
}
pre.rouge .cs {
  color: #999999;
  font-weight: bold;
  font-style: italic;
}
pre.rouge .c, pre.rouge .ch, pre.rouge .cd, pre.rouge .cpf {
  color: #999988;
  font-style: italic;
}
pre.rouge .err {
  color: #a61717;
  background-color: #e3d2d2;
}
pre.rouge .gd {
  color: #000000;
  background-color: #ffdddd;
}
pre.rouge .ge {
  color: #000000;
  font-style: italic;
}
pre.rouge .gr {
  color: #aa0000;
}
pre.rouge .gh {
  color: #999999;
}
pre.rouge .gi {
  color: #000000;
  background-color: #ddffdd;
}
pre.rouge .go {
  color: #888888;
}
pre.rouge .gp {
  color: #555555;
}
pre.rouge .gs {
  font-weight: bold;
}
pre.rouge .gu {
  color: #aaaaaa;
}
pre.rouge .gt {
  color: #aa0000;
}
pre.rouge .kc {
  color: #000000;
  font-weight: bold;
}
pre.rouge .kd {
  color: #000000;
  font-weight: bold;
}
pre.rouge .kn {
  color: #000000;
  font-weight: bold;
}
pre.rouge .kp {
  color: #000000;
  font-weight: bold;
}
pre.rouge .kr {
  color: #000000;
  font-weight: bold;
}
pre.rouge .kt {
  color: #445588;
  font-weight: bold;
}
pre.rouge .k, pre.rouge .kv {
  color: #000000;
  font-weight: bold;
}
pre.rouge .mf {
  color: #009999;
}
pre.rouge .mh {
  color: #009999;
}
pre.rouge .il {
  color: #009999;
}
pre.rouge .mi {
  color: #009999;
}
pre.rouge .mo {
  color: #009999;
}
pre.rouge .m, pre.rouge .mb, pre.rouge .mx {
  color: #009999;
}
pre.rouge .sb {
  color: #d14;
}
pre.rouge .sc {
  color: #d14;
}
pre.rouge .sd {
  color: #d14;
}
pre.rouge .s2 {
  color: #d14;
}
pre.rouge .se {
  color: #d14;
}
pre.rouge .sh {
  color: #d14;
}
pre.rouge .si {
  color: #d14;
}
pre.rouge .sx {
  color: #d14;
}
pre.rouge .sr {
  color: #009926;
}
pre.rouge .s1 {
  color: #d14;
}
pre.rouge .ss {
  color: #990073;
}
pre.rouge .s, pre.rouge .sa, pre.rouge .dl {
  color: #d14;
}
pre.rouge .na {
  color: #008080;
}
pre.rouge .bp {
  color: #999999;
}
pre.rouge .nb {
  color: #0086B3;
}
pre.rouge .nc {
  color: #445588;
  font-weight: bold;
}
pre.rouge .no {
  color: #008080;
}
pre.rouge .nd {
  color: #3c5d5d;
  font-weight: bold;
}
pre.rouge .ni {
  color: #800080;
}
pre.rouge .ne {
  color: #990000;
  font-weight: bold;
}
pre.rouge .nf, pre.rouge .fm {
  color: #990000;
  font-weight: bold;
}
pre.rouge .nl {
  color: #990000;
  font-weight: bold;
}
pre.rouge .nn {
  color: #555555;
}
pre.rouge .nt {
  color: #000080;
}
pre.rouge .vc {
  color: #008080;
}
pre.rouge .vg {
  color: #008080;
}
pre.rouge .vi {
  color: #008080;
}
pre.rouge .nv, pre.rouge .vm {
  color: #008080;
}
pre.rouge .ow {
  color: #000000;
  font-weight: bold;
}
pre.rouge .o {
  color: #000000;
  font-weight: bold;
}
pre.rouge .w {
  color: #bbbbbb;
}
pre.rouge {
  background-color: #f8f8f8;
}
</style>
</body>
</html>